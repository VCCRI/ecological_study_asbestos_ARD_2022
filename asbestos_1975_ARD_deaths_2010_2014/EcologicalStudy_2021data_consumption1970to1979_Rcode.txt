
options(width=250)
options(max.print=10000)
options(stringsAsFactors = FALSE)
options(scipen=10000)
library(data.table)
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(sqldf)
library(reshape2)
library(scales)
library(plotly)

#load("EcologicalStudy_2021data_consumption1970to1979.RData")
#save.image(file="EcologicalStudy_2021data_consumption1970to1979.RData")


##### Output file

outfile_stats = "EcologicalStudy_2021data_asb1970to1979_output.txt"

header = "model_disease\tmodel_gender\tyears_of_deaths\tyears_of_asbestos\tnum_points\tcountries_included\tintercept\tBO_CI1\tBO_CI2\tB0_SE\tB0_p_value\tslope\tB1_CI1\tB1_CI2\tB1_SE\tB1_p_value\tadjusted_R_squared\tp_value"
write(header, file=outfile_stats, append=FALSE)


##### Countries from 2007 paper that various analysis will be restricted to

paper2007_countries_for_C45_males    = c("ARG", "AUS", "AUT", "BRA", "CAN", "CHL", "CRI", "DEU", "DNK", "ESP", "FIN", "FRA", "GBR", "HKG", "HUN", "ISL", "ISR", "JPN", "KOR", "MEX", "NIC", "NLD", "NOR", "NZL", "PAN", "PER", "POL", "PRT", "SWE", "URY", "USA", "VEN")
paper2007_countries_for_C45_females  = c("ARG", "AUS", "AUT", "BRA", "CAN", "CHL", "CRI", "DEU", "DNK", "ESP", "FIN", "FRA", "GBR", "HKG", "HUN", "ISL", "ISR", "JPN", "KOR", "MEX", "NLD", "NOR", "NZL", "PAN", "PER", "POL", "PRT", "SWE", "URY", "USA", "VEN")
paper2007_countries_for_C450_males   = c("ARG", "AUS", "AUT", "BRA", "CAN", "CHL", "CRI", "DEU", "DNK", "ESP", "FIN", "FRA", "GBR", "HKG", "HUN", "ISL", "ISR", "JPN", "MEX", "NLD", "NOR", "NZL", "PER", "POL", "PRT", "SWE", "URY", "USA", "VEN")
paper2007_countries_for_C450_females = c("ARG", "AUS", "AUT", "BRA", "CAN", "CHL", "DEU", "DNK", "ESP", "FIN", "FRA", "GBR", "HKG", "HUN", "ISR", "JPN", "MEX", "NLD", "NOR", "NZL", "PER", "POL", "PRT", "SWE", "USA")
paper2007_countries_for_C451_males   = c("ARG", "AUS", "AUT", "BRA", "CAN", "CHL", "DEU", "DNK", "ESP", "FIN", "FRA", "GBR", "HKG", "HUN", "ISR", "JPN", "MEX", "NLD", "NOR", "NZL", "POL", "PRT", "SWE", "USA", "VEN")
paper2007_countries_for_C451_females = c("ARG", "AUS", "AUT", "BRA", "CAN", "CHL", "CRI", "DEU", "DNK", "ESP", "FIN", "FRA", "GBR", "HKG", "HUN", "ISL", "ISR", "JPN", "MEX", "NLD", "NOR", "PAN", "POL", "PRT", "SWE", "USA", "VEN")
paper2007_countries_for_J61_males    = c("ARG", "AUS", "AUT", "BRA", "CAN", "CHL", "DEU", "DNK", "EGY", "ESP", "FIN", "FRA", "GBR", "HKG", "HUN", "ISR", "JPN", "KOR", "MEX", "NLD", "NOR", "NZL", "POL", "PRT", "SWE", "USA", "VEN")
paper2007_countries_for_J61_females  = c("ARG", "AUS", "AUT", "BRA", "CAN", "CHL", "DEU", "EGY", "ESP", "FIN", "FRA", "GBR", "HKG", "JPN", "NZL", "POL", "SWE", "USA", "VEN")

length(paper2007_countries_for_C45_males) # 32
length(paper2007_countries_for_C45_females) # 31
length(paper2007_countries_for_C450_males) # 29
length(paper2007_countries_for_C450_females) # 25
length(paper2007_countries_for_C451_males) # 25
length(paper2007_countries_for_C451_females) # 27
length(paper2007_countries_for_J61_males) # 27
length(paper2007_countries_for_J61_females) # 19


##### World Health Organisation (WHO) mortality
##### https://www.who.int/data/data-collection-tools/who-mortality-database
##### morticd10_part1.zip, morticd10_part2.zip, morticd10_part3.zip, morticd10_part4.zip, morticd10_part5.zip
##### Data file containing the detailed mortality data for the tenth revision of the ICD (International Classification of Diseases).
##### mort_country_codes.zip Country codes and names.

country_codes = read.table( "country_codes.txt", sep=",", header=TRUE, quote='"', comment.char="", row.names=NULL, stringsAsFactors=FALSE, colClasses=c("character") )
colnames(country_codes) = c("Country", "Country_Name")
country_codes$Country = as.character(country_codes$Country)
country_codes$Country_Name = as.character(country_codes$Country_Name)

country_codes_3char = read.table( "ISO_3166_country_codes.csv", sep=",", header=TRUE, quote='"', comment.char="", row.names=NULL, stringsAsFactors=FALSE, colClasses=c("character") )
colnames(country_codes_3char) = c("Country_Name", "Country_3char")
country_codes$Country_Name[(!(country_codes$Country_Name %in% country_codes_3char$Country_Name))]
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Cabo Verde"), "Cape Verde", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Central African Republic (the)"), "Central African Republic", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Comoros (the)"), "Comoros", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Congo (the)"), "Congo", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Côte d'Ivoire"), "Cote d'Ivoire", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Gambia (the)"), "Gambia", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Libya"), "Libyan Arab Jamahiriya", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Niger (the)"), "Niger", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Réunion"), "Reunion", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Sudan (the)"), "Sudan", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Tanzania, United Republic of"), "United Republic of Tanzania", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Congo (the Democratic Republic of the)"), "Democratic Republic of the Congo", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Bahamas (the)"), "Bahamas", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Bolivia (Plurinational State of)"), "Bolivia", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Virgin Islands (British)"), "British Virgin Islands", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Cayman Islands (the)"), "Cayman Islands", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Dominican Republic (the)"), "Dominican Republic", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Falkland Islands (the) [Malvinas]"), "Falkland Islands (Malvinas)", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Saint Vincent and the Grenadines"), "Saint Vincent and Grenadines", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Turks and Caicos Islands (the)"), "Turks and Caicos Islands", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="United States of America (the)"), "United States of America", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Virgin Islands (U.S.)"), "Virgin Islands (USA)", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Venezuela (Bolivarian Republic of)"), "Venezuela", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Taiwan (Province of China)"), "China: Province of Taiwan only", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Korea (the Democratic People's Republic of)"), "Democratic Peoples's Republic of Korea", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Hong Kong"), "Hong Kong SAR", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Lao People's Democratic Republic (the)"), "Lao People's Democratic Republic", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Macao"), "Macau", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Palestine, State of"), "Occupied Palestinian Territory", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Philippines (the)"), "Philippines", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Korea (the Republic of)"), "Republic of Korea", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="United Arab Emirates (the)"), "United Arab Emirates", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Czechia"), "Czech Republic", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Republic of North Macedonia"), "North Macedonia", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Netherlands (the)"), "Netherlands", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Moldova (the Republic of)"), "Republic of Moldova", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Russian Federation (the)"), "Russian Federation", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="United Kingdom of Great Britain and Northern Ireland (the)"), "United Kingdom", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Cook Islands (the)"), "Cook Islands", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Marshall Islands (the)"), "Marshall Islands", country_codes_3char$Country_Name )
country_codes_3char$Country_Name = ifelse( (country_codes_3char$Country_Name=="Curaçao"), "Netherlands Antilles", country_codes_3char$Country_Name )
country_codes$Country_Name[(!(country_codes$Country_Name %in% country_codes_3char$Country_Name))]

Morticd10_part1 = read.table( "Morticd10_part1.txt", sep=",", header=TRUE, quote='"', comment.char="", row.names=NULL, stringsAsFactors=FALSE, colClasses=c("character") )
Morticd10_part2 = read.table( "Morticd10_part2.txt", sep=",", header=TRUE, quote='"', comment.char="", row.names=NULL, stringsAsFactors=FALSE, colClasses=c("character") )
Morticd10_part3 = read.table( "Morticd10_part3.txt", sep=",", header=TRUE, quote='"', comment.char="", row.names=NULL, stringsAsFactors=FALSE, colClasses=c("character") )
Morticd10_part4 = read.table( "Morticd10_part4.txt", sep=",", header=TRUE, quote='"', comment.char="", row.names=NULL, stringsAsFactors=FALSE, colClasses=c("character") )
Morticd10_part5 = read.table( "Morticd10_part5.txt", sep=",", header=TRUE, quote='"', comment.char="", row.names=NULL, stringsAsFactors=FALSE, colClasses=c("character") )
Morticd10_part1$Cause = as.character(Morticd10_part1$Cause)
Morticd10_part2$Cause = as.character(Morticd10_part2$Cause)
Morticd10_part3$Cause = as.character(Morticd10_part3$Cause)
Morticd10_part4$Cause = as.character(Morticd10_part4$Cause)
Morticd10_part5$Cause = as.character(Morticd10_part5$Cause)
Morticd10_part1$icd10_3digit_code = substr(Morticd10_part1$Cause, 1, 3)
Morticd10_part2$icd10_3digit_code = substr(Morticd10_part2$Cause, 1, 3)
Morticd10_part3$icd10_3digit_code = substr(Morticd10_part3$Cause, 1, 3)
Morticd10_part4$icd10_3digit_code = substr(Morticd10_part4$Cause, 1, 3)
Morticd10_part5$icd10_3digit_code = substr(Morticd10_part5$Cause, 1, 3)
mort1 = Morticd10_part1[(Morticd10_part1$icd10_3digit_code %in% c("C45","J61")),]
mort2 = Morticd10_part2[(Morticd10_part2$icd10_3digit_code %in% c("C45","J61")),]
mort3 = Morticd10_part3[(Morticd10_part3$icd10_3digit_code %in% c("C45","J61")),]
mort4 = Morticd10_part4[(Morticd10_part4$icd10_3digit_code %in% c("C45","J61")),]
mort5 = Morticd10_part5[(Morticd10_part5$icd10_3digit_code %in% c("C45","J61")),]
mort = rbind(mort1, mort2, mort3, mort4, mort5)
rm(Morticd10_part1, Morticd10_part2, Morticd10_part3, Morticd10_part4, Morticd10_part5)
rm(mort1, mort2, mort3, mort4, mort5)

mort$Country = as.character(mort$Country)
mort2 = merge( x=mort, y=country_codes, by=c("Country"), all.x=TRUE, all.y=FALSE )
mort = mort2
rm(mort2)

mort$Admin1 = as.character(mort$Admin1)
mort$SubDiv = as.character(mort$SubDiv)
mort$Frmat = as.character(mort$Frmat)
mort$Year = as.numeric(as.character(mort$Year))
mort$Sex = as.numeric(as.character(mort$Sex))
for (i in 1:length(colnames(mort))) {
  col = colnames(mort)[i]
  if ((col %like% "^Deaths") | (col %like% "IM_Deaths")) {
    mort[,i] = as.numeric(as.character(mort[,i]))
  }
}

names(mort)[names(mort)=="Deaths1"] = "deaths_all"
names(mort)[names(mort)=="Deaths2"] = "deaths_0"
names(mort)[names(mort)=="Deaths3"] = "deaths_1"
names(mort)[names(mort)=="Deaths4"] = "deaths_2"
names(mort)[names(mort)=="Deaths5"] = "deaths_3"
names(mort)[names(mort)=="Deaths6"] = "deaths_4"
names(mort)[names(mort)=="Deaths7"] = "deaths_5_9"
names(mort)[names(mort)=="Deaths8"] = "deaths_10_14"
names(mort)[names(mort)=="Deaths9"] = "deaths_15_19"
names(mort)[names(mort)=="Deaths10"] = "deaths_20_24"
names(mort)[names(mort)=="Deaths11"] = "deaths_25_29"
names(mort)[names(mort)=="Deaths12"] = "deaths_30_34"
names(mort)[names(mort)=="Deaths13"] = "deaths_35_39"
names(mort)[names(mort)=="Deaths14"] = "deaths_40_44"
names(mort)[names(mort)=="Deaths15"] = "deaths_45_49"
names(mort)[names(mort)=="Deaths16"] = "deaths_50_54"
names(mort)[names(mort)=="Deaths17"] = "deaths_55_59"
names(mort)[names(mort)=="Deaths18"] = "deaths_60_64"
names(mort)[names(mort)=="Deaths19"] = "deaths_65_69"
names(mort)[names(mort)=="Deaths20"] = "deaths_70_74"
names(mort)[names(mort)=="Deaths21"] = "deaths_75_79"
names(mort)[names(mort)=="Deaths22"] = "deaths_80_84"
names(mort)[names(mort)=="Deaths23"] = "deaths_85_89"
names(mort)[names(mort)=="Deaths24"] = "deaths_90_94"
names(mort)[names(mort)=="Deaths25"] = "deaths_95_and_above"
names(mort)[names(mort)=="Deaths26"] = "deaths_age_unspecified"
names(mort)[names(mort)=="IM_deaths1"] = "infant_deaths_0_days"
names(mort)[names(mort)=="IM_deaths2"] = "deaths_1_6_days"
names(mort)[names(mort)=="IM_deaths3"] = "deaths_7_27_days"
names(mort)[names(mort)=="IM_deaths4"] = "deaths_28_364_days"

# C45 Mesothelioma
# C45.0 Mesothelioma of pleura
# C45.1 Mesothelioma of peritoneum
# C45.2 Mesothelioma of pericardium
# C45.7 Mesothelioma of other sites
# C45.9 Mesothelioma, unspecified
# J61 pneumoconiosis due to asbestos and other mineral fibers


##### United Nations (UN) world population
##### Total Population - Both Sexes. De facto population in a country, area or region as of 1 July of the year indicated. Figures are presented in thousands.
##### https://population.un.org/wpp/Download/Standard/Population/WPP2019_POP_F01_1_TOTAL_POPULATION_BOTH_SEXES.xlsx

pop_total = read.table( "WPP2019_POP_F01_1_TOTAL_POPULATION_BOTH_SEXES.csv", sep=",", header=TRUE, quote='"', comment.char="", row.names=NULL, stringsAsFactors=FALSE, colClasses=c("character") )

pop2 = melt(pop_total, id.vars=c("Index", "Variant", "Region..subregion..country.or.area..", "Notes", "Country.code", "Type", "Parent.code"))
names(pop2)[names(pop2)=="Region..subregion..country.or.area.."] = "Country_Name"
names(pop2)[names(pop2)=="variable"] = "Year"
names(pop2)[names(pop2)=="value"] = "population"
pop3 = pop2[(pop2$Type=="Country/Area"), c("Country_Name", "Year", "population")]
pop3$Year = gsub("X", "", pop3$Year)
pop3$population = gsub(" ", "", pop3$population)
pop3$Year = as.numeric(as.character(pop3$Year))
pop3$population = as.numeric(as.character(pop3$population))
pop3$population = pop3$population * 1000

country_codes$Country_Name[(!(country_codes$Country_Name %in% pop3$Country_Name))]
pop3$Country_Name = ifelse( (pop3$Country_Name=="Cabo Verde"), "Cape Verde", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="Côte d'Ivoire"), "Cote d'Ivoire", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="Libya"), "Libyan Arab Jamahiriya", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="Réunion"), "Reunion", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="Bolivia (Plurinational State of)"), "Bolivia", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="Saint Vincent and the Grenadines"), "Saint Vincent and Grenadines", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="United States Virgin Islands"), "Virgin Islands (USA)", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="Venezuela (Bolivarian Republic of)"), "Venezuela", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="China, Taiwan Province of China"), "China: Province of Taiwan only", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="Dem. People's Republic of Korea"), "Democratic Peoples's Republic of Korea", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="China, Hong Kong SAR"), "Hong Kong SAR", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="China, Macao SAR"), "Macau", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="State of Palestine"), "Occupied Palestinian Territory", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="Czechia"), "Czech Republic", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="Micronesia (Fed. States of)"), "Micronesia (Federated States of)", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="Curaçao"), "Netherlands Antilles", pop3$Country_Name)
country_codes$Country_Name[(!(country_codes$Country_Name %in% pop3$Country_Name))]

pop_total = pop3
rm(pop2, pop3)


#####
pop_1975 = pop_total[(pop_total$Year==1975),]

pop_1975_USSR = pop_total[((pop_total$Country_Name %in% c("Russian Federation", "Kazakhstan", "Ukraine", "Azerbaijan", "Estonia", "Kyrgyzstan", "Latvia", "Lithuania", "Republic of Moldova", "Tajikistan", "Uzbekistan")) & (pop_total$Year==1975)),]
pop_1975_USSR_sum = sum(pop_1975_USSR$population)
pop_1975_USSR$pop_fraction = pop_1975_USSR$population / pop_1975_USSR_sum
pop_1975_USSR
#            Country_Name Year population pop_fraction
#7317          Azerbaijan 1975    5674000  0.024263002
#7336          Kazakhstan 1975   14050000  0.060080221
#7337          Kyrgyzstan 1975    3291000  0.014072883
#7338          Tajikistan 1975    3391000  0.014500500
#7340          Uzbekistan 1975   13857000  0.059254920
#7463 Republic of Moldova 1975    3840000  0.016420502
#7465  Russian Federation 1975  133805000  0.572173236
#7467             Ukraine 1975   48756000  0.208489057
#7471             Estonia 1975    1422000  0.006080717
#7477              Latvia 1975    2469000  0.010557869
#7478           Lithuania 1975    3299000  0.014107092

pop_1975_Yugoslavia = pop_total[((pop_total$Country_Name %in% c("Bosnia and Herzegovina", "Croatia", "Serbia", "Slovenia", "North Macedonia", "Montenegro")) & (pop_total$Year==1975)),]
pop_1975_Yugoslavia_sum = sum(pop_1975_Yugoslavia$population)
pop_1975_Yugoslavia$pop_fraction = pop_1975_Yugoslavia$population / pop_1975_Yugoslavia_sum
pop_1975_Yugoslavia
#               Country_Name Year population pop_fraction
#7485 Bosnia and Herzegovina 1975    3985000   0.18901485
#7486                Croatia 1975    4501000   0.21348954
#7492             Montenegro 1975     554000   0.02627710
#7493        North Macedonia 1975    1803000   0.08551914
#7496                 Serbia 1975    8497000   0.40302613
#7497               Slovenia 1975    1743000   0.08267324     
                   
pop_1975_Czechoslovakia = pop_total[((pop_total$Country_Name %in% c("Czech Republic", "Slovakia")) & (pop_total$Year==1975)),]
pop_1975_Czechoslovakia_sum = sum(pop_1975_Czechoslovakia$population)
pop_1975_Czechoslovakia$pop_fraction = pop_1975_Czechoslovakia$population / pop_1975_Czechoslovakia_sum
pop_1975_Czechoslovakia
#       Country_Name Year population pop_fraction
#7460 Czech Republic 1975   10070000    0.6793497
#7466       Slovakia 1975    4753000    0.3206503

pop_1975_Belgium_and_Luxembourg = pop_total[((pop_total$Country_Name %in% c("Belgium", "Luxembourg")) & (pop_total$Year==1975)),]
pop_1975_Belgium_and_Luxembourg_sum = sum(pop_1975_Belgium_and_Luxembourg$population)
pop_1975_Belgium_and_Luxembourg$pop_fraction = pop_1975_Belgium_and_Luxembourg$population / pop_1975_Belgium_and_Luxembourg_sum
pop_1975_Belgium_and_Luxembourg
#     Country_Name Year population pop_fraction
#7501      Belgium 1975    9772000   0.96504049
#7505   Luxembourg 1975     354000   0.03495951


#####
pop_1970 = pop_total[(pop_total$Year==1970),]

pop_1970_USSR = pop_total[((pop_total$Country_Name %in% c("Russian Federation", "Kazakhstan", "Ukraine", "Azerbaijan", "Estonia", "Kyrgyzstan", "Latvia", "Lithuania", "Republic of Moldova", "Tajikistan", "Uzbekistan")) & (pop_total$Year==1970)),]
pop_1970_USSR_sum = sum(pop_1970_USSR$population)
pop_1970_USSR$pop_fraction = pop_1970_USSR$population / pop_1970_USSR_sum
pop_1970_USSR

pop_1970_Yugoslavia = pop_total[((pop_total$Country_Name %in% c("Bosnia and Herzegovina", "Croatia", "Serbia", "Slovenia", "North Macedonia", "Montenegro")) & (pop_total$Year==1970)),]
pop_1970_Yugoslavia_sum = sum(pop_1970_Yugoslavia$population)
pop_1970_Yugoslavia$pop_fraction = pop_1970_Yugoslavia$population / pop_1970_Yugoslavia_sum
pop_1970_Yugoslavia

pop_1970_Czechoslovakia = pop_total[((pop_total$Country_Name %in% c("Czech Republic", "Slovakia")) & (pop_total$Year==1970)),]
pop_1970_Czechoslovakia_sum = sum(pop_1970_Czechoslovakia$population)
pop_1970_Czechoslovakia$pop_fraction = pop_1970_Czechoslovakia$population / pop_1970_Czechoslovakia_sum
pop_1970_Czechoslovakia

pop_1970_Belgium_and_Luxembourg = pop_total[((pop_total$Country_Name %in% c("Belgium", "Luxembourg")) & (pop_total$Year==1970)),]
pop_1970_Belgium_and_Luxembourg_sum = sum(pop_1970_Belgium_and_Luxembourg$population)
pop_1970_Belgium_and_Luxembourg$pop_fraction = pop_1970_Belgium_and_Luxembourg$population / pop_1970_Belgium_and_Luxembourg_sum
pop_1970_Belgium_and_Luxembourg


#####
pop_1980 = pop_total[(pop_total$Year==1980),]

pop_1980_USSR = pop_total[((pop_total$Country_Name %in% c("Russian Federation", "Kazakhstan", "Ukraine", "Azerbaijan", "Estonia", "Kyrgyzstan", "Latvia", "Lithuania", "Republic of Moldova", "Tajikistan", "Uzbekistan")) & (pop_total$Year==1980)),]
pop_1980_USSR_sum = sum(pop_1980_USSR$population)
pop_1980_USSR$pop_fraction = pop_1980_USSR$population / pop_1980_USSR_sum
pop_1980_USSR

pop_1980_Yugoslavia = pop_total[((pop_total$Country_Name %in% c("Bosnia and Herzegovina", "Croatia", "Serbia", "Slovenia", "North Macedonia", "Montenegro")) & (pop_total$Year==1980)),]
pop_1980_Yugoslavia_sum = sum(pop_1980_Yugoslavia$population)
pop_1980_Yugoslavia$pop_fraction = pop_1980_Yugoslavia$population / pop_1980_Yugoslavia_sum
pop_1980_Yugoslavia

pop_1980_Czechoslovakia = pop_total[((pop_total$Country_Name %in% c("Czech Republic", "Slovakia")) & (pop_total$Year==1980)),]
pop_1980_Czechoslovakia_sum = sum(pop_1980_Czechoslovakia$population)
pop_1980_Czechoslovakia$pop_fraction = pop_1980_Czechoslovakia$population / pop_1980_Czechoslovakia_sum
pop_1980_Czechoslovakia

pop_1980_Belgium_and_Luxembourg = pop_total[((pop_total$Country_Name %in% c("Belgium", "Luxembourg")) & (pop_total$Year==1980)),]
pop_1980_Belgium_and_Luxembourg_sum = sum(pop_1980_Belgium_and_Luxembourg$population)
pop_1980_Belgium_and_Luxembourg$pop_fraction = pop_1980_Belgium_and_Luxembourg$population / pop_1980_Belgium_and_Luxembourg_sum
pop_1980_Belgium_and_Luxembourg


##### United Nations (UN) world population
##### Annual Population by Five-Year Age Groups - Both Sexes. De facto population as of 1 July of the year indicated classified by five-year age groups (0-4, 5-9, 10-14, ..., 95-99, 100+). Data are presented in thousands.
##### https://population.un.org/wpp/Download/Standard/Population/WPP2019_POP_F15_1_ANNUAL_POPULATION_BY_AGE_BOTH_SEXES.xlsx

pop_by_age = read.table( "WPP2019_POP_F15_1_ANNUAL_POPULATION_BY_AGE_BOTH_SEXES.csv", sep=",", header=TRUE, quote='"', comment.char="", row.names=NULL, stringsAsFactors=FALSE, colClasses=c("character") )

pop1 = pop_by_age

names(pop1)[names(pop1)=="X0.4"] = "age_0_to_4"
names(pop1)[names(pop1)=="X5.9"] = "age_5_to_9"
names(pop1)[names(pop1)=="X10.14"] = "age_10_to_14"
names(pop1)[names(pop1)=="X15.19"] = "age_15_to_19"
names(pop1)[names(pop1)=="X20.24"] = "age_20_to_24"
names(pop1)[names(pop1)=="X25.29"] = "age_25_to_29"
names(pop1)[names(pop1)=="X30.34"] = "age_30_to_34"
names(pop1)[names(pop1)=="X35.39"] = "age_35_to_39"
names(pop1)[names(pop1)=="X40.44"] = "age_40_to_44"
names(pop1)[names(pop1)=="X45.49"] = "age_45_to_49"
names(pop1)[names(pop1)=="X50.54"] = "age_50_to_54"
names(pop1)[names(pop1)=="X55.59"] = "age_55_to_59"
names(pop1)[names(pop1)=="X60.64"] = "age_60_to_64"
names(pop1)[names(pop1)=="X65.69"] = "age_65_to_69"
names(pop1)[names(pop1)=="X70.74"] = "age_70_to_74"
names(pop1)[names(pop1)=="X75.79"] = "age_75_to_79"
names(pop1)[names(pop1)=="X80.84"] = "age_80_to_84"
names(pop1)[names(pop1)=="X85.89"] = "age_85_to_89"
names(pop1)[names(pop1)=="X90.94"] = "age_90_to_94"
names(pop1)[names(pop1)=="X95.99"] = "age_95_to_99"
names(pop1)[names(pop1)=="X100."] = "age_100_plus"

pop2 = melt(pop1, id.vars=c("Index", "Variant", "Region..subregion..country.or.area..", "Notes", "Country.code", "Type", "Parent.code", "Reference.date..as.of.1.July."))
names(pop2)[names(pop2)=="Region..subregion..country.or.area.."] = "Country_Name"
names(pop2)[names(pop2)=="Reference.date..as.of.1.July."] = "Year"
names(pop2)[names(pop2)=="variable"] = "age_group"
names(pop2)[names(pop2)=="value"] = "population"

pop3 = pop2[(pop2$Type=="Country/Area"), c("Country_Name", "Year", "age_group", "population")]
pop3$population = gsub(" ", "", pop3$population)
pop3$Year = as.numeric(as.character(pop3$Year))
pop3$age_group = as.character(pop3$age_group)
pop3$population = as.numeric(as.character(pop3$population))
pop3$population = pop3$population * 1000

country_codes$Country_Name[(!(country_codes$Country_Name %in% pop3$Country_Name))]
pop3$Country_Name = ifelse( (pop3$Country_Name=="Cabo Verde"), "Cape Verde", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="Côte d'Ivoire"), "Cote d'Ivoire", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="Libya"), "Libyan Arab Jamahiriya", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="Réunion"), "Reunion", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="Bolivia (Plurinational State of)"), "Bolivia", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="Saint Vincent and the Grenadines"), "Saint Vincent and Grenadines", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="United States Virgin Islands"), "Virgin Islands (USA)", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="Venezuela (Bolivarian Republic of)"), "Venezuela", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="China, Taiwan Province of China"), "China: Province of Taiwan only", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="Dem. People's Republic of Korea"), "Democratic Peoples's Republic of Korea", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="China, Hong Kong SAR"), "Hong Kong SAR", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="China, Macao SAR"), "Macau", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="State of Palestine"), "Occupied Palestinian Territory", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="Czechia"), "Czech Republic", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="Micronesia (Fed. States of)"), "Micronesia (Federated States of)", pop3$Country_Name)
pop3$Country_Name = ifelse( (pop3$Country_Name=="Curaçao"), "Netherlands Antilles", pop3$Country_Name)
country_codes$Country_Name[(!(country_codes$Country_Name %in% pop3$Country_Name))]

pop4 = dcast(pop3, Country_Name + Year ~ age_group, value.var="population")
pop4$age_0_to_14 = apply( pop4[,c("age_0_to_4", "age_5_to_9", "age_10_to_14")], 1, sum, na.rm=TRUE )
pop4$age_75_plus = apply( pop4[,c("age_75_to_79", "age_80_to_84", "age_85_to_89", "age_90_to_94", "age_95_to_99", "age_100_plus")], 1, sum, na.rm=TRUE )
pop4$age_85_plus = apply( pop4[,c("age_85_to_89", "age_90_to_94", "age_95_to_99", "age_100_plus")], 1, sum, na.rm=TRUE )
pop4$age_95_plus = apply( pop4[,c("age_95_to_99", "age_100_plus")], 1, sum, na.rm=TRUE )

pop5 = melt(pop4, id.vars=c("Country_Name", "Year"))
names(pop5)[names(pop5)=="variable"] = "age_group"
names(pop5)[names(pop5)=="value"] = "population"
pop5$age_group = as.character(pop5$age_group)

pop_by_age = pop5
rm(pop2, pop3, pop4, pop5)


##### United Nations (UN) world population
##### Annual Population by Five-Year Age Groups - males. De facto population as of 1 July of the year indicated classified by five-year age groups (0-4, 5-9, 10-14, ..., 95-99, 100+). Data are presented in thousands.
##### https://population.un.org/wpp/Download/Standard/Population/WPP2019_POP_F15_2_ANNUAL_POPULATION_BY_AGE_males.xlsx

pop_males_by_age = read.table( "WPP2019_POP_F15_2_ANNUAL_POPULATION_BY_AGE_MALE.csv", sep=",", header=TRUE, quote='"', comment.char="", row.names=NULL, stringsAsFactors=FALSE, colClasses=c("character") )

pop1 = pop_males_by_age

names(pop1)[names(pop1)=="X0.4"] = "age_0_to_4"
names(pop1)[names(pop1)=="X5.9"] = "age_5_to_9"
names(pop1)[names(pop1)=="X10.14"] = "age_10_to_14"
names(pop1)[names(pop1)=="X15.19"] = "age_15_to_19"
names(pop1)[names(pop1)=="X20.24"] = "age_20_to_24"
names(pop1)[names(pop1)=="X25.29"] = "age_25_to_29"
names(pop1)[names(pop1)=="X30.34"] = "age_30_to_34"
names(pop1)[names(pop1)=="X35.39"] = "age_35_to_39"
names(pop1)[names(pop1)=="X40.44"] = "age_40_to_44"
names(pop1)[names(pop1)=="X45.49"] = "age_45_to_49"
names(pop1)[names(pop1)=="X50.54"] = "age_50_to_54"
names(pop1)[names(pop1)=="X55.59"] = "age_55_to_59"
names(pop1)[names(pop1)=="X60.64"] = "age_60_to_64"
names(pop1)[names(pop1)=="X65.69"] = "age_65_to_69"
names(pop1)[names(pop1)=="X70.74"] = "age_70_to_74"
names(pop1)[names(pop1)=="X75.79"] = "age_75_to_79"
names(pop1)[names(pop1)=="X80.84"] = "age_80_to_84"
names(pop1)[names(pop1)=="X85.89"] = "age_85_to_89"
names(pop1)[names(pop1)=="X90.94"] = "age_90_to_94"
names(pop1)[names(pop1)=="X95.99"] = "age_95_to_99"
names(pop1)[names(pop1)=="X100."] = "age_100_plus"

names(pop1)[names(pop1)=="Region..subregion..country.or.area.."] = "Country_Name"
names(pop1)[names(pop1)=="Reference.date..as.of.1.July."] = "Year"

country_codes$Country_Name[(!(country_codes$Country_Name %in% pop1$Country_Name))]
pop1$Country_Name = ifelse( (pop1$Country_Name=="Cabo Verde"), "Cape Verde", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="Côte d'Ivoire"), "Cote d'Ivoire", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="Libya"), "Libyan Arab Jamahiriya", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="Réunion"), "Reunion", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="Bolivia (Plurinational State of)"), "Bolivia", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="Saint Vincent and the Grenadines"), "Saint Vincent and Grenadines", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="United States Virgin Islands"), "Virgin Islands (USA)", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="Venezuela (Bolivarian Republic of)"), "Venezuela", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="China, Taiwan Province of China"), "China: Province of Taiwan only", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="Dem. People's Republic of Korea"), "Democratic Peoples's Republic of Korea", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="China, Hong Kong SAR"), "Hong Kong SAR", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="China, Macao SAR"), "Macau", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="State of Palestine"), "Occupied Palestinian Territory", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="Czechia"), "Czech Republic", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="Micronesia (Fed. States of)"), "Micronesia (Federated States of)", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="Curaçao"), "Netherlands Antilles", pop1$Country_Name)
country_codes$Country_Name[(!(country_codes$Country_Name %in% pop1$Country_Name))]

for (col in c("age_0_to_4", "age_5_to_9", "age_10_to_14", "age_15_to_19", "age_20_to_24", "age_25_to_29", "age_30_to_34", "age_35_to_39", "age_40_to_44", "age_45_to_49", "age_50_to_54", "age_55_to_59", "age_60_to_64", "age_65_to_69", "age_70_to_74", "age_75_to_79", "age_80_to_84", "age_85_to_89", "age_90_to_94", "age_95_to_99", "age_100_plus")) {
  pop1[,col] = gsub(" ", "", pop1[,col])
  pop1[,col] = as.numeric(as.character(pop1[,col]))
  pop1[,col] = ifelse( (is.na(pop1[,col])), 0, pop1[,col] )
  pop1[,col] = pop1[,col] * 1000
}

pop1$male_population = apply( pop1[,c("age_0_to_4", "age_5_to_9", "age_10_to_14", "age_15_to_19", "age_20_to_24", "age_25_to_29", "age_30_to_34", "age_35_to_39", "age_40_to_44", "age_45_to_49", "age_50_to_54", "age_55_to_59", "age_60_to_64", "age_65_to_69", "age_70_to_74", "age_75_to_79", "age_80_to_84", "age_85_to_89", "age_90_to_94", "age_95_to_99", "age_100_plus")], 1, sum, na.rm=TRUE )

pop_males = pop1[,c("Country_Name", "Year", "male_population")]

pop2 = melt(pop1, id.vars=c("Index", "Variant", "Country_Name", "Notes", "Country.code", "Type", "Parent.code", "Year"))

names(pop2)[names(pop2)=="variable"] = "age_group"
names(pop2)[names(pop2)=="value"] = "population"

pop3 = pop2[(pop2$Type=="Country/Area"), c("Country_Name", "Year", "age_group", "population")]
pop3$age_group = as.character(pop3$age_group)

pop_males_by_age = pop3

rm(pop1, pop2, pop3)


##### United Nations (UN) world population
##### Annual Population by Five-Year Age Groups - females. De facto population as of 1 July of the year indicated classified by five-year age groups (0-4, 5-9, 10-14, ..., 95-99, 100+). Data are presented in thousands.
##### https://population.un.org/wpp/Download/Standard/Population/WPP2019_POP_F15_3_ANNUAL_POPULATION_BY_AGE_females.xlsx

pop_females_by_age = read.table( "WPP2019_POP_F15_3_ANNUAL_POPULATION_BY_AGE_FEMALE.csv", sep=",", header=TRUE, quote='"', comment.char="", row.names=NULL, stringsAsFactors=FALSE, colClasses=c("character") )

pop1 = pop_females_by_age

names(pop1)[names(pop1)=="X0.4"] = "age_0_to_4"
names(pop1)[names(pop1)=="X5.9"] = "age_5_to_9"
names(pop1)[names(pop1)=="X10.14"] = "age_10_to_14"
names(pop1)[names(pop1)=="X15.19"] = "age_15_to_19"
names(pop1)[names(pop1)=="X20.24"] = "age_20_to_24"
names(pop1)[names(pop1)=="X25.29"] = "age_25_to_29"
names(pop1)[names(pop1)=="X30.34"] = "age_30_to_34"
names(pop1)[names(pop1)=="X35.39"] = "age_35_to_39"
names(pop1)[names(pop1)=="X40.44"] = "age_40_to_44"
names(pop1)[names(pop1)=="X45.49"] = "age_45_to_49"
names(pop1)[names(pop1)=="X50.54"] = "age_50_to_54"
names(pop1)[names(pop1)=="X55.59"] = "age_55_to_59"
names(pop1)[names(pop1)=="X60.64"] = "age_60_to_64"
names(pop1)[names(pop1)=="X65.69"] = "age_65_to_69"
names(pop1)[names(pop1)=="X70.74"] = "age_70_to_74"
names(pop1)[names(pop1)=="X75.79"] = "age_75_to_79"
names(pop1)[names(pop1)=="X80.84"] = "age_80_to_84"
names(pop1)[names(pop1)=="X85.89"] = "age_85_to_89"
names(pop1)[names(pop1)=="X90.94"] = "age_90_to_94"
names(pop1)[names(pop1)=="X95.99"] = "age_95_to_99"
names(pop1)[names(pop1)=="X100."] = "age_100_plus"

names(pop1)[names(pop1)=="Region..subregion..country.or.area.."] = "Country_Name"
names(pop1)[names(pop1)=="Reference.date..as.of.1.July."] = "Year"

country_codes$Country_Name[(!(country_codes$Country_Name %in% pop1$Country_Name))]
pop1$Country_Name = ifelse( (pop1$Country_Name=="Cabo Verde"), "Cape Verde", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="Côte d'Ivoire"), "Cote d'Ivoire", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="Libya"), "Libyan Arab Jamahiriya", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="Réunion"), "Reunion", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="Bolivia (Plurinational State of)"), "Bolivia", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="Saint Vincent and the Grenadines"), "Saint Vincent and Grenadines", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="United States Virgin Islands"), "Virgin Islands (USA)", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="Venezuela (Bolivarian Republic of)"), "Venezuela", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="China, Taiwan Province of China"), "China: Province of Taiwan only", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="Dem. People's Republic of Korea"), "Democratic Peoples's Republic of Korea", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="China, Hong Kong SAR"), "Hong Kong SAR", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="China, Macao SAR"), "Macau", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="State of Palestine"), "Occupied Palestinian Territory", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="Czechia"), "Czech Republic", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="Micronesia (Fed. States of)"), "Micronesia (Federated States of)", pop1$Country_Name)
pop1$Country_Name = ifelse( (pop1$Country_Name=="Curaçao"), "Netherlands Antilles", pop1$Country_Name)
country_codes$Country_Name[(!(country_codes$Country_Name %in% pop1$Country_Name))]

for (col in c("age_0_to_4", "age_5_to_9", "age_10_to_14", "age_15_to_19", "age_20_to_24", "age_25_to_29", "age_30_to_34", "age_35_to_39", "age_40_to_44", "age_45_to_49", "age_50_to_54", "age_55_to_59", "age_60_to_64", "age_65_to_69", "age_70_to_74", "age_75_to_79", "age_80_to_84", "age_85_to_89", "age_90_to_94", "age_95_to_99", "age_100_plus")) {
  pop1[,col] = gsub(" ", "", pop1[,col])
  pop1[,col] = as.numeric(as.character(pop1[,col]))
  pop1[,col] = ifelse( (is.na(pop1[,col])), 0, pop1[,col] )
  pop1[,col] = pop1[,col] * 1000
}

pop1$female_population = apply( pop1[,c("age_0_to_4", "age_5_to_9", "age_10_to_14", "age_15_to_19", "age_20_to_24", "age_25_to_29", "age_30_to_34", "age_35_to_39", "age_40_to_44", "age_45_to_49", "age_50_to_54", "age_55_to_59", "age_60_to_64", "age_65_to_69", "age_70_to_74", "age_75_to_79", "age_80_to_84", "age_85_to_89", "age_90_to_94", "age_95_to_99", "age_100_plus")], 1, sum, na.rm=TRUE )

pop_females = pop1[,c("Country_Name", "Year", "female_population")]

pop2 = melt(pop1, id.vars=c("Index", "Variant", "Country_Name", "Notes", "Country.code", "Type", "Parent.code", "Year"))

names(pop2)[names(pop2)=="variable"] = "age_group"
names(pop2)[names(pop2)=="value"] = "population"

pop3 = pop2[(pop2$Type=="Country/Area"), c("Country_Name", "Year", "age_group", "population")]
pop3$age_group = as.character(pop3$age_group)

pop_females_by_age = pop3

rm(pop1, pop2, pop3)


##### World Health Organization (WHO) world population
##### https://www.who.int/data/data-collection-tools/who-mortality-database/
##### Population and live births mort_pop.zip

who_pop_by_age_and_sex = read.table( "pop.txt", sep=",", header=TRUE, quote='"', comment.char="", row.names=NULL, stringsAsFactors=FALSE, colClasses=c("character") )

pop1 = who_pop_by_age_and_sex

pop1$Admin1 = as.character(pop1$Admin1)
pop1$SubDiv = as.character(pop1$SubDiv)
pop1$Frmat = as.character(pop1$Frmat)
pop1$Year = as.numeric(as.character(pop1$Year))
pop1$Sex = as.numeric(as.character(pop1$Sex))
for (i in 1:length(colnames(pop1))) {
  col = colnames(pop1)[i]
  if ((col %like% "^Pop") | (col == "Lb")) {
    pop1[,i] = ifelse( (pop1[,i]==""), "0", pop1[,i] )
    pop1[,i] = as.numeric(as.character(pop1[,i]))
  }
}

names(pop1)[names(pop1)=="Pop1"] = "age_all"
names(pop1)[names(pop1)=="Pop2"] = "age_0"
names(pop1)[names(pop1)=="Pop3"] = "age_1"
names(pop1)[names(pop1)=="Pop4"] = "age_2"
names(pop1)[names(pop1)=="Pop5"] = "age_3"
names(pop1)[names(pop1)=="Pop6"] = "age_4"
names(pop1)[names(pop1)=="Pop7"] = "age_5_to_9"
names(pop1)[names(pop1)=="Pop8"] = "age_10_to_14"
names(pop1)[names(pop1)=="Pop9"] = "age_15_to_19"
names(pop1)[names(pop1)=="Pop10"] = "age_20_to_24"
names(pop1)[names(pop1)=="Pop11"] = "age_25_to_29"
names(pop1)[names(pop1)=="Pop12"] = "age_30_to_34"
names(pop1)[names(pop1)=="Pop13"] = "age_35_to_39"
names(pop1)[names(pop1)=="Pop14"] = "age_40_to_44"
names(pop1)[names(pop1)=="Pop15"] = "age_45_to_49"
names(pop1)[names(pop1)=="Pop16"] = "age_50_to_54"
names(pop1)[names(pop1)=="Pop17"] = "age_55_to_59"
names(pop1)[names(pop1)=="Pop18"] = "age_60_to_64"
names(pop1)[names(pop1)=="Pop19"] = "age_65_to_69"
names(pop1)[names(pop1)=="Pop20"] = "age_70_to_74"
names(pop1)[names(pop1)=="Pop21"] = "age_75_to_79"
names(pop1)[names(pop1)=="Pop22"] = "age_80_to_84"
names(pop1)[names(pop1)=="Pop23"] = "age_85_to_89"
names(pop1)[names(pop1)=="Pop24"] = "age_90_to_94"
names(pop1)[names(pop1)=="Pop25"] = "age_95_plus"
names(pop1)[names(pop1)=="Pop26"] = "age_unspecified"
names(pop1)[names(pop1)=="Lb"] = "live_births"

pop1a = merge( x=pop1, y=country_codes, by=c("Country"), all.x=TRUE, all.y=FALSE )
pop1a$Country = NULL

who_pop_male = pop1a[(pop1a$Sex==1) ,c("Country_Name", "Year", "age_all")]
who_pop_female = pop1a[(pop1a$Sex==2) ,c("Country_Name", "Year", "age_all")]
colnames(who_pop_male) = c("Country_Name", "Year", "male_population")
colnames(who_pop_female) = c("Country_Name", "Year", "female_population")

pop1a$age_0_to_4 = apply(pop1a[,c("age_0","age_1","age_2","age_3","age_4")], 1, sum, na.rm=FALSE)
pop1a$age_0_to_14 = apply(pop1a[,c("age_0_to_4","age_5_to_9","age_10_to_14")], 1, sum, na.rm=FALSE)
pop1a$age_75_plus = apply(pop1a[,c("age_75_to_79","age_80_to_84","age_85_to_89","age_90_to_94","age_95_plus")], 1, sum, na.rm=FALSE)
pop1a$age_85_plus = apply(pop1a[,c("age_85_to_89","age_90_to_94","age_95_plus")], 1, sum, na.rm=FALSE)

# Make sure there is a row of data per Country+Year+Sex
pop1b = sqldf("select Country, Year, Sex, count(*) from pop1 group by Country, Year, Sex having count(*) > 1")
# Brazil, Panama, and Israel have extra rows for Admin1 in addition to whole of country rows
# China has multiple SubDiv that do not necessarily add up to whole of country figures

pop1c = pop1a[((pop1a$Admin1=="") & (pop1a$SubDiv=="")),]
pop1c$Admin1 = NULL
pop1c$SubDiv = NULL
pop1c$Frmat = NULL

pop1_males = pop1c[(pop1c$Sex==1),]
pop1_females = pop1c[(pop1c$Sex==2),]
pop1_males$Sex = NULL
pop1_females$Sex = NULL

pop1_both = sqldf("select Country_Name, Year, sum(age_all), sum(age_0), sum(age_1), sum(age_2), sum(age_3), sum(age_4), sum(age_5_to_9), sum(age_10_to_14), sum(age_15_to_19), sum(age_20_to_24), sum(age_25_to_29), sum(age_30_to_34), sum(age_35_to_39), sum(age_40_to_44), sum(age_45_to_49), sum(age_50_to_54), sum(age_55_to_59), sum(age_60_to_64), sum(age_65_to_69), sum(age_70_to_74), sum(age_75_to_79), sum(age_80_to_84), sum(age_85_to_89), sum(age_90_to_94), sum(age_95_plus), sum(age_unspecified), sum(live_births), sum(age_0_to_4), sum(age_0_to_14), sum(age_75_plus), sum(age_85_plus) from pop1c group by Country_Name, Year")
colnames(pop1_both) = c("Country_Name", "Year", "age_all", "age_0", "age_1", "age_2", "age_3", "age_4", "age_5_to_9", "age_10_to_14", "age_15_to_19", "age_20_to_24", "age_25_to_29", "age_30_to_34", "age_35_to_39", "age_40_to_44", "age_45_to_49", "age_50_to_54", "age_55_to_59", "age_60_to_64", "age_65_to_69", "age_70_to_74", "age_75_to_79", "age_80_to_84", "age_85_to_89", "age_90_to_94", "age_95_plus", "age_unspecified", "live_births", "age_0_to_4", "age_0_to_14", "age_75_plus", "age_85_plus")

who_pop_by_age = melt(pop1_both, id.vars=c("Country_Name", "Year"))
names(who_pop_by_age)[names(who_pop_by_age)=="variable"] = "age_group"
names(who_pop_by_age)[names(who_pop_by_age)=="value"] = "population"

who_pop_males_by_age = melt(pop1_males, id.vars=c("Country_Name", "Year"))
names(who_pop_males_by_age)[names(who_pop_males_by_age)=="variable"] = "age_group"
names(who_pop_males_by_age)[names(who_pop_males_by_age)=="value"] = "population"

who_pop_females_by_age = melt(pop1_females, id.vars=c("Country_Name", "Year"))
names(who_pop_females_by_age)[names(who_pop_females_by_age)=="variable"] = "age_group"
names(who_pop_females_by_age)[names(who_pop_females_by_age)=="value"] = "population"

rm(pop1, pop1a, pop1c, pop1_males, pop1_females, pop1_both)


#####
# The UN population data does not have Bermuda, Dominica, and Saint Kitts and Nevis. Thus get that data from WHO.

pop1 = who_pop_by_age[(who_pop_by_age$Country_Name %in% c("Bermuda", "Dominica", "Saint Kitts and Nevis")),]
pop_by_age_with_extra_countries = rbind( pop_by_age, pop1 )

pop0 = pop_males_by_age
pop1 = who_pop_males_by_age[(who_pop_males_by_age$Country_Name %in% c("Bermuda", "Dominica", "Saint Kitts and Nevis")),]
pop2 = rbind( pop0, pop1 )
pop_males_by_age_with_extra_countries = pop2

pop0 = pop_females_by_age
pop1 = who_pop_females_by_age[(who_pop_females_by_age$Country_Name %in% c("Bermuda", "Dominica", "Saint Kitts and Nevis")),]
pop2 = rbind( pop0, pop1 )
pop_females_by_age_with_extra_countries = pop2

pop1 = who_pop_male[(who_pop_male$Country_Name %in% c("Bermuda", "Dominica", "Saint Kitts and Nevis")),]
pop_males_with_extra_countries = rbind( pop_males, pop1 )

pop1 = who_pop_female[(who_pop_female$Country_Name %in% c("Bermuda", "Dominica", "Saint Kitts and Nevis")),]
pop_females_with_extra_countries = rbind( pop_females, pop1 )

rm(pop0, pop1, pop2)


##### AGE STANDARDIZATION OF RATES: A NEW WHO STANDARD
##### GPE Discussion Paper Series: No.31
##### EIP/GPE/EBD
##### World Health Organization 2001
##### https://www.who.int/healthinfo/paper31.pdf
##### Table 4. WHO World Standard Population Distribution (%), based on world average population between 2000-2025

std_pop_table1 = read.table( "WHO_World_Standard_paper31_Table1.csv", sep=",", header=TRUE, quote='"', comment.char="", row.names=NULL, stringsAsFactors=FALSE, colClasses=c("character") )
std_pop_table4 = read.table( "WHO_World_Standard_paper31_Table4.csv", sep=",", header=TRUE, quote='"', comment.char="", row.names=NULL, stringsAsFactors=FALSE, colClasses=c("character") )

std_pop_table1$Age_group = as.character(std_pop_table1$Age_group)
std_pop_table1$Segi_world_standard = as.numeric(as.character(std_pop_table1$Segi_world_standard))
std_pop_table1$Scandinavian_European_standard = as.numeric(as.character(std_pop_table1$Scandinavian_European_standard))
std_pop_table1$WHO_World_Standard = as.numeric(as.character(std_pop_table1$WHO_World_Standard))

std_pop_table4$Age_group = as.character(std_pop_table4$Age_group)
std_pop_table4$World_Average_2000_2025 = as.numeric(as.character(std_pop_table4$World_Average_2000_2025))

std_pop = std_pop_table1
std_pop$WHO_World_Standard_rate = std_pop$WHO_World_Standard / 100
std_pop$Segi_world_standard = NULL
std_pop$Scandinavian_European_standard = NULL
std_pop$WHO_World_Standard = NULL

names(std_pop)[names(std_pop)=="Age_group"] = "age_group"
std_pop$age_group = ifelse( (std_pop$age_group=="0-4"), "age_0_to_4", std_pop$age_group )
std_pop$age_group = ifelse( (std_pop$age_group=="5-9"), "age_5_to_9", std_pop$age_group )
std_pop$age_group = ifelse( (std_pop$age_group=="10-14"), "age_10_to_14", std_pop$age_group )
std_pop$age_group = ifelse( (std_pop$age_group=="15-19"), "age_15_to_19", std_pop$age_group )
std_pop$age_group = ifelse( (std_pop$age_group=="20-24"), "age_20_to_24", std_pop$age_group )
std_pop$age_group = ifelse( (std_pop$age_group=="25-29"), "age_25_to_29", std_pop$age_group )
std_pop$age_group = ifelse( (std_pop$age_group=="30-34"), "age_30_to_34", std_pop$age_group )
std_pop$age_group = ifelse( (std_pop$age_group=="35-39"), "age_35_to_39", std_pop$age_group )
std_pop$age_group = ifelse( (std_pop$age_group=="40-44"), "age_40_to_44", std_pop$age_group )
std_pop$age_group = ifelse( (std_pop$age_group=="45-49"), "age_45_to_49", std_pop$age_group )
std_pop$age_group = ifelse( (std_pop$age_group=="50-54"), "age_50_to_54", std_pop$age_group )
std_pop$age_group = ifelse( (std_pop$age_group=="55-59"), "age_55_to_59", std_pop$age_group )
std_pop$age_group = ifelse( (std_pop$age_group=="60-64"), "age_60_to_64", std_pop$age_group )
std_pop$age_group = ifelse( (std_pop$age_group=="65-69"), "age_65_to_69", std_pop$age_group )
std_pop$age_group = ifelse( (std_pop$age_group=="70-74"), "age_70_to_74", std_pop$age_group )
std_pop$age_group = ifelse( (std_pop$age_group=="75-79"), "age_75_to_79", std_pop$age_group )
std_pop$age_group = ifelse( (std_pop$age_group=="80-84"), "age_80_to_84", std_pop$age_group )
std_pop$age_group = ifelse( (std_pop$age_group=="85+"), "age_85_plus", std_pop$age_group )

pop1a = std_pop[(std_pop$age_group %in% c("age_0_to_4", "age_5_to_9", "age_10_to_14")),]
pop1b = sqldf('select "age_0_to_14", sum(WHO_World_Standard_rate) from pop1a')
colnames(pop1b) = c("age_group", "WHO_World_Standard_rate")

pop2a = std_pop[(std_pop$age_group %in% c("age_75_to_79", "age_80_to_84", "age_85_plus")),]
pop2b = sqldf('select "age_75_plus", sum(WHO_World_Standard_rate) from pop2a')
colnames(pop2b) = c("age_group", "WHO_World_Standard_rate")

pop3 = rbind( std_pop, pop1b, pop2b )
std_pop = pop3
rm(pop3)

std_pop
#       age_group WHO_World_Standard_rate
# 1    age_0_to_4                  0.0886
# 2    age_5_to_9                  0.0869
# 3  age_10_to_14                  0.0860
# 4  age_15_to_19                  0.0847
# 5  age_20_to_24                  0.0822
# 6  age_25_to_29                  0.0793
# 7  age_30_to_34                  0.0761
# 8  age_35_to_39                  0.0715
# 9  age_40_to_44                  0.0659
# 10 age_45_to_49                  0.0604
# 11 age_50_to_54                  0.0537
# 12 age_55_to_59                  0.0455
# 13 age_60_to_64                  0.0372
# 14 age_65_to_69                  0.0296
# 15 age_70_to_74                  0.0221
# 16 age_75_to_79                  0.0152
# 17 age_80_to_84                  0.0091
# 18  age_85_plus                  0.0063
# 19        Total                  1.0000
# 20  age_0_to_14                  0.2615
# 21  age_75_plus                  0.0306


##### United States Geological Survey (USGS) asbestos consumption
##### USGS Worldwide Asbestos Supply and Consumption Trends from 1900 through 2003
##### https://pubs.usgs.gov/circ/2006/1298/c1298.pdf
##### Data in metric tons

asbestos_1995 = read.table( "USGS_asbestos_consumption_1995.txt", sep="\t", header=TRUE, quote='"', comment.char="", row.names=NULL, stringsAsFactors=FALSE, colClasses=c("character") )
asbestos_1995[(asbestos_1995=="-")] = 0
asbestos_1995[is.na(asbestos_1995)] = 0
asbestos_1995$Production = as.numeric(as.character(asbestos_1995$Production))
asbestos_1995$Imports = as.numeric(as.character(asbestos_1995$Imports))
asbestos_1995$Exports = as.numeric(as.character(asbestos_1995$Exports))
asbestos_1995$Apparent_consumption = as.numeric(as.character(asbestos_1995$Apparent_consumption))

asbestos_1995$Country_Name = ifelse( (asbestos_1995$Country_Name=="Korea, Republic of"), "Republic of Korea", asbestos_1995$Country_Name )
asbestos_1995$Country_Name = ifelse( (asbestos_1995$Country_Name=="Russia"), "Russian Federation", asbestos_1995$Country_Name )
asbestos_1995$Country_Name = ifelse( (asbestos_1995$Country_Name=="Moldova"), "Republic of Moldova", asbestos_1995$Country_Name )
asbestos_1995$Country_Name = ifelse( (asbestos_1995$Country_Name=="Macedonia"), "North Macedonia", asbestos_1995$Country_Name )

asbestos_1995_USSR = asbestos_1995[(asbestos_1995$Country_Name %in% c("Russian Federation", "Kazakhstan", "Ukraine", "Azerbaijan", "Estonia", "Kyrgyzstan", "Latvia", "Lithuania", "Republic of Moldova", "Tajikistan", "Uzbekistan")),]
# Estonia's 1995 Apparent_consumption is -1,061. Estonia's 1976 Apparent_consumption is 500. Use 1996 consumption.
asbestos_1995_USSR$Apparent_consumption = ifelse( (asbestos_1995_USSR$Country_Name=="Estonia"), 500, asbestos_1995_USSR$Apparent_consumption )
asbestos_1995_USSR_sum_Production = sum(asbestos_1995_USSR$Production)
asbestos_1995_USSR_sum_Imports = sum(asbestos_1995_USSR$Imports)
asbestos_1995_USSR_sum_Exports = sum(asbestos_1995_USSR$Exports)
asbestos_1995_USSR_sum_Apparent_consumption = sum(asbestos_1995_USSR$Apparent_consumption)
asbestos_1995_USSR$Production_fraction = asbestos_1995_USSR$Production / asbestos_1995_USSR_sum_Production
asbestos_1995_USSR$Imports_fraction = asbestos_1995_USSR$Imports / asbestos_1995_USSR_sum_Imports
asbestos_1995_USSR$Exports_fraction = asbestos_1995_USSR$Exports / asbestos_1995_USSR_sum_Exports
asbestos_1995_USSR$Apparent_consumption_fraction = asbestos_1995_USSR$Apparent_consumption / asbestos_1995_USSR_sum_Apparent_consumption
asbestos_1995_USSR
#           Country_Name Production Imports Exports Apparent_consumption Production_fraction Imports_fraction Exports_fraction Apparent_consumption_fraction
# 42             Estonia          0    7976    9037                  500           0.0000000       0.11163207      0.043610024                  0.0007026261
# 49          Kazakhstan     160829       0  115400                45429           0.1901436       0.00000000      0.556887990                  0.0638392054
# 50          Kyrgyzstan          0   11445     793                10652           0.0000000       0.16018419      0.003826795                  0.0149687472
# 51              Latvia          0    2228       0                 2228           0.0000000       0.03118308      0.000000000                  0.0031309021
# 52           Lithuania          0    5600    5173                  427           0.0000000       0.07837758      0.024963445                  0.0006000427
# 54 Republic of Moldova          0    2800       0                 2800           0.0000000       0.03918879      0.000000000                  0.0039347064
# 58  Russian Federation     685000   41400   76820               649580           0.8098564       0.57943428      0.370711745                  0.9128237701

asbestos_1995_Czechoslovakia = asbestos_1995[(asbestos_1995$Country_Name %in% c("Czech Republic", "Slovakia")),]
asbestos_1995_Czechoslovakia_sum_Production = sum(asbestos_1995_Czechoslovakia$Production)
asbestos_1995_Czechoslovakia_sum_Imports = sum(asbestos_1995_Czechoslovakia$Imports)
asbestos_1995_Czechoslovakia_sum_Exports = sum(asbestos_1995_Czechoslovakia$Exports)
asbestos_1995_Czechoslovakia_sum_Apparent_consumption = sum(asbestos_1995_Czechoslovakia$Apparent_consumption)
asbestos_1995_Czechoslovakia$Production_fraction = asbestos_1995_Czechoslovakia$Production / asbestos_1995_Czechoslovakia_sum_Production
asbestos_1995_Czechoslovakia$Production_fraction = 0
asbestos_1995_Czechoslovakia$Imports_fraction = asbestos_1995_Czechoslovakia$Imports / asbestos_1995_Czechoslovakia_sum_Imports
asbestos_1995_Czechoslovakia$Exports_fraction = asbestos_1995_Czechoslovakia$Exports / asbestos_1995_Czechoslovakia_sum_Exports
asbestos_1995_Czechoslovakia$Apparent_consumption_fraction = asbestos_1995_Czechoslovakia$Apparent_consumption / asbestos_1995_Czechoslovakia_sum_Apparent_consumption
asbestos_1995_Czechoslovakia
#      Country_Name Production Imports Exports Apparent_consumption Production_fraction Imports_fraction Exports_fraction Apparent_consumption_fraction
# 40 Czech Republic          0    4500     100                 4400                   0        0.6617647              0.5                     0.6666667
# 60       Slovakia          0    2300     100                 2200                   0        0.3382353              0.5                     0.3333333

asbestos_1998 = read.table( "USGS_asbestos_consumption_1998.txt", sep="\t", header=TRUE, quote='"', comment.char="", row.names=NULL, stringsAsFactors=FALSE, colClasses=c("character") )
asbestos_1998[(asbestos_1998=="-")] = 0
asbestos_1998[is.na(asbestos_1998)] = 0
asbestos_1998$Production = as.numeric(as.character(asbestos_1998$Production))
asbestos_1998$Imports = as.numeric(as.character(asbestos_1998$Imports))
asbestos_1998$Exports = as.numeric(as.character(asbestos_1998$Exports))
asbestos_1998$Apparent_consumption = as.numeric(as.character(asbestos_1998$Apparent_consumption))

asbestos_1998$Country_Name = ifelse( (asbestos_1998$Country_Name=="Korea, Republic of"), "Republic of Korea", asbestos_1998$Country_Name )
asbestos_1998$Country_Name = ifelse( (asbestos_1998$Country_Name=="Russia"), "Russian Federation", asbestos_1998$Country_Name )
asbestos_1998$Country_Name = ifelse( (asbestos_1998$Country_Name=="Moldova"), "Republic of Moldova", asbestos_1998$Country_Name )
asbestos_1998$Country_Name = ifelse( (asbestos_1998$Country_Name=="Macedonia"), "North Macedonia", asbestos_1998$Country_Name )

# For Montenegro, use data of 1999 with 1998 Serbia removed, because 1998 data not available.
# For North Macedonia, use data of 2000, because 1998 data not available.
# Country_Name	Production	Imports	Exports	Apparent_consumption	Year
# Serbia		361	-	-	361	1998
# Serbia and Montenegro	563	127	-	690	1999
# Montenegro		202	127	-	329
# North Macedonia	-	48	-	48	2000

temp1 = c("Montenegro", "202", "127", "-", "329")
temp2 = c("North Macedonia", "-", "48", "-", "48")
temp = as.data.frame(as.matrix(rbind(temp1, temp2)))
colnames(temp) = c("Country_Name", "Production", "Imports", "Exports", "Apparent_consumption")
temp[(temp=="-")] = 0
temp$Production = as.numeric(as.character(temp$Production))
temp$Imports = as.numeric(as.character(temp$Imports))
temp$Exports = as.numeric(as.character(temp$Exports))
temp$Apparent_consumption = as.numeric(as.character(temp$Apparent_consumption))
asbestos_1998 = rbind( asbestos_1998, temp )
rm(temp, temp1, temp2)

asbestos_1998_Yugoslavia = asbestos_1998[(asbestos_1998$Country_Name %in% c("Bosnia and Herzegovina", "Croatia", "Serbia", "Slovenia", "North Macedonia", "Montenegro")),]
asbestos_1998_Yugoslavia_sum_Production = sum(asbestos_1998_Yugoslavia$Production)
asbestos_1998_Yugoslavia_sum_Imports = sum(asbestos_1998_Yugoslavia$Imports)
asbestos_1998_Yugoslavia_sum_Exports = sum(asbestos_1998_Yugoslavia$Exports)
asbestos_1998_Yugoslavia_sum_Apparent_consumption = sum(asbestos_1998_Yugoslavia$Apparent_consumption)
asbestos_1998_Yugoslavia$Production_fraction = asbestos_1998_Yugoslavia$Production / asbestos_1998_Yugoslavia_sum_Production
asbestos_1998_Yugoslavia$Imports_fraction = asbestos_1998_Yugoslavia$Imports / asbestos_1998_Yugoslavia_sum_Imports
asbestos_1998_Yugoslavia$Exports_fraction = asbestos_1998_Yugoslavia$Exports / asbestos_1998_Yugoslavia_sum_Exports
asbestos_1998_Yugoslavia$Apparent_consumption_fraction = asbestos_1998_Yugoslavia$Apparent_consumption / asbestos_1998_Yugoslavia_sum_Apparent_consumption
asbestos_1998_Yugoslavia
#                 Country_Name Production Imports Exports Apparent_consumption Production_fraction Imports_fraction Exports_fraction Apparent_consumption_fraction
# 60    Bosnia and Herzegovina          0      12       0                   12           0.0000000      0.004255319                0                   0.003559775
# 62                   Croatia          0     948      12                  936           0.0000000      0.336170213                1                   0.277662415
# 81                    Serbia        361       0       0                  361           0.6412078      0.000000000                0                   0.107089884
# 83                  Slovenia          0    1685       0                 1685           0.0000000      0.597517730                0                   0.499851676
# temp1             Montenegro        202     127       0                  329           0.3587922      0.045035461                0                   0.097597152
# temp2        North Macedonia          0      48       0                   48           0.0000000      0.017021277                0                   0.014239098


#####
asbestos_1975only = read.table( "USGS_asbestos_consumption_1975.txt", sep="\t", header=TRUE, quote='"', comment.char="", row.names=NULL, stringsAsFactors=FALSE, colClasses=c("character") )
asbestos_1975only[(asbestos_1975only=="-")] = 0
asbestos_1975only[is.na(asbestos_1975only)] = 0
asbestos_1975only$Production = as.numeric(as.character(asbestos_1975only$Production))
asbestos_1975only$Imports = as.numeric(as.character(asbestos_1975only$Imports))
asbestos_1975only$Exports = as.numeric(as.character(asbestos_1975only$Exports))
asbestos_1975only$Apparent_consumption = as.numeric(as.character(asbestos_1975only$Apparent_consumption))

asbestos_1975only$Country_Name[(!(asbestos_1975only$Country_Name %in% country_codes$Country_Name))]
asbestos_1975only$Country_Name = ifelse( (asbestos_1975only$Country_Name=="Libya"), "Libyan Arab Jamahiriya", asbestos_1975only$Country_Name )
asbestos_1975only$Country_Name = ifelse( (asbestos_1975only$Country_Name=="Southern Rhodesia"), "Zimbabwe", asbestos_1975only$Country_Name )
asbestos_1975only$Country_Name = ifelse( (asbestos_1975only$Country_Name=="Swaziland"), "Eswatini", asbestos_1975only$Country_Name )
asbestos_1975only$Country_Name = ifelse( (asbestos_1975only$Country_Name=="Zaire"), "Democratic Republic of the Congo", asbestos_1975only$Country_Name )
asbestos_1975only$Country_Name = ifelse( (asbestos_1975only$Country_Name=="Hong Kong"), "Hong Kong SAR", asbestos_1975only$Country_Name )
asbestos_1975only$Country_Name = ifelse( (asbestos_1975only$Country_Name=="Iran"), "Iran (Islamic Republic of)", asbestos_1975only$Country_Name )
asbestos_1975only$Country_Name = ifelse( (asbestos_1975only$Country_Name=="Korea, North"), "Democratic Peoples's Republic of Korea", asbestos_1975only$Country_Name )
asbestos_1975only$Country_Name = ifelse( (asbestos_1975only$Country_Name=="Korea, Republic of"), "Republic of Korea", asbestos_1975only$Country_Name )
asbestos_1975only$Country_Name = ifelse( (asbestos_1975only$Country_Name=="Syria"), "Syrian Arab Republic", asbestos_1975only$Country_Name )
asbestos_1975only$Country_Name = ifelse( (asbestos_1975only$Country_Name=="Taiwan"), "China: Province of Taiwan only", asbestos_1975only$Country_Name )
asbestos_1975only$Country_Name = ifelse( (asbestos_1975only$Country_Name=="United States"), "United States of America", asbestos_1975only$Country_Name )
asbestos_1975only$Country_Name[(!(asbestos_1975only$Country_Name %in% country_codes$Country_Name))]

# Apparent_consumption is negative in the sampled case in a few cases,
# and this is assumed to not reflect annual consumption for the preceding and following 5 years.
# In those cases, take the average of the preceding and following periods for that country.

asbestos_1975only[asbestos_1975only$Apparent_consumption<0,]
#   Country_Name Production Imports Exports Apparent_consumption
#7    Mozambique          0     740    1148                 -408
#12     Eswatini      37601       0   41219                -3618
#39       Canada    1055667    5166 1085610               -24777

# Canada 1970 apparent_consumption = 95,374
# Canada 1975 apparent_consumption = -24,777 # This negative consumption is assumed to be an anomaly due to an anomalous one-time reduction in production whilst exports were maintained, that would not have affected consumption. Thus, average of 1970 and 1980 is a better reflection of true consumption.
# Canada 1980 apparent_consumption = 106,369
(95374+106369)/2 # = 100871.5
asbestos_1975only$Apparent_consumption = ifelse( (asbestos_1975only$Country_Name == "Canada"), 100871.5, asbestos_1975only$Apparent_consumption )

# Mozambique 1970 apparent_consumption = 665
# Mozambique 1975 apparent_consumption = -408 # This negative consumption is assumed to be an anomaly. Thus average of 1970 and 1980 is a better reflection of true consumption.
# Mozambique 1980 apparent_consumption = 1,882
(665+1882)/2 # = 1273.5
asbestos_1975only$Apparent_consumption = ifelse( (asbestos_1975only$Country_Name == "Mozambique"), 1273.5, asbestos_1975only$Apparent_consumption )

# In 2018, Swaziland was renamed to Eswatini.
# Swaziland 1970 apparent_consumption = 544
# Swaziland 1975 apparent_consumption = -3,618 # this negative consumption is assumed to be an anomaly. Thus average of 1970 and 1980 is a better reflection of true consumption.
# Eswatini 1980 apparent_consumption = 1,398
(544+1398)/2 # = 971
asbestos_1975only$Apparent_consumption = ifelse( (asbestos_1975only$Country_Name == "Eswatini"), 971, asbestos_1975only$Apparent_consumption )

asbestos_1975only_before_splitting_and_merging_countries = asbestos_1975only

asbestos_1975only_Germany = asbestos_1975only[(asbestos_1975only$Country_Name %in% c("Germany, East", "Germany, West")),]
asbestos_1975only_Germany_sum = sqldf("select 'Germany', sum(Production), sum(Imports), sum(Exports), sum(Apparent_consumption) from asbestos_1975only_Germany")
colnames(asbestos_1975only_Germany_sum) = colnames(asbestos_1975only)
asbestos_1975only_Germany
# 57          Germany, East          0   65725       0              65725.0
# 58          Germany, West          0  386188   73770             312418.0

# Split 1975 USSR asbestos consumption by 1995 consumption because that is the first year where we have asbestos figures by country.
asbestos_1975only_USSR = asbestos_1995_USSR
asbestos_1975only_USSR$Production = asbestos_1975only_before_splitting_and_merging_countries[(asbestos_1975only_before_splitting_and_merging_countries$Country_Name=="Soviet Union"), c("Production")]
asbestos_1975only_USSR$Imports = asbestos_1975only_before_splitting_and_merging_countries[(asbestos_1975only_before_splitting_and_merging_countries$Country_Name=="Soviet Union"), c("Imports")]
asbestos_1975only_USSR$Exports = asbestos_1975only_before_splitting_and_merging_countries[(asbestos_1975only_before_splitting_and_merging_countries$Country_Name=="Soviet Union"), c("Exports")]
asbestos_1975only_USSR$Apparent_consumption = asbestos_1975only_before_splitting_and_merging_countries[(asbestos_1975only_before_splitting_and_merging_countries$Country_Name=="Soviet Union"), c("Apparent_consumption")]
asbestos_1975only_USSR$Production = asbestos_1975only_USSR$Production * asbestos_1975only_USSR$Production_fraction
asbestos_1975only_USSR$Imports = asbestos_1975only_USSR$Imports * asbestos_1975only_USSR$Imports_fraction
asbestos_1975only_USSR$Exports = asbestos_1975only_USSR$Exports * asbestos_1975only_USSR$Exports_fraction
asbestos_1975only_USSR$Apparent_consumption = asbestos_1975only_USSR$Apparent_consumption * asbestos_1975only_USSR$Apparent_consumption_fraction
asbestos_1975only_USSR$Production_fraction = NULL
asbestos_1975only_USSR$Imports_fraction = NULL
asbestos_1975only_USSR$Exports_fraction = NULL
asbestos_1975only_USSR$Apparent_consumption_fraction = NULL
asbestos_1975only_USSR
#           Country_Name Production Imports    Exports Apparent_consumption
# 42             Estonia        0.0       0  26746.159             904.0669
# 49          Kazakhstan   361272.9       0 341541.075           82141.7141
# 50          Kyrgyzstan        0.0       0   2346.985           19260.2421
# 51              Latvia        0.0       0      0.000            4028.5223
# 52           Lithuania        0.0       0  15310.156             772.0732
# 54 Republic of Moldova        0.0       0      0.000            5062.7749
# 58  Russian Federation  1538727.1       0 227358.626         1174527.6065

# Split 1975 Czechoslovakia asbestos consumption by 1995 consumption because that is the first year where we have asbestos data by country.
asbestos_1975only_Czechoslovakia = asbestos_1995_Czechoslovakia
asbestos_1975only_Czechoslovakia$Production = asbestos_1975only_before_splitting_and_merging_countries[(asbestos_1975only_before_splitting_and_merging_countries$Country_Name=="Czechoslovakia"), c("Production")]
asbestos_1975only_Czechoslovakia$Imports = asbestos_1975only_before_splitting_and_merging_countries[(asbestos_1975only_before_splitting_and_merging_countries$Country_Name=="Czechoslovakia"), c("Imports")]
asbestos_1975only_Czechoslovakia$Exports = asbestos_1975only_before_splitting_and_merging_countries[(asbestos_1975only_before_splitting_and_merging_countries$Country_Name=="Czechoslovakia"), c("Exports")]
asbestos_1975only_Czechoslovakia$Apparent_consumption = asbestos_1975only_before_splitting_and_merging_countries[(asbestos_1975only_before_splitting_and_merging_countries$Country_Name=="Czechoslovakia"), c("Apparent_consumption")]
asbestos_1975only_Czechoslovakia$Production = asbestos_1975only_Czechoslovakia$Production * asbestos_1975only_Czechoslovakia$Production_fraction
asbestos_1975only_Czechoslovakia$Imports = asbestos_1975only_Czechoslovakia$Imports * asbestos_1975only_Czechoslovakia$Imports_fraction
asbestos_1975only_Czechoslovakia$Exports = asbestos_1975only_Czechoslovakia$Exports * asbestos_1975only_Czechoslovakia$Exports_fraction
asbestos_1975only_Czechoslovakia$Apparent_consumption = asbestos_1975only_Czechoslovakia$Apparent_consumption * asbestos_1975only_Czechoslovakia$Apparent_consumption_fraction
asbestos_1975only_Czechoslovakia$Production_fraction = NULL
asbestos_1975only_Czechoslovakia$Imports_fraction = NULL
asbestos_1975only_Czechoslovakia$Exports_fraction = NULL
asbestos_1975only_Czechoslovakia$Apparent_consumption_fraction = NULL
asbestos_1975only_Czechoslovakia
#      Country_Name Production  Imports Exports Apparent_consumption
# 40 Czech Republic          0 28782.79       0                28996
# 60       Slovakia          0 14711.21       0                14498

# Split 1975 Yugoslavia asbestos consumption by 1998 consumption because that is the first year where we have asbestos data by country.
asbestos_1975only_Yugoslavia = asbestos_1998_Yugoslavia
asbestos_1975only_Yugoslavia$Production = asbestos_1975only_before_splitting_and_merging_countries[(asbestos_1975only_before_splitting_and_merging_countries$Country_Name=="Yugoslavia"), c("Production")]
asbestos_1975only_Yugoslavia$Imports = asbestos_1975only_before_splitting_and_merging_countries[(asbestos_1975only_before_splitting_and_merging_countries$Country_Name=="Yugoslavia"), c("Imports")]
asbestos_1975only_Yugoslavia$Exports = asbestos_1975only_before_splitting_and_merging_countries[(asbestos_1975only_before_splitting_and_merging_countries$Country_Name=="Yugoslavia"), c("Exports")]
asbestos_1975only_Yugoslavia$Apparent_consumption = asbestos_1975only_before_splitting_and_merging_countries[(asbestos_1975only_before_splitting_and_merging_countries$Country_Name=="Yugoslavia"), c("Apparent_consumption")]
asbestos_1975only_Yugoslavia$Production = asbestos_1975only_Yugoslavia$Production * asbestos_1975only_Yugoslavia$Production_fraction
asbestos_1975only_Yugoslavia$Imports = asbestos_1975only_Yugoslavia$Imports * asbestos_1975only_Yugoslavia$Imports_fraction
asbestos_1975only_Yugoslavia$Exports = asbestos_1975only_Yugoslavia$Exports * asbestos_1975only_Yugoslavia$Exports_fraction
asbestos_1975only_Yugoslavia$Apparent_consumption = asbestos_1975only_Yugoslavia$Apparent_consumption * asbestos_1975only_Yugoslavia$Apparent_consumption_fraction
asbestos_1975only_Yugoslavia$Production_fraction = NULL
asbestos_1975only_Yugoslavia$Imports_fraction = NULL
asbestos_1975only_Yugoslavia$Exports_fraction = NULL
asbestos_1975only_Yugoslavia$Apparent_consumption_fraction = NULL
asbestos_1975only_Yugoslavia
#                 Country_Name Production    Imports Exports Apparent_consumption
# 60    Bosnia and Herzegovina       0.00   221.8638       0             218.2284
# 62                   Croatia       0.00 17527.2426    3170           17021.8167
# 81                    Serbia    7909.94     0.0000       0            6565.0383
# 83                  Slovenia       0.00 31153.3794       0           30642.9071
# temp1             Montenegro    4426.06  2348.0589       0            5983.0958
# temp2        North Macedonia       0.00   887.4553       0             872.9137

# Split 1975 Belgium_and_Luxembourg asbestos consumption by 1975 population proportions because in data upto 2003 we never have asbestos consumption data by country.
asbestos_1975only_Belgium_and_Luxembourg = pop_1975_Belgium_and_Luxembourg
asbestos_1975only_Belgium_and_Luxembourg$Production = asbestos_1975only_before_splitting_and_merging_countries[(asbestos_1975only_before_splitting_and_merging_countries$Country_Name=="Belgium and Luxembourg"), c("Production")]
asbestos_1975only_Belgium_and_Luxembourg$Imports = asbestos_1975only_before_splitting_and_merging_countries[(asbestos_1975only_before_splitting_and_merging_countries$Country_Name=="Belgium and Luxembourg"), c("Imports")]
asbestos_1975only_Belgium_and_Luxembourg$Exports = asbestos_1975only_before_splitting_and_merging_countries[(asbestos_1975only_before_splitting_and_merging_countries$Country_Name=="Belgium and Luxembourg"), c("Exports")]
asbestos_1975only_Belgium_and_Luxembourg$Apparent_consumption = asbestos_1975only_before_splitting_and_merging_countries[(asbestos_1975only_before_splitting_and_merging_countries$Country_Name=="Belgium and Luxembourg"), c("Apparent_consumption")]
asbestos_1975only_Belgium_and_Luxembourg$Production = asbestos_1975only_Belgium_and_Luxembourg$Production * asbestos_1975only_Belgium_and_Luxembourg$pop_fraction
asbestos_1975only_Belgium_and_Luxembourg$Imports = asbestos_1975only_Belgium_and_Luxembourg$Imports * asbestos_1975only_Belgium_and_Luxembourg$pop_fraction
asbestos_1975only_Belgium_and_Luxembourg$Exports = asbestos_1975only_Belgium_and_Luxembourg$Exports * asbestos_1975only_Belgium_and_Luxembourg$pop_fraction
asbestos_1975only_Belgium_and_Luxembourg$Apparent_consumption = asbestos_1975only_Belgium_and_Luxembourg$Apparent_consumption * asbestos_1975only_Belgium_and_Luxembourg$pop_fraction
asbestos_1975only_Belgium_and_Luxembourg$Year = NULL
asbestos_1975only_Belgium_and_Luxembourg$population = NULL
asbestos_1975only_Belgium_and_Luxembourg$pop_fraction = NULL
asbestos_1975only_Belgium_and_Luxembourg
#      Country_Name Production   Imports    Exports Apparent_consumption
# 7501      Belgium          0 58432.237 1660.83468            56771.402
# 7505   Luxembourg          0  2116.763   60.16532             2056.598

asbestos_1975only_minus_adjusted_countries = asbestos_1975only_before_splitting_and_merging_countries[(!(asbestos_1975only_before_splitting_and_merging_countries$Country_Name %in% c("Germany, East", "Germany, West", "Soviet Union", "Yugoslavia", "Czechoslovakia", "Belgium and Luxembourg"))),]

asbestos_1975only = rbind(asbestos_1975only_minus_adjusted_countries, asbestos_1975only_Germany_sum, asbestos_1975only_USSR, asbestos_1975only_Yugoslavia, asbestos_1975only_Czechoslovakia, asbestos_1975only_Belgium_and_Luxembourg)

asbestos_1975only$Country_Name[(!(asbestos_1975only$Country_Name %in% country_codes$Country_Name))]

PC_asbestos_1975only = merge( x=asbestos_1975only, y=pop_1975, by=c("Country_Name"), all.x=TRUE, all.y=FALSE )

PC_asbestos_1975only[is.na(PC_asbestos_1975only$population),c("Country_Name")] # [1] "Canary Islands"
# Canary Islands will not be included in analysis even though we have asbestos consumption data, because we do not have WHO mortality data

PC_asbestos_1975only = merge( x=asbestos_1975only, y=pop_1975, by=c("Country_Name"), all.x=FALSE, all.y=FALSE )

PC_asbestos_1975only$PC_asbestos_kg = PC_asbestos_1975only$Apparent_consumption * 1000 / PC_asbestos_1975only$population # 1 metric tonne = 1000 kg


#####
asbestos_1970only = read.table( "USGS_asbestos_consumption_1970.txt", sep="\t", header=TRUE, quote='"', comment.char="", row.names=NULL, stringsAsFactors=FALSE, colClasses=c("character") )
asbestos_1970only[(asbestos_1970only=="-")] = 0
asbestos_1970only[is.na(asbestos_1970only)] = 0
asbestos_1970only$Production = as.numeric(as.character(asbestos_1970only$Production))
asbestos_1970only$Imports = as.numeric(as.character(asbestos_1970only$Imports))
asbestos_1970only$Exports = as.numeric(as.character(asbestos_1970only$Exports))
asbestos_1970only$Apparent_consumption = as.numeric(as.character(asbestos_1970only$Apparent_consumption))

asbestos_1970only$Country_Name[(!(asbestos_1970only$Country_Name %in% country_codes$Country_Name))]
asbestos_1970only$Country_Name = ifelse( (asbestos_1970only$Country_Name=="Libya"), "Libyan Arab Jamahiriya", asbestos_1970only$Country_Name )
asbestos_1970only$Country_Name = ifelse( (asbestos_1970only$Country_Name=="Southern Rhodesia"), "Zimbabwe", asbestos_1970only$Country_Name )
asbestos_1970only$Country_Name = ifelse( (asbestos_1970only$Country_Name=="Swaziland"), "Eswatini", asbestos_1970only$Country_Name )
asbestos_1970only$Country_Name = ifelse( (asbestos_1970only$Country_Name=="Zaire"), "Democratic Republic of the Congo", asbestos_1970only$Country_Name )
asbestos_1970only$Country_Name = ifelse( (asbestos_1970only$Country_Name=="Hong Kong"), "Hong Kong SAR", asbestos_1970only$Country_Name )
asbestos_1970only$Country_Name = ifelse( (asbestos_1970only$Country_Name=="Iran"), "Iran (Islamic Republic of)", asbestos_1970only$Country_Name )
asbestos_1970only$Country_Name = ifelse( (asbestos_1970only$Country_Name=="Korea, North"), "Democratic Peoples's Republic of Korea", asbestos_1970only$Country_Name )
asbestos_1970only$Country_Name = ifelse( (asbestos_1970only$Country_Name=="Korea, Republic of"), "Republic of Korea", asbestos_1970only$Country_Name )
asbestos_1970only$Country_Name = ifelse( (asbestos_1970only$Country_Name=="Syria"), "Syrian Arab Republic", asbestos_1970only$Country_Name )
asbestos_1970only$Country_Name = ifelse( (asbestos_1970only$Country_Name=="Taiwan"), "China: Province of Taiwan only", asbestos_1970only$Country_Name )
asbestos_1970only$Country_Name = ifelse( (asbestos_1970only$Country_Name=="United States"), "United States of America", asbestos_1970only$Country_Name )
asbestos_1970only$Country_Name = ifelse( (asbestos_1970only$Country_Name=="Burma"), "Myanmar", asbestos_1970only$Country_Name )
asbestos_1970only$Country_Name[(!(asbestos_1970only$Country_Name %in% country_codes$Country_Name))]

# Apparent_consumption is negative in the sampled case in a few cases,
# and this is assumed to not reflect annual consumption for the preceding and following 5 years.
# In those cases, take the average of the preceding and following periods for that country.

asbestos_1970only[asbestos_1970only$Apparent_consumption<0,] # none are negative

asbestos_1970only_before_splitting_and_merging_countries = asbestos_1970only

asbestos_1970only_Germany = asbestos_1970only[(asbestos_1970only$Country_Name %in% c("Germany, East", "Germany, West")),]
asbestos_1970only_Germany_sum = sqldf("select 'Germany', sum(Production), sum(Imports), sum(Exports), sum(Apparent_consumption) from asbestos_1970only_Germany")
colnames(asbestos_1970only_Germany_sum) = colnames(asbestos_1970only)
asbestos_1970only_Germany
#     Country_Name Production Imports Exports Apparent_consumption
# 50 Germany, East          0   52015       0                52015
# 51 Germany, West          0  175612     924               174688

# Split 1970 USSR asbestos consumption by 1995 consumption because that is the first year where we have asbestos figures by country.
asbestos_1970only_USSR = asbestos_1995_USSR
asbestos_1970only_USSR$Production = asbestos_1970only_before_splitting_and_merging_countries[(asbestos_1970only_before_splitting_and_merging_countries$Country_Name=="Soviet Union"), c("Production")]
asbestos_1970only_USSR$Imports = asbestos_1970only_before_splitting_and_merging_countries[(asbestos_1970only_before_splitting_and_merging_countries$Country_Name=="Soviet Union"), c("Imports")]
asbestos_1970only_USSR$Exports = asbestos_1970only_before_splitting_and_merging_countries[(asbestos_1970only_before_splitting_and_merging_countries$Country_Name=="Soviet Union"), c("Exports")]
asbestos_1970only_USSR$Apparent_consumption = asbestos_1970only_before_splitting_and_merging_countries[(asbestos_1970only_before_splitting_and_merging_countries$Country_Name=="Soviet Union"), c("Apparent_consumption")]
asbestos_1970only_USSR$Production = asbestos_1970only_USSR$Production * asbestos_1970only_USSR$Production_fraction
asbestos_1970only_USSR$Imports = asbestos_1970only_USSR$Imports * asbestos_1970only_USSR$Imports_fraction
asbestos_1970only_USSR$Exports = asbestos_1970only_USSR$Exports * asbestos_1970only_USSR$Exports_fraction
asbestos_1970only_USSR$Apparent_consumption = asbestos_1970only_USSR$Apparent_consumption * asbestos_1970only_USSR$Apparent_consumption_fraction
asbestos_1970only_USSR$Production_fraction = NULL
asbestos_1970only_USSR$Imports_fraction = NULL
asbestos_1970only_USSR$Exports_fraction = NULL
asbestos_1970only_USSR$Apparent_consumption_fraction = NULL
asbestos_1970only_USSR
#           Country_Name Production Imports    Exports Apparent_consumption
# 42             Estonia          0       0  16802.942             478.1996
# 49          Kazakhstan     202672       0 214568.943           43448.2610
# 50          Kyrgyzstan          0       0   1474.464           10187.5647
# 51              Latvia          0       0      0.000            2130.8575
# 52           Lithuania          0       0   9618.415             408.3825
# 54 Republic of Moldova          0       0      0.000            2677.9179
# 58  Russian Federation     863217       0 142835.235          621257.8169

# Split 1970 Czechoslovakia asbestos consumption by 1995 consumption because that is the first year where we have asbestos data by country.
asbestos_1970only_Czechoslovakia = asbestos_1995_Czechoslovakia
asbestos_1970only_Czechoslovakia$Production = asbestos_1970only_before_splitting_and_merging_countries[(asbestos_1970only_before_splitting_and_merging_countries$Country_Name=="Czechoslovakia"), c("Production")]
asbestos_1970only_Czechoslovakia$Imports = asbestos_1970only_before_splitting_and_merging_countries[(asbestos_1970only_before_splitting_and_merging_countries$Country_Name=="Czechoslovakia"), c("Imports")]
asbestos_1970only_Czechoslovakia$Exports = asbestos_1970only_before_splitting_and_merging_countries[(asbestos_1970only_before_splitting_and_merging_countries$Country_Name=="Czechoslovakia"), c("Exports")]
asbestos_1970only_Czechoslovakia$Apparent_consumption = asbestos_1970only_before_splitting_and_merging_countries[(asbestos_1970only_before_splitting_and_merging_countries$Country_Name=="Czechoslovakia"), c("Apparent_consumption")]
asbestos_1970only_Czechoslovakia$Production = asbestos_1970only_Czechoslovakia$Production * asbestos_1970only_Czechoslovakia$Production_fraction
asbestos_1970only_Czechoslovakia$Imports = asbestos_1970only_Czechoslovakia$Imports * asbestos_1970only_Czechoslovakia$Imports_fraction
asbestos_1970only_Czechoslovakia$Exports = asbestos_1970only_Czechoslovakia$Exports * asbestos_1970only_Czechoslovakia$Exports_fraction
asbestos_1970only_Czechoslovakia$Apparent_consumption = asbestos_1970only_Czechoslovakia$Apparent_consumption * asbestos_1970only_Czechoslovakia$Apparent_consumption_fraction
asbestos_1970only_Czechoslovakia$Production_fraction = NULL
asbestos_1970only_Czechoslovakia$Imports_fraction = NULL
asbestos_1970only_Czechoslovakia$Exports_fraction = NULL
asbestos_1970only_Czechoslovakia$Apparent_consumption_fraction = NULL
asbestos_1970only_Czechoslovakia
#      Country_Name Production  Imports Exports Apparent_consumption
# 40 Czech Republic          0 25820.07       0             26011.33
# 60       Slovakia          0 13196.93       0             13005.67

# Split 1970 Yugoslavia asbestos consumption by 1998 consumption because that is the first year where we have asbestos data by country.
asbestos_1970only_Yugoslavia = asbestos_1998_Yugoslavia
asbestos_1970only_Yugoslavia$Production = asbestos_1970only_before_splitting_and_merging_countries[(asbestos_1970only_before_splitting_and_merging_countries$Country_Name=="Yugoslavia"), c("Production")]
asbestos_1970only_Yugoslavia$Imports = asbestos_1970only_before_splitting_and_merging_countries[(asbestos_1970only_before_splitting_and_merging_countries$Country_Name=="Yugoslavia"), c("Imports")]
asbestos_1970only_Yugoslavia$Exports = asbestos_1970only_before_splitting_and_merging_countries[(asbestos_1970only_before_splitting_and_merging_countries$Country_Name=="Yugoslavia"), c("Exports")]
asbestos_1970only_Yugoslavia$Apparent_consumption = asbestos_1970only_before_splitting_and_merging_countries[(asbestos_1970only_before_splitting_and_merging_countries$Country_Name=="Yugoslavia"), c("Apparent_consumption")]
asbestos_1970only_Yugoslavia$Production = asbestos_1970only_Yugoslavia$Production * asbestos_1970only_Yugoslavia$Production_fraction
asbestos_1970only_Yugoslavia$Imports = asbestos_1970only_Yugoslavia$Imports * asbestos_1970only_Yugoslavia$Imports_fraction
asbestos_1970only_Yugoslavia$Exports = asbestos_1970only_Yugoslavia$Exports * asbestos_1970only_Yugoslavia$Exports_fraction
asbestos_1970only_Yugoslavia$Apparent_consumption = asbestos_1970only_Yugoslavia$Apparent_consumption * asbestos_1970only_Yugoslavia$Apparent_consumption_fraction
asbestos_1970only_Yugoslavia$Production_fraction = NULL
asbestos_1970only_Yugoslavia$Imports_fraction = NULL
asbestos_1970only_Yugoslavia$Exports_fraction = NULL
asbestos_1970only_Yugoslavia$Apparent_consumption_fraction = NULL
asbestos_1970only_Yugoslavia
#                 Country_Name Production    Imports Exports Apparent_consumption
# 60    Bosnia and Herzegovina      0.000   121.4979       0             128.1198
# 62                   Croatia      0.000  9598.3319    4666            9993.3480
# 81                    Serbia   7761.821     0.0000       0            3854.2720
# 83                  Slovenia      0.000 17060.3262       0           17990.1617
# temp1             Montenegro   4343.179  1285.8525       0            3512.6191
# temp2        North Macedonia      0.000   485.9915       0             512.4794

# Split 1970 Belgium_and_Luxembourg asbestos consumption by 1970 population proportions because in data upto 2003 we never have asbestos consumption data by country.
asbestos_1970only_Belgium_and_Luxembourg = pop_1970_Belgium_and_Luxembourg
asbestos_1970only_Belgium_and_Luxembourg$Production = asbestos_1970only_before_splitting_and_merging_countries[(asbestos_1970only_before_splitting_and_merging_countries$Country_Name=="Belgium and Luxembourg"), c("Production")]
asbestos_1970only_Belgium_and_Luxembourg$Imports = asbestos_1970only_before_splitting_and_merging_countries[(asbestos_1970only_before_splitting_and_merging_countries$Country_Name=="Belgium and Luxembourg"), c("Imports")]
asbestos_1970only_Belgium_and_Luxembourg$Exports = asbestos_1970only_before_splitting_and_merging_countries[(asbestos_1970only_before_splitting_and_merging_countries$Country_Name=="Belgium and Luxembourg"), c("Exports")]
asbestos_1970only_Belgium_and_Luxembourg$Apparent_consumption = asbestos_1970only_before_splitting_and_merging_countries[(asbestos_1970only_before_splitting_and_merging_countries$Country_Name=="Belgium and Luxembourg"), c("Apparent_consumption")]
asbestos_1970only_Belgium_and_Luxembourg$Production = asbestos_1970only_Belgium_and_Luxembourg$Production * asbestos_1970only_Belgium_and_Luxembourg$pop_fraction
asbestos_1970only_Belgium_and_Luxembourg$Imports = asbestos_1970only_Belgium_and_Luxembourg$Imports * asbestos_1970only_Belgium_and_Luxembourg$pop_fraction
asbestos_1970only_Belgium_and_Luxembourg$Exports = asbestos_1970only_Belgium_and_Luxembourg$Exports * asbestos_1970only_Belgium_and_Luxembourg$pop_fraction
asbestos_1970only_Belgium_and_Luxembourg$Apparent_consumption = asbestos_1970only_Belgium_and_Luxembourg$Apparent_consumption * asbestos_1970only_Belgium_and_Luxembourg$pop_fraction
asbestos_1970only_Belgium_and_Luxembourg$Year = NULL
asbestos_1970only_Belgium_and_Luxembourg$population = NULL
asbestos_1970only_Belgium_and_Luxembourg$pop_fraction = NULL
asbestos_1970only_Belgium_and_Luxembourg
#      Country_Name Production   Imports   Exports Apparent_consumption
# 6056      Belgium          0 52969.239 920.50702            52048.732
# 6060   Luxembourg          0  1869.761  32.49298             1837.268

asbestos_1970only_minus_adjusted_countries = asbestos_1970only_before_splitting_and_merging_countries[(!(asbestos_1970only_before_splitting_and_merging_countries$Country_Name %in% c("Germany, East", "Germany, West", "Soviet Union", "Yugoslavia", "Czechoslovakia", "Belgium and Luxembourg"))),]

asbestos_1970only = rbind(asbestos_1970only_minus_adjusted_countries, asbestos_1970only_Germany_sum, asbestos_1970only_USSR, asbestos_1970only_Yugoslavia, asbestos_1970only_Czechoslovakia, asbestos_1970only_Belgium_and_Luxembourg)

asbestos_1970only$Country_Name[(!(asbestos_1970only$Country_Name %in% country_codes$Country_Name))]

PC_asbestos_1970only = merge( x=asbestos_1970only, y=pop_1970, by=c("Country_Name"), all.x=TRUE, all.y=FALSE )

PC_asbestos_1970only[is.na(PC_asbestos_1970only$population),c("Country_Name")] # no asbestos data are missing population data

PC_asbestos_1970only = merge( x=asbestos_1970only, y=pop_1970, by=c("Country_Name"), all.x=FALSE, all.y=FALSE )

PC_asbestos_1970only$PC_asbestos_kg = PC_asbestos_1970only$Apparent_consumption * 1000 / PC_asbestos_1970only$population # 1 metric tonne = 1000 kg


#####
asbestos_1980only = read.table( "USGS_asbestos_consumption_1980.txt", sep="\t", header=TRUE, quote='"', comment.char="", row.names=NULL, stringsAsFactors=FALSE, colClasses=c("character") )
asbestos_1980only[(asbestos_1980only=="-")] = 0
asbestos_1980only[is.na(asbestos_1980only)] = 0
asbestos_1980only$Production = as.numeric(as.character(asbestos_1980only$Production))
asbestos_1980only$Imports = as.numeric(as.character(asbestos_1980only$Imports))
asbestos_1980only$Exports = as.numeric(as.character(asbestos_1980only$Exports))
asbestos_1980only$Apparent_consumption = as.numeric(as.character(asbestos_1980only$Apparent_consumption))

asbestos_1980only$Country_Name[(!(asbestos_1980only$Country_Name %in% country_codes$Country_Name))]
asbestos_1980only$Country_Name = ifelse( (asbestos_1980only$Country_Name=="Libya"), "Libyan Arab Jamahiriya", asbestos_1980only$Country_Name )
asbestos_1980only$Country_Name = ifelse( (asbestos_1980only$Country_Name=="Southern Rhodesia"), "Zimbabwe", asbestos_1980only$Country_Name )
asbestos_1980only$Country_Name = ifelse( (asbestos_1980only$Country_Name=="Swaziland"), "Eswatini", asbestos_1980only$Country_Name )
asbestos_1980only$Country_Name = ifelse( (asbestos_1980only$Country_Name=="Zaire"), "Democratic Republic of the Congo", asbestos_1980only$Country_Name )
asbestos_1980only$Country_Name = ifelse( (asbestos_1980only$Country_Name=="Hong Kong"), "Hong Kong SAR", asbestos_1980only$Country_Name )
asbestos_1980only$Country_Name = ifelse( (asbestos_1980only$Country_Name=="Iran"), "Iran (Islamic Republic of)", asbestos_1980only$Country_Name )
asbestos_1980only$Country_Name = ifelse( (asbestos_1980only$Country_Name=="Korea, North"), "Democratic Peoples's Republic of Korea", asbestos_1980only$Country_Name )
asbestos_1980only$Country_Name = ifelse( (asbestos_1980only$Country_Name=="Korea, Republic of"), "Republic of Korea", asbestos_1980only$Country_Name )
asbestos_1980only$Country_Name = ifelse( (asbestos_1980only$Country_Name=="Syria"), "Syrian Arab Republic", asbestos_1980only$Country_Name )
asbestos_1980only$Country_Name = ifelse( (asbestos_1980only$Country_Name=="Taiwan"), "China: Province of Taiwan only", asbestos_1980only$Country_Name )
asbestos_1980only$Country_Name = ifelse( (asbestos_1980only$Country_Name=="United States"), "United States of America", asbestos_1980only$Country_Name )
asbestos_1980only$Country_Name = ifelse( (asbestos_1980only$Country_Name=="Burma"), "Myanmar", asbestos_1980only$Country_Name )
asbestos_1980only$Country_Name[(!(asbestos_1980only$Country_Name %in% country_codes$Country_Name))]

# Apparent_consumption is negative in the sampled case in a few cases,
# and this is assumed to not reflect annual consumption for the preceding and following 5 years.
# In those cases, take the average of the preceding and following periods for that country.

asbestos_1980only[asbestos_1980only$Apparent_consumption<0,]
#    Country_Name Production Imports Exports Apparent_consumption
# 10 South Africa     277734   19518  381000               -83748
# 11     Zimbabwe     250949       0  274258               -23309

# South Africa 1975 apparent_consumption = 15270
# South Africa 1980 apparent_consumption = -83748 # This negative consumption is assumed to be an anomaly. Thus average of 1975 and 1985 is a better reflection of true consumption.
# South Africa 1985 apparent_consumption = 30504
(15270+30504)/2 # = 22887
asbestos_1980only$Apparent_consumption = ifelse( (asbestos_1980only$Country_Name == "South Africa"), 22887, asbestos_1980only$Apparent_consumption )

# Zimbabwe 1975 apparent_consumption = 1542
# Zimbabwe 1980 apparent_consumption = -23309 # This negative consumption is assumed to be an anomaly. Thus average of 1975 and 1985 is a better reflection of true consumption.
# Zimbabwe 1985 apparent_consumption = 14867
(1542+14867)/2 # = 8204.5
asbestos_1980only$Apparent_consumption = ifelse( (asbestos_1980only$Country_Name == "Zimbabwe"), 8204.5, asbestos_1980only$Apparent_consumption )

asbestos_1980only_before_splitting_and_merging_countries = asbestos_1980only

asbestos_1980only_Germany = asbestos_1980only[(asbestos_1980only$Country_Name %in% c("Germany, East", "Germany, West")),]
asbestos_1980only_Germany_sum = sqldf("select 'Germany', sum(Production), sum(Imports), sum(Exports), sum(Apparent_consumption) from asbestos_1980only_Germany")
colnames(asbestos_1980only_Germany_sum) = colnames(asbestos_1980only)
asbestos_1980only_Germany
#     Country_Name Production Imports Exports Apparent_consumption
# 57 Germany, East          0   74400       0                74400
# 58 Germany, West          0  392978   27333               365645

# Split 1980 USSR asbestos consumption by 1995 consumption because that is the first year where we have asbestos figures by country.
asbestos_1980only_USSR = asbestos_1995_USSR
asbestos_1980only_USSR$Production = asbestos_1980only_before_splitting_and_merging_countries[(asbestos_1980only_before_splitting_and_merging_countries$Country_Name=="Soviet Union"), c("Production")]
asbestos_1980only_USSR$Imports = asbestos_1980only_before_splitting_and_merging_countries[(asbestos_1980only_before_splitting_and_merging_countries$Country_Name=="Soviet Union"), c("Imports")]
asbestos_1980only_USSR$Exports = asbestos_1980only_before_splitting_and_merging_countries[(asbestos_1980only_before_splitting_and_merging_countries$Country_Name=="Soviet Union"), c("Exports")]
asbestos_1980only_USSR$Apparent_consumption = asbestos_1980only_before_splitting_and_merging_countries[(asbestos_1980only_before_splitting_and_merging_countries$Country_Name=="Soviet Union"), c("Apparent_consumption")]
asbestos_1980only_USSR$Production = asbestos_1980only_USSR$Production * asbestos_1980only_USSR$Production_fraction
asbestos_1980only_USSR$Imports = asbestos_1980only_USSR$Imports * asbestos_1980only_USSR$Imports_fraction
asbestos_1980only_USSR$Exports = asbestos_1980only_USSR$Exports * asbestos_1980only_USSR$Exports_fraction
asbestos_1980only_USSR$Apparent_consumption = asbestos_1980only_USSR$Apparent_consumption * asbestos_1980only_USSR$Apparent_consumption_fraction
asbestos_1980only_USSR$Production_fraction = NULL
asbestos_1980only_USSR$Imports_fraction = NULL
asbestos_1980only_USSR$Exports_fraction = NULL
asbestos_1980only_USSR$Apparent_consumption_fraction = NULL
asbestos_1980only_USSR
#           Country_Name Production Imports    Exports Apparent_consumption
# 42             Estonia        0.0       0  26166.014            1032.8604
# 49          Kazakhstan   393597.3       0 334132.794           93843.6320
# 50          Kyrgyzstan        0.0       0   2296.077           22004.0584
# 51              Latvia        0.0       0      0.000            4602.4260
# 52           Lithuania        0.0       0  14978.067             882.0628
# 54 Republic of Moldova        0.0       0      0.000            5784.0183
# 58  Russian Federation  1676402.7       0 222427.047         1341850.9421

# Split 1980 Czechoslovakia asbestos consumption by 1995 consumption because that is the first year where we have asbestos data by country.
asbestos_1980only_Czechoslovakia = asbestos_1995_Czechoslovakia
asbestos_1980only_Czechoslovakia$Production = asbestos_1980only_before_splitting_and_merging_countries[(asbestos_1980only_before_splitting_and_merging_countries$Country_Name=="Czechoslovakia"), c("Production")]
asbestos_1980only_Czechoslovakia$Imports = asbestos_1980only_before_splitting_and_merging_countries[(asbestos_1980only_before_splitting_and_merging_countries$Country_Name=="Czechoslovakia"), c("Imports")]
asbestos_1980only_Czechoslovakia$Exports = asbestos_1980only_before_splitting_and_merging_countries[(asbestos_1980only_before_splitting_and_merging_countries$Country_Name=="Czechoslovakia"), c("Exports")]
asbestos_1980only_Czechoslovakia$Apparent_consumption = asbestos_1980only_before_splitting_and_merging_countries[(asbestos_1980only_before_splitting_and_merging_countries$Country_Name=="Czechoslovakia"), c("Apparent_consumption")]
asbestos_1980only_Czechoslovakia$Production = asbestos_1980only_Czechoslovakia$Production * asbestos_1980only_Czechoslovakia$Production_fraction
asbestos_1980only_Czechoslovakia$Imports = asbestos_1980only_Czechoslovakia$Imports * asbestos_1980only_Czechoslovakia$Imports_fraction
asbestos_1980only_Czechoslovakia$Exports = asbestos_1980only_Czechoslovakia$Exports * asbestos_1980only_Czechoslovakia$Exports_fraction
asbestos_1980only_Czechoslovakia$Apparent_consumption = asbestos_1980only_Czechoslovakia$Apparent_consumption * asbestos_1980only_Czechoslovakia$Apparent_consumption_fraction
asbestos_1980only_Czechoslovakia$Production_fraction = NULL
asbestos_1980only_Czechoslovakia$Imports_fraction = NULL
asbestos_1980only_Czechoslovakia$Exports_fraction = NULL
asbestos_1980only_Czechoslovakia$Apparent_consumption_fraction = NULL
asbestos_1980only_Czechoslovakia
#      Country_Name Production  Imports Exports Apparent_consumption
# 40 Czech Republic          0 30571.54       0             31209.33
# 60       Slovakia          0 15625.46       0             15604.67

# Split 1980 Yugoslavia asbestos consumption by 1998 consumption because that is the first year where we have asbestos data by country.
asbestos_1980only_Yugoslavia = asbestos_1998_Yugoslavia
asbestos_1980only_Yugoslavia$Production = asbestos_1980only_before_splitting_and_merging_countries[(asbestos_1980only_before_splitting_and_merging_countries$Country_Name=="Yugoslavia"), c("Production")]
asbestos_1980only_Yugoslavia$Imports = asbestos_1980only_before_splitting_and_merging_countries[(asbestos_1980only_before_splitting_and_merging_countries$Country_Name=="Yugoslavia"), c("Imports")]
asbestos_1980only_Yugoslavia$Exports = asbestos_1980only_before_splitting_and_merging_countries[(asbestos_1980only_before_splitting_and_merging_countries$Country_Name=="Yugoslavia"), c("Exports")]
asbestos_1980only_Yugoslavia$Apparent_consumption = asbestos_1980only_before_splitting_and_merging_countries[(asbestos_1980only_before_splitting_and_merging_countries$Country_Name=="Yugoslavia"), c("Apparent_consumption")]
asbestos_1980only_Yugoslavia$Production = asbestos_1980only_Yugoslavia$Production * asbestos_1980only_Yugoslavia$Production_fraction
asbestos_1980only_Yugoslavia$Imports = asbestos_1980only_Yugoslavia$Imports * asbestos_1980only_Yugoslavia$Imports_fraction
asbestos_1980only_Yugoslavia$Exports = asbestos_1980only_Yugoslavia$Exports * asbestos_1980only_Yugoslavia$Exports_fraction
asbestos_1980only_Yugoslavia$Apparent_consumption = asbestos_1980only_Yugoslavia$Apparent_consumption * asbestos_1980only_Yugoslavia$Apparent_consumption_fraction
asbestos_1980only_Yugoslavia$Production_fraction = NULL
asbestos_1980only_Yugoslavia$Imports_fraction = NULL
asbestos_1980only_Yugoslavia$Exports_fraction = NULL
asbestos_1980only_Yugoslavia$Apparent_consumption_fraction = NULL
asbestos_1980only_Yugoslavia
#                 Country_Name Production   Imports Exports Apparent_consumption
# 60    Bosnia and Herzegovina      0.000   255.417       0             242.0113
# 62                   Croatia      0.000 20177.945    2506           18876.8793
# 81                    Serbia   6712.163     0.000       0            7280.5058
# 83                  Slovenia      0.000 35864.807       0           33982.4162
# temp1             Montenegro   3755.837  2703.163       0            6635.1424
# temp2        North Macedonia      0.000  1021.668       0             968.0451

# Split 1980 Belgium_and_Luxembourg asbestos consumption by 1980 population proportions because in data upto 2003 we never have asbestos consumption data by country.
asbestos_1980only_Belgium_and_Luxembourg = pop_1980_Belgium_and_Luxembourg
asbestos_1980only_Belgium_and_Luxembourg$Production = asbestos_1980only_before_splitting_and_merging_countries[(asbestos_1980only_before_splitting_and_merging_countries$Country_Name=="Belgium and Luxembourg"), c("Production")]
asbestos_1980only_Belgium_and_Luxembourg$Imports = asbestos_1980only_before_splitting_and_merging_countries[(asbestos_1980only_before_splitting_and_merging_countries$Country_Name=="Belgium and Luxembourg"), c("Imports")]
asbestos_1980only_Belgium_and_Luxembourg$Exports = asbestos_1980only_before_splitting_and_merging_countries[(asbestos_1980only_before_splitting_and_merging_countries$Country_Name=="Belgium and Luxembourg"), c("Exports")]
asbestos_1980only_Belgium_and_Luxembourg$Apparent_consumption = asbestos_1980only_before_splitting_and_merging_countries[(asbestos_1980only_before_splitting_and_merging_countries$Country_Name=="Belgium and Luxembourg"), c("Apparent_consumption")]
asbestos_1980only_Belgium_and_Luxembourg$Production = asbestos_1980only_Belgium_and_Luxembourg$Production * asbestos_1980only_Belgium_and_Luxembourg$pop_fraction
asbestos_1980only_Belgium_and_Luxembourg$Imports = asbestos_1980only_Belgium_and_Luxembourg$Imports * asbestos_1980only_Belgium_and_Luxembourg$pop_fraction
asbestos_1980only_Belgium_and_Luxembourg$Exports = asbestos_1980only_Belgium_and_Luxembourg$Exports * asbestos_1980only_Belgium_and_Luxembourg$pop_fraction
asbestos_1980only_Belgium_and_Luxembourg$Apparent_consumption = asbestos_1980only_Belgium_and_Luxembourg$Apparent_consumption * asbestos_1980only_Belgium_and_Luxembourg$pop_fraction
asbestos_1980only_Belgium_and_Luxembourg$Year = NULL
asbestos_1980only_Belgium_and_Luxembourg$population = NULL
asbestos_1980only_Belgium_and_Luxembourg$pop_fraction = NULL
asbestos_1980only_Belgium_and_Luxembourg
#      Country_Name Production   Imports   Exports Apparent_consumption
# 8946      Belgium          0 46176.851 54.972442            46121.879
# 8950   Luxembourg          0  1703.149  2.027558             1701.121

asbestos_1980only_minus_adjusted_countries = asbestos_1980only_before_splitting_and_merging_countries[(!(asbestos_1980only_before_splitting_and_merging_countries$Country_Name %in% c("Germany, East", "Germany, West", "Soviet Union", "Yugoslavia", "Czechoslovakia", "Belgium and Luxembourg"))),]

asbestos_1980only = rbind(asbestos_1980only_minus_adjusted_countries, asbestos_1980only_Germany_sum, asbestos_1980only_USSR, asbestos_1980only_Yugoslavia, asbestos_1980only_Czechoslovakia, asbestos_1980only_Belgium_and_Luxembourg)

asbestos_1980only$Country_Name[(!(asbestos_1980only$Country_Name %in% country_codes$Country_Name))]

PC_asbestos_1980only = merge( x=asbestos_1980only, y=pop_1980, by=c("Country_Name"), all.x=TRUE, all.y=FALSE )

PC_asbestos_1980only[is.na(PC_asbestos_1980only$population),c("Country_Name")]
# [1] "Canary Islands" # We don't have population for Canary Islands
PC_asbestos_1980only[(PC_asbestos_1980only$Country_Name=="Canary Islands"),] # Canary Islands data is inconsequential in not included
#      Country_Name Production Imports Exports Apparent_consumption Year population
# 12 Canary Islands          0     131       0                  131   NA         NA

PC_asbestos_1980only = merge( x=asbestos_1980only, y=pop_1980, by=c("Country_Name"), all.x=FALSE, all.y=FALSE )

PC_asbestos_1980only$PC_asbestos_kg = PC_asbestos_1980only$Apparent_consumption * 1000 / PC_asbestos_1980only$population # 1 metric tonne = 1000 kg


#####
# Calculate 1975 asbestos consumption as the average of 1970, 1975, and 1980

m1 = merge( x=PC_asbestos_1970only, y=PC_asbestos_1975only, by=c("Country_Name"), all.x=TRUE, all.y=TRUE )
m2 = merge( x=m1, y=PC_asbestos_1980only, by=c("Country_Name"), all.x=TRUE, all.y=TRUE )

names(m2)[names(m2) == 'Production'] = 'Production.z'
names(m2)[names(m2) == 'Imports'] = 'Imports.z'
names(m2)[names(m2) == 'Exports'] = 'Exports.z'
names(m2)[names(m2) == 'Apparent_consumption'] = 'Apparent_consumption.z'
names(m2)[names(m2) == 'Year'] = 'Year.z'
names(m2)[names(m2) == 'population'] = 'population.z'
names(m2)[names(m2) == 'PC_asbestos_kg'] = 'PC_asbestos_kg.z'

PC_asbestos_1975avg = m2

PC_asbestos_1975avg[(is.na(PC_asbestos_1975avg$Apparent_consumption.x)) | (is.na(PC_asbestos_1975avg$Apparent_consumption.y)) | (is.na(PC_asbestos_1975avg$Apparent_consumption.z)),]

# For countries having data in one but not all of 1970, 1975 and 1980, the absent data will be assumed to be zero.
PC_asbestos_1975avg[is.na(PC_asbestos_1975avg)] = 0

PC_asbestos_1975avg$Production = apply(PC_asbestos_1975avg[,c("Production.x","Production.y","Production.z")], 1, mean, na.rm=FALSE)
PC_asbestos_1975avg$Imports = apply(PC_asbestos_1975avg[,c("Imports.x","Imports.y","Imports.z")], 1, mean, na.rm=FALSE)
PC_asbestos_1975avg$Exports = apply(PC_asbestos_1975avg[,c("Exports.x","Exports.y","Exports.z")], 1, mean, na.rm=FALSE)
PC_asbestos_1975avg$Apparent_consumption = apply(PC_asbestos_1975avg[,c("Apparent_consumption.x","Apparent_consumption.y","Apparent_consumption.z")], 1, mean, na.rm=FALSE)

PC_asbestos_1975avg$Production.x = NULL
PC_asbestos_1975avg$Imports.x = NULL
PC_asbestos_1975avg$Exports.x = NULL
PC_asbestos_1975avg$Apparent_consumption.x = NULL
PC_asbestos_1975avg$Year.x = NULL
PC_asbestos_1975avg$population.x = NULL
PC_asbestos_1975avg$PC_asbestos_kg.x = NULL
PC_asbestos_1975avg$Production.y = NULL
PC_asbestos_1975avg$Imports.y = NULL
PC_asbestos_1975avg$Exports.y = NULL
PC_asbestos_1975avg$Apparent_consumption.y = NULL
PC_asbestos_1975avg$Year.y = NULL
PC_asbestos_1975avg$population.y = NULL
PC_asbestos_1975avg$PC_asbestos_kg.y = NULL
PC_asbestos_1975avg$Production.z = NULL
PC_asbestos_1975avg$Imports.z = NULL
PC_asbestos_1975avg$Exports.z = NULL
PC_asbestos_1975avg$Apparent_consumption.z = NULL
PC_asbestos_1975avg$Year.z = NULL
PC_asbestos_1975avg$population.z = NULL
PC_asbestos_1975avg$PC_asbestos_kg.z = NULL
new_PC_asbestos_1975avg = merge( x=PC_asbestos_1975avg, y=pop_1975, by=c("Country_Name"), all.x=TRUE, all.y=FALSE )
PC_asbestos_1975avg = new_PC_asbestos_1975avg
rm(new_PC_asbestos_1975avg)

PC_asbestos_1975avg$PC_asbestos_kg = PC_asbestos_1975avg$Apparent_consumption * 1000 / PC_asbestos_1975avg$population # 1 metric tonne = 1000 kg


#####

mort1 = mort[((mort$Year>=2010) & (mort$Year<=2014)),]

# Some years for some countries do not have data for some age ranges. Need to aggregate those to an age group that does have data
# Remove those super-aggregations when not needed when the sub-age-ranges data does exist.

mort1$deaths_0_4 = apply( mort1[,c("deaths_0", "deaths_1", "deaths_2", "deaths_3", "deaths_4")], 1, sum, na.rm=TRUE )
mort1$deaths_0_14 = apply( mort1[,c("deaths_0", "deaths_1", "deaths_2", "deaths_3", "deaths_4", "deaths_5_9", "deaths_10_14")], 1, sum, na.rm=TRUE )
mort1$deaths_75_and_above = apply( mort1[,c("deaths_75_79", "deaths_80_84", "deaths_85_89", "deaths_90_94", "deaths_95_and_above")], 1, sum, na.rm=TRUE )
mort1$deaths_85_and_above = apply( mort1[,c("deaths_85_89", "deaths_90_94", "deaths_95_and_above")], 1, sum, na.rm=TRUE )
mort1[is.na(mort1)] = -1
mort1$deaths_0_14 = ifelse( ((mort1$deaths_0!=-1)&(mort1$deaths_1!=-1)&(mort1$deaths_2!=-1)&(mort1$deaths_3!=-1)&(mort1$deaths_4!=-1)&(mort1$deaths_5_9!=-1)), -1, mort1$deaths_0_14 )
mort1$deaths_75_and_above = ifelse( ((mort1$deaths_80_84!=-1)&(mort1$deaths_85_89!=-1)&(mort1$deaths_90_94!=-1)&(mort1$deaths_95_and_above!=-1)), -1, mort1$deaths_75_and_above )
mort1$deaths_85_and_above = ifelse( ((mort1$deaths_90_94!=-1)&(mort1$deaths_95_and_above!=-1)), -1, mort1$deaths_85_and_above )

mort2 = mort1[,c("Country_Name", "Year", "Cause", "icd10_3digit_code", "Sex", "deaths_0_4", "deaths_5_9", "deaths_10_14", "deaths_0_14", "deaths_15_19", "deaths_20_24", "deaths_25_29", "deaths_30_34", "deaths_35_39", "deaths_40_44", "deaths_45_49", "deaths_50_54", "deaths_55_59", "deaths_60_64", "deaths_65_69", "deaths_70_74", "deaths_75_79", "deaths_80_84", "deaths_85_89", "deaths_90_94", "deaths_75_and_above", "deaths_85_and_above", "deaths_95_and_above" )]

mort3 = melt(mort2, id.vars=c("Country_Name", "Year", "Cause", "icd10_3digit_code", "Sex"))
names(mort3)[names(mort3)=="variable"] = "age_group"
names(mort3)[names(mort3)=="value"] = "deaths"
mort3$age_group = as.character(mort3$age_group)
mort3$deaths = as.numeric(as.character(mort3$deaths))

mort3$age_group = ifelse( (mort3$age_group=="deaths_0_4"), "age_0_to_4", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_5_9"), "age_5_to_9", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_10_14"), "age_10_to_14", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_0_14"), "age_0_to_14", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_15_19"), "age_15_to_19", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_20_24"), "age_20_to_24", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_25_29"), "age_25_to_29", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_30_34"), "age_30_to_34", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_35_39"), "age_35_to_39", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_40_44"), "age_40_to_44", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_45_49"), "age_45_to_49", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_50_54"), "age_50_to_54", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_55_59"), "age_55_to_59", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_60_64"), "age_60_to_64", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_65_69"), "age_65_to_69", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_70_74"), "age_70_to_74", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_75_79"), "age_75_to_79", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_80_84"), "age_80_to_84", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_85_89"), "age_85_to_89", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_90_94"), "age_90_to_94", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_75_and_above"), "age_75_plus", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_85_and_above"), "age_85_plus", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_95_and_above"), "age_95_plus", mort3$age_group )

mort4 = merge( x=mort3, y=country_codes_3char, by=c("Country_Name"), all.x=TRUE, all.y=FALSE )

mort_2010_to_2014_C45_J61 = mort4

rm(mort1, mort2, mort3, mort4)

### verifications
sqldf('select Country_Name, Cause, Sex, sum(deaths) from mort_2010_to_2014_C45_J61 where Sex=1 and Cause is not "J61" group by Country_Name, Cause, Sex')
mort_2010_to_2014_C45_J61[((mort_2010_to_2014_C45_J61$Sex==1)&(mort_2010_to_2014_C45_J61$Cause!="J61")),]


#####

mort1 = mort[((mort$Year>=2000) & (mort$Year<=2004)),]

# Some years for some countries do not have data for some age ranges. Need to aggregate those to an age group that does have data
# Remove those super-aggregations when not needed when the sub-age-ranges data does exist.

mort1$deaths_0_4 = apply( mort1[,c("deaths_0", "deaths_1", "deaths_2", "deaths_3", "deaths_4")], 1, sum, na.rm=TRUE )
mort1$deaths_0_14 = apply( mort1[,c("deaths_0", "deaths_1", "deaths_2", "deaths_3", "deaths_4", "deaths_5_9", "deaths_10_14")], 1, sum, na.rm=TRUE )
mort1$deaths_75_and_above = apply( mort1[,c("deaths_75_79", "deaths_80_84", "deaths_85_89", "deaths_90_94", "deaths_95_and_above")], 1, sum, na.rm=TRUE )
mort1$deaths_85_and_above = apply( mort1[,c("deaths_85_89", "deaths_90_94", "deaths_95_and_above")], 1, sum, na.rm=TRUE )
mort1[is.na(mort1)] = -1
mort1$deaths_0_14 = ifelse( ((mort1$deaths_0!=-1)&(mort1$deaths_1!=-1)&(mort1$deaths_2!=-1)&(mort1$deaths_3!=-1)&(mort1$deaths_4!=-1)&(mort1$deaths_5_9!=-1)), -1, mort1$deaths_0_14 )
mort1$deaths_75_and_above = ifelse( ((mort1$deaths_80_84!=-1)&(mort1$deaths_85_89!=-1)&(mort1$deaths_90_94!=-1)&(mort1$deaths_95_and_above!=-1)), -1, mort1$deaths_75_and_above )
mort1$deaths_85_and_above = ifelse( ((mort1$deaths_90_94!=-1)&(mort1$deaths_95_and_above!=-1)), -1, mort1$deaths_85_and_above )

mort2 = mort1[,c("Country_Name", "Year", "Cause", "icd10_3digit_code", "Sex", "deaths_0_4", "deaths_5_9", "deaths_10_14", "deaths_0_14", "deaths_15_19", "deaths_20_24", "deaths_25_29", "deaths_30_34", "deaths_35_39", "deaths_40_44", "deaths_45_49", "deaths_50_54", "deaths_55_59", "deaths_60_64", "deaths_65_69", "deaths_70_74", "deaths_75_79", "deaths_80_84", "deaths_85_89", "deaths_90_94", "deaths_75_and_above", "deaths_85_and_above", "deaths_95_and_above" )]

mort3 = melt(mort2, id.vars=c("Country_Name", "Year", "Cause", "icd10_3digit_code", "Sex"))
names(mort3)[names(mort3)=="variable"] = "age_group"
names(mort3)[names(mort3)=="value"] = "deaths"
mort3$age_group = as.character(mort3$age_group)
mort3$deaths = as.numeric(as.character(mort3$deaths))

mort3$age_group = ifelse( (mort3$age_group=="deaths_0_4"), "age_0_to_4", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_5_9"), "age_5_to_9", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_10_14"), "age_10_to_14", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_0_14"), "age_0_to_14", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_15_19"), "age_15_to_19", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_20_24"), "age_20_to_24", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_25_29"), "age_25_to_29", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_30_34"), "age_30_to_34", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_35_39"), "age_35_to_39", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_40_44"), "age_40_to_44", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_45_49"), "age_45_to_49", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_50_54"), "age_50_to_54", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_55_59"), "age_55_to_59", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_60_64"), "age_60_to_64", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_65_69"), "age_65_to_69", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_70_74"), "age_70_to_74", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_75_79"), "age_75_to_79", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_80_84"), "age_80_to_84", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_85_89"), "age_85_to_89", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_90_94"), "age_90_to_94", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_75_and_above"), "age_75_plus", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_85_and_above"), "age_85_plus", mort3$age_group )
mort3$age_group = ifelse( (mort3$age_group=="deaths_95_and_above"), "age_95_plus", mort3$age_group )

mort4 = merge( x=mort3, y=country_codes_3char, by=c("Country_Name"), all.x=TRUE, all.y=FALSE )

mort_2000_to_2004_C45_J61 = mort4

rm(mort1, mort2, mort3, mort4)


##########
##### Analysis for males mesothelioma C45 deaths 2010-2014 vs average asbestos 1975 (avg 1970,1975,1980), with Slovenia

mort1 = mort_2010_to_2014_C45_J61[((mort_2010_to_2014_C45_J61$icd10_3digit_code=="C45") & (mort_2010_to_2014_C45_J61$Sex==1) & (mort_2010_to_2014_C45_J61$deaths>0)),]
pop1 = pop_males_by_age_with_extra_countries

unique(mort1$Country_Name[(!(mort1$Country_Name %in% pop1$Country_Name))])

mort2 = merge( x=mort1, y=pop1, by=c("Country_Name", "Year", "age_group"), x.all=TRUE, y.all=FALSE )

mort2b = sqldf("select Country_Name, Country_3char, Year, age_group, sum(deaths), max(population) from mort2 where population > 0 group by Country_Name, Country_3char, Year, age_group")
colnames(mort2b) = c("Country_Name", "Country_3char", "Year", "age_group", "deaths", "population")
mort2b$death_rate_per_million = mort2b$deaths * 1000000 / mort2b$population

mort3 = merge( x=mort2b, y=std_pop, by=c("age_group"), x.all=TRUE, y.all=FALSE )
mort3$adjusted_death_rate_per_million = mort3$death_rate_per_million * mort3$WHO_World_Standard_rate

mort4 = sqldf('select Country_Name, Country_3char, Year, sum(adjusted_death_rate_per_million) from mort3 group by Country_Name, Country_3char, Year')
names(mort4)[names(mort4)=="sum(adjusted_death_rate_per_million)"] = "AAMR_per_million"

mort6 = sqldf('select Country_Name, Country_3char, avg(AAMR_per_million) from mort4 group by Country_Name, Country_3char')
names(mort6)[names(mort6)=="avg(AAMR_per_million)"] = "AAMR_per_million"

mort6$Country_Name[(!(mort6$Country_Name %in% PC_asbestos_1975avg$Country_Name))]
PC_asbestos_1975avg$Country_Name[(!(PC_asbestos_1975avg$Country_Name %in% mort6$Country_Name))]

mort_asb1 = merge( x=mort6, y=PC_asbestos_1975avg, by=c("Country_Name"), all.x=FALSE, all.y=FALSE )
mort_asb1$Production = NULL
mort_asb1$Imports = NULL
mort_asb1$Exports = NULL
mort_asb1$Apparent_consumption = NULL
mort_asb1$Year = NULL
mort_asb1$AAMR_per_million_log10 = log10(mort_asb1$AAMR_per_million)

pop2 = pop_males[(pop_males$Year==1975),]

mort_asb3 = merge( x=mort_asb1, y=pop2, by=c("Country_Name"), all.x=TRUE, all.y=FALSE )

mortasb = mort_asb3

# nudge the country text on the plot
min_population = min(mortasb$population)
max_population = max(mortasb$population)
nudge_x_slope_m = (0.10 - 0.6) / (max_population - min_population)
nudge_x_intercept_b = 0.6 - nudge_x_slope_m * min_population
mortasb$nudge_x = 1 * (mortasb$population * nudge_x_slope_m + nudge_x_intercept_b)
mortasb$nudge_y = 0

#mortasb$nudge_x = ifelse( (mortasb$Country_3char=="NLD"), 0.2, mortasb$nudge_x )
#mortasb$nudge_y = ifelse( (mortasb$Country_3char=="TUN"), 0.01, mortasb$nudge_y )
#mortasb[,c("Country_Name", "Country_3char", "population", "AAMR_per_million", "nudge_x", "nudge_y")]

data_for_plot = mortasb
data_for_plot$nudge_x = NULL
data_for_plot$nudge_y = NULL

C45_males_AAMR_2010_2014_asbestos_avg1975_with_Slovenia = data_for_plot
data_name = "C45_males_AAMR_2010_2014_asbestos_avg1975_with_Slovenia"
plot_title = gsub( "_", " ", data_name )

file_name = paste("Results/", data_name, ".txt", sep="" )
plot_name = paste("Results/", data_name, ".png", sep="" )

ggplot(mortasb, aes(x=PC_asbestos_kg, y=AAMR_per_million, size=population)) + geom_point(colour="#4E8D24", shape=21) + 
  theme(axis.text.x=element_text(angle=0, vjust=0.5, hjust=1)) + scale_y_log10() + theme_bw() +
  theme(panel.border=element_blank(), panel.grid.major = element_blank(), panel.grid.minor=element_blank(), axis.line=element_line(colour="black")) +
  geom_text(label=mortasb$Country_3char, nudge_x=mortasb$nudge_x, nudge_y=mortasb$nudge_y, check_overlap=FALSE, size=3) +
  ggtitle(plot_title) + labs(x="1975 asbestos consumption (kg per head per year)", y="Deaths per million people per year 2010-2014")
ggsave(plot_name, width=8, height=5)

write.table( data_for_plot, file=file_name, quote=FALSE, sep="\t", row.names=FALSE, col.names=TRUE )

nrow(C45_males_AAMR_2010_2014_asbestos_avg1975_with_Slovenia)

cor.test( C45_males_AAMR_2010_2014_asbestos_avg1975_with_Slovenia$PC_asbestos_kg, C45_males_AAMR_2010_2014_asbestos_avg1975_with_Slovenia$AAMR_per_million_log10, method="pearson", use="complete.obs")

model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C45_males_AAMR_2010_2014_asbestos_avg1975_with_Slovenia, weights=male_population)
model_lm
summary(model_lm)
confint(model_lm, '(Intercept)', level=0.95)
confint(model_lm, 'PC_asbestos_kg', level=0.95)
se = sqrt(diag(vcov(model_lm)))
se
AIC(model_lm)
BIC(model_lm)
shapiro.test(residuals(model_lm))

###
> nrow(C45_males_AAMR_2010_2014_asbestos_avg1975_with_Slovenia)
[1] 72
> 
> cor.test( C45_males_AAMR_2010_2014_asbestos_avg1975_with_Slovenia$PC_asbestos_kg, C45_males_AAMR_2010_2014_asbestos_avg1975_with_Slovenia$AAMR_per_million_log10, method="pearson", use="complete.obs")

	Pearson's product-moment correlation

data:  C45_males_AAMR_2010_2014_asbestos_avg1975_with_Slovenia$PC_asbestos_kg and C45_males_AAMR_2010_2014_asbestos_avg1975_with_Slovenia$AAMR_per_million_log10
t = 3.9719, df = 70, p-value = 0.0001709
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.2189391 0.6008302
sample estimates:
      cor 
0.4288556 

> 
> model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C45_males_AAMR_2010_2014_asbestos_avg1975_with_Slovenia, weights=male_population)
> model_lm

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C45_males_AAMR_2010_2014_asbestos_avg1975_with_Slovenia, 
    weights = male_population)

Coefficients:
   (Intercept)  PC_asbestos_kg  
       -0.1822          0.3333  

> summary(model_lm)

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C45_males_AAMR_2010_2014_asbestos_avg1975_with_Slovenia, 
    weights = male_population)

Weighted Residuals:
    Min      1Q  Median      3Q     Max 
-7458.1  -668.6   127.9   790.9  4788.3 

Coefficients:
               Estimate Std. Error t value     Pr(>|t|)    
(Intercept)    -0.18219    0.12611  -1.445        0.153    
PC_asbestos_kg  0.33326    0.05328   6.255 0.0000000276 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 1970 on 70 degrees of freedom
Multiple R-squared:  0.3585,	Adjusted R-squared:  0.3494 
F-statistic: 39.12 on 1 and 70 DF,  p-value: 0.00000002765

> confint(model_lm, '(Intercept)', level=0.95)
                 2.5 %     97.5 %
(Intercept) -0.4337163 0.06933396
> confint(model_lm, 'PC_asbestos_kg', level=0.95)
                   2.5 %    97.5 %
PC_asbestos_kg 0.2269936 0.4395179
> se = sqrt(diag(vcov(model_lm)))
> se
   (Intercept) PC_asbestos_kg 
    0.12611334     0.05327926 
> AIC(model_lm)
[1] 200.3732
> BIC(model_lm)
[1] 207.2032
> shapiro.test(residuals(model_lm))

	Shapiro-Wilk normality test

data:  residuals(model_lm)
W = 0.85497, p-value = 0.0000007254
###

jpeg(paste("Results/", data_name, "_model_lm_hist_residuals.jpg", sep=""), width=600, height=600)
hist(residuals(model_lm), main=paste("residuals for model_lm_", data_name, sep=""))
dev.off()
jpeg(paste("Results/", data_name, "_model_lm_qqplot_residuals.jpg", sep=""), width=600, height=600)
qqnorm( residuals(model_lm), pch=1, frame=FALSE, main=paste("Q-Q plot(model_lm_", data_name, ")", sep="") )
qqline( residuals(model_lm), col="steelblue", lwd=2 )
dev.off()

model_lm_C45_males_AAMR_2010_2014_asbestos_avg1975_with_Slovenia = model_lm
model_name = "model_lm_C45_males_AAMR_2010_2014_asbestos_avg1975_with_Slovenia"
model_disease = "all mesothelioma"
model_gender = "males"
years_of_deaths = "2010-2014"
years_of_asbestos = "1975"
countries_included = "all including Slovenia"

num_points = nrow(mortasb)
y_intercept = model_lm$coefficients[[1]]
slope = model_lm$coefficients[[2]]
BO_CI1 = confint(model_lm, '(Intercept)', level=0.95)[[1]]
BO_CI2 = confint(model_lm, '(Intercept)', level=0.95)[[2]]
B0_SE = sqrt(diag(vcov(model_lm)))[[1]]
B0_p_value = summary(model_lm)$coefficients[7]
B1_CI1 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[1]]
B1_CI2 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[2]]
B1_SE = sqrt(diag(vcov(model_lm)))[[2]]
B1_p_value = summary(model_lm)$coefficients[8]
R_squared = summary(model_lm)$r.squared
adjusted_R_squared = summary(model_lm)$adj.r.squared
fstat = summary(model_lm)$fstatistic
if (is.null(fstat)) {
  p_value = 1
} else {
  p_value = pf(fstat[1], fstat[2], fstat[3], lower.tail=F)
}

#outline = paste(model_disease, model_gender, years_of_deaths, years_of_asbestos, num_points, countries_included, y_intercept, BO_CI1, BO_CI2, B0_SE, B0_p_value, slope, B1_CI1, B1_CI2, B1_SE, B1_p_value, adjusted_R_squared, p_value, sep="\t")
#write(outline, file=outfile_stats, append=TRUE)



##########
##### Analysis for males mesothelioma C45 deaths 2010-2014 vs average asbestos 1975 (avg 1970,1975,1980), without Slovenia

mort1 = mort_2010_to_2014_C45_J61[((mort_2010_to_2014_C45_J61$icd10_3digit_code=="C45") & (mort_2010_to_2014_C45_J61$Sex==1) & (mort_2010_to_2014_C45_J61$deaths>0)),]
pop1 = pop_males_by_age_with_extra_countries

unique(mort1$Country_Name[(!(mort1$Country_Name %in% pop1$Country_Name))])

mort2 = merge( x=mort1, y=pop1, by=c("Country_Name", "Year", "age_group"), x.all=TRUE, y.all=FALSE )

mort2b = sqldf("select Country_Name, Country_3char, Year, age_group, sum(deaths), max(population) from mort2 where population > 0 group by Country_Name, Country_3char, Year, age_group")
colnames(mort2b) = c("Country_Name", "Country_3char", "Year", "age_group", "deaths", "population")
mort2b$death_rate_per_million = mort2b$deaths * 1000000 / mort2b$population

mort3 = merge( x=mort2b, y=std_pop, by=c("age_group"), x.all=TRUE, y.all=FALSE )
mort3$adjusted_death_rate_per_million = mort3$death_rate_per_million * mort3$WHO_World_Standard_rate

mort4 = sqldf('select Country_Name, Country_3char, Year, sum(adjusted_death_rate_per_million) from mort3 group by Country_Name, Country_3char, Year')
names(mort4)[names(mort4)=="sum(adjusted_death_rate_per_million)"] = "AAMR_per_million"

mort6 = sqldf('select Country_Name, Country_3char, avg(AAMR_per_million) from mort4 group by Country_Name, Country_3char')
names(mort6)[names(mort6)=="avg(AAMR_per_million)"] = "AAMR_per_million"

mort6$Country_Name[(!(mort6$Country_Name %in% PC_asbestos_1975avg$Country_Name))]
PC_asbestos_1975avg$Country_Name[(!(PC_asbestos_1975avg$Country_Name %in% mort6$Country_Name))]

mort_asb1 = merge( x=mort6, y=PC_asbestos_1975avg, by=c("Country_Name"), all.x=FALSE, all.y=FALSE )
mort_asb1$Production = NULL
mort_asb1$Imports = NULL
mort_asb1$Exports = NULL
mort_asb1$Apparent_consumption = NULL
mort_asb1$Year = NULL
mort_asb1$AAMR_per_million_log10 = log10(mort_asb1$AAMR_per_million)

pop2 = pop_males[(pop_males$Year==1975),]

mort_asb3 = merge( x=mort_asb1, y=pop2, by=c("Country_Name"), all.x=TRUE, all.y=FALSE )

# Slovenia is an outlier. Its data was derived by making an assumption that 1975 proportional consumption within Yugoslavia is the same as in 1995. Thus remove this outlier.
mort_asb4 = mort_asb3[(mort_asb3$Country_Name!="Slovenia"),]

mortasb = mort_asb4

# nudge the country text on the plot
min_population = min(mortasb$population)
max_population = max(mortasb$population)
nudge_x_slope_m = (0.10 - 0.6) / (max_population - min_population)
nudge_x_intercept_b = 0.6 - nudge_x_slope_m * min_population
mortasb$nudge_x = 1 * (mortasb$population * nudge_x_slope_m + nudge_x_intercept_b)
mortasb$nudge_y = 0

#mortasb$nudge_x = ifelse( (mortasb$Country_3char=="NLD"), 0.2, mortasb$nudge_x )
#mortasb$nudge_y = ifelse( (mortasb$Country_3char=="TUN"), 0.01, mortasb$nudge_y )
#mortasb[,c("Country_Name", "Country_3char", "population", "AAMR_per_million", "nudge_x", "nudge_y")]

data_for_plot = mortasb
data_for_plot$nudge_x = NULL
data_for_plot$nudge_y = NULL

C45_males_AAMR_2010_2014_asbestos_avg1975 = data_for_plot
data_name = "C45_males_AAMR_2010_2014_asbestos_avg1975"
plot_title = gsub( "_", " ", data_name )

file_name = paste("Results/", data_name, ".txt", sep="" )
plot_name = paste("Results/", data_name, ".png", sep="" )

ggplot(mortasb, aes(x=PC_asbestos_kg, y=AAMR_per_million, size=population)) + geom_point(colour="#4E8D24", shape=21) + 
  theme(axis.text.x=element_text(angle=0, vjust=0.5, hjust=1)) + scale_y_log10() + theme_bw() +
  theme(panel.border=element_blank(), panel.grid.major = element_blank(), panel.grid.minor=element_blank(), axis.line=element_line(colour="black")) +
  geom_text(label=mortasb$Country_3char, nudge_x=mortasb$nudge_x, nudge_y=mortasb$nudge_y, check_overlap=FALSE, size=3) +
  ggtitle(plot_title) + labs(x="1975 asbestos consumption (kg per head per year)", y="Deaths per million people per year 2010-2014")
ggsave(plot_name, width=8, height=5)

write.table( data_for_plot, file=file_name, quote=FALSE, sep="\t", row.names=FALSE, col.names=TRUE )

nrow(C45_males_AAMR_2010_2014_asbestos_avg1975)

cor.test( C45_males_AAMR_2010_2014_asbestos_avg1975$PC_asbestos_kg, C45_males_AAMR_2010_2014_asbestos_avg1975$AAMR_per_million_log10, method="pearson", use="complete.obs")

model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C45_males_AAMR_2010_2014_asbestos_avg1975, weights=male_population)
model_lm
summary(model_lm)
confint(model_lm, '(Intercept)', level=0.95)
confint(model_lm, 'PC_asbestos_kg', level=0.95)
se = sqrt(diag(vcov(model_lm)))
se
AIC(model_lm)
BIC(model_lm)
shapiro.test(residuals(model_lm))

###
> nrow(C45_males_AAMR_2010_2014_asbestos_avg1975)
[1] 71
> 
> cor.test( C45_males_AAMR_2010_2014_asbestos_avg1975$PC_asbestos_kg, C45_males_AAMR_2010_2014_asbestos_avg1975$AAMR_per_million_log10, method="pearson", use="complete.obs")

	Pearson's product-moment correlation

data:  C45_males_AAMR_2010_2014_asbestos_avg1975$PC_asbestos_kg and C45_males_AAMR_2010_2014_asbestos_avg1975$AAMR_per_million_log10
t = 4.7613, df = 69, p-value = 0.00001025
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.2986331 0.6546421
sample estimates:
      cor 
0.4972896 

> 
> model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C45_males_AAMR_2010_2014_asbestos_avg1975, weights=male_population)
> model_lm

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C45_males_AAMR_2010_2014_asbestos_avg1975, 
    weights = male_population)

Coefficients:
   (Intercept)  PC_asbestos_kg  
       -0.2513          0.3717  

> summary(model_lm)

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C45_males_AAMR_2010_2014_asbestos_avg1975, 
    weights = male_population)

Weighted Residuals:
    Min      1Q  Median      3Q     Max 
-7310.7  -658.6    90.6   809.9  4694.9 

Coefficients:
               Estimate Std. Error t value      Pr(>|t|)    
(Intercept)    -0.25130    0.12818  -1.961         0.054 .  
PC_asbestos_kg  0.37172    0.05557   6.690 0.00000000484 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 1929 on 69 degrees of freedom
Multiple R-squared:  0.3934,	Adjusted R-squared:  0.3846 
F-statistic: 44.75 on 1 and 69 DF,  p-value: 0.000000004837

> confint(model_lm, '(Intercept)', level=0.95)
                2.5 %      97.5 %
(Intercept) -0.507007 0.004397491
> confint(model_lm, 'PC_asbestos_kg', level=0.95)
                   2.5 %    97.5 %
PC_asbestos_kg 0.2608691 0.4825801
> se = sqrt(diag(vcov(model_lm)))
> se
   (Intercept) PC_asbestos_kg 
    0.12817507     0.05556819 
> AIC(model_lm)
[1] 192.9984
> BIC(model_lm)
[1] 199.7864
> shapiro.test(residuals(model_lm))

	Shapiro-Wilk normality test

data:  residuals(model_lm)
W = 0.94982, p-value = 0.00658
###

jpeg(paste("Results/", data_name, "_model_lm_hist_residuals.jpg", sep=""), width=600, height=600)
hist(residuals(model_lm), main=paste("residuals for model_lm_", data_name, sep=""))
dev.off()
jpeg(paste("Results/", data_name, "_model_lm_qqplot_residuals.jpg", sep=""), width=600, height=600)
qqnorm( residuals(model_lm), pch=1, frame=FALSE, main=paste("Q-Q plot(model_lm_", data_name, ")", sep="") )
qqline( residuals(model_lm), col="steelblue", lwd=2 )
dev.off()

model_lm_C45_males_AAMR_2010_2014_asbestos_avg1975 = model_lm
model_name = "model_lm_C45_males_AAMR_2010_2014_asbestos_avg1975"
model_disease = "all mesothelioma"
model_gender = "males"
years_of_deaths = "2010-2014"
years_of_asbestos = "1975"
countries_included = "all excluding Slovenia"

num_points = nrow(mortasb)
y_intercept = model_lm$coefficients[[1]]
slope = model_lm$coefficients[[2]]
BO_CI1 = confint(model_lm, '(Intercept)', level=0.95)[[1]]
BO_CI2 = confint(model_lm, '(Intercept)', level=0.95)[[2]]
B0_SE = sqrt(diag(vcov(model_lm)))[[1]]
B0_p_value = summary(model_lm)$coefficients[7]
B1_CI1 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[1]]
B1_CI2 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[2]]
B1_SE = sqrt(diag(vcov(model_lm)))[[2]]
B1_p_value = summary(model_lm)$coefficients[8]
R_squared = summary(model_lm)$r.squared
adjusted_R_squared = summary(model_lm)$adj.r.squared
fstat = summary(model_lm)$fstatistic
if (is.null(fstat)) {
  p_value = 1
} else {
  p_value = pf(fstat[1], fstat[2], fstat[3], lower.tail=F)
}

outline = paste(model_disease, model_gender, years_of_deaths, years_of_asbestos, num_points, countries_included, y_intercept, BO_CI1, BO_CI2, B0_SE, B0_p_value, slope, B1_CI1, B1_CI2, B1_SE, B1_p_value, adjusted_R_squared, p_value, sep="\t")
write(outline, file=outfile_stats, append=TRUE)



##########
##### Analysis for males mesothelioma C45 deaths 2010-2014 vs average asbestos 1975 (avg 1970,1975,1980), without Slovenia, using only countries in 2007 paper

mort_asb5 = C45_males_AAMR_2010_2014_asbestos_avg1975

mort_asb6 = mort_asb5[(mort_asb5$Country_3char %in% paper2007_countries_for_C45_males),]

mortasb = mort_asb6

# nudge the country text on the plot
min_population = min(mortasb$population)
max_population = max(mortasb$population)
nudge_x_slope_m = (0.10 - 0.6) / (max_population - min_population)
nudge_x_intercept_b = 0.6 - nudge_x_slope_m * min_population
mortasb$nudge_x = 1 * (mortasb$population * nudge_x_slope_m + nudge_x_intercept_b)
mortasb$nudge_y = 0

#mortasb$nudge_x = ifelse( (mortasb$Country_3char=="NLD"), 0.2, mortasb$nudge_x )
#mortasb$nudge_y = ifelse( (mortasb$Country_3char=="TUN"), 0.01, mortasb$nudge_y )
#mortasb[,c("Country_Name", "Country_3char", "population", "AAMR_per_million", "nudge_x", "nudge_y")]

data_for_plot = mortasb
data_for_plot$nudge_x = NULL
data_for_plot$nudge_y = NULL

C45_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries = data_for_plot
data_name = "C45_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries"
plot_title = gsub( "_", " ", data_name )

file_name = paste("Results/", data_name, ".txt", sep="" )
plot_name = paste("Results/", data_name, ".png", sep="" )

ggplot(mortasb, aes(x=PC_asbestos_kg, y=AAMR_per_million, size=population)) + geom_point(colour="#4E8D24", shape=21) + 
  theme(axis.text.x=element_text(angle=0, vjust=0.5, hjust=1)) + scale_y_log10() + theme_bw() +
  theme(panel.border=element_blank(), panel.grid.major = element_blank(), panel.grid.minor=element_blank(), axis.line=element_line(colour="black")) +
  geom_text(label=mortasb$Country_3char, nudge_x=mortasb$nudge_x, nudge_y=mortasb$nudge_y, check_overlap=FALSE, size=3) +
  ggtitle(plot_title) + labs(x="1975 asbestos consumption (kg per head per year)", y="Deaths per million people per year 2010-2014")
ggsave(plot_name, width=8, height=5)

write.table( data_for_plot, file=file_name, quote=FALSE, sep="\t", row.names=FALSE, col.names=TRUE )

nrow(C45_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries)

cor.test( C45_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries$PC_asbestos_kg, C45_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries$AAMR_per_million_log10, method="pearson", use="complete.obs")

model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C45_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries, weights=male_population)
model_lm
summary(model_lm)
confint(model_lm, '(Intercept)', level=0.95)
confint(model_lm, 'PC_asbestos_kg', level=0.95)
se = sqrt(diag(vcov(model_lm)))
se
AIC(model_lm)
BIC(model_lm)
shapiro.test(residuals(model_lm))

###
> nrow(C45_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries)
[1] 32
> 
> cor.test( C45_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries$PC_asbestos_kg, C45_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries$AAMR_per_million_log10, method="pearson", use="complete.obs")

	Pearson's product-moment correlation

data:  C45_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries$PC_asbestos_kg and C45_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries$AAMR_per_million_log10
t = 4.8279, df = 30, p-value = 0.00003786
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.4062077 0.8207050
sample estimates:
      cor 
0.6612419 

> 
> model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C45_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries, weights=male_population)
> model_lm

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C45_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries, 
    weights = male_population)

Coefficients:
   (Intercept)  PC_asbestos_kg  
        0.1270          0.2703  

> summary(model_lm)

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C45_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries, 
    weights = male_population)

Weighted Residuals:
    Min      1Q  Median      3Q     Max 
-4675.3  -395.9    73.9   774.4  3916.2 

Coefficients:
               Estimate Std. Error t value  Pr(>|t|)    
(Intercept)      0.1270     0.1420   0.894     0.378    
PC_asbestos_kg   0.2703     0.0564   4.793 0.0000418 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 1384 on 30 degrees of freedom
Multiple R-squared:  0.4337,	Adjusted R-squared:  0.4148 
F-statistic: 22.97 on 1 and 30 DF,  p-value: 0.00004176

> confint(model_lm, '(Intercept)', level=0.95)
                 2.5 %    97.5 %
(Intercept) -0.1629631 0.4169251
> confint(model_lm, 'PC_asbestos_kg', level=0.95)
                   2.5 %    97.5 %
PC_asbestos_kg 0.1551373 0.3854916
> se = sqrt(diag(vcov(model_lm)))
> se
   (Intercept) PC_asbestos_kg 
    0.14197132     0.05639657 
> AIC(model_lm)
[1] 57.97385
> BIC(model_lm)
[1] 62.37105
> shapiro.test(residuals(model_lm))

	Shapiro-Wilk normality test

data:  residuals(model_lm)
W = 0.97871, p-value = 0.7612
###

jpeg(paste("Results/", data_name, "_model_lm_hist_residuals.jpg", sep=""), width=600, height=600)
hist(residuals(model_lm), main=paste("residuals for model_lm_", data_name, sep=""))
dev.off()
jpeg(paste("Results/", data_name, "_model_lm_qqplot_residuals.jpg", sep=""), width=600, height=600)
qqnorm( residuals(model_lm), pch=1, frame=FALSE, main=paste("Q-Q plot(model_lm_", data_name, ")", sep="") )
qqline( residuals(model_lm), col="steelblue", lwd=2 )
dev.off()

model_lm_C45_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries = model_lm
model_name = "model_lm_C45_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries"
model_disease = "all mesothelioma"
model_gender = "males"
years_of_deaths = "2010-2014"
years_of_asbestos = "1975"
countries_included = "paper 2007 countries"

num_points = nrow(mortasb)
y_intercept = model_lm$coefficients[[1]]
slope = model_lm$coefficients[[2]]
BO_CI1 = confint(model_lm, '(Intercept)', level=0.95)[[1]]
BO_CI2 = confint(model_lm, '(Intercept)', level=0.95)[[2]]
B0_SE = sqrt(diag(vcov(model_lm)))[[1]]
B0_p_value = summary(model_lm)$coefficients[7]
B1_CI1 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[1]]
B1_CI2 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[2]]
B1_SE = sqrt(diag(vcov(model_lm)))[[2]]
B1_p_value = summary(model_lm)$coefficients[8]
R_squared = summary(model_lm)$r.squared
adjusted_R_squared = summary(model_lm)$adj.r.squared
fstat = summary(model_lm)$fstatistic
if (is.null(fstat)) {
  p_value = 1
} else {
  p_value = pf(fstat[1], fstat[2], fstat[3], lower.tail=F)
}

outline = paste(model_disease, model_gender, years_of_deaths, years_of_asbestos, num_points, countries_included, y_intercept, BO_CI1, BO_CI2, B0_SE, B0_p_value, slope, B1_CI1, B1_CI2, B1_SE, B1_p_value, adjusted_R_squared, p_value, sep="\t")
write(outline, file=outfile_stats, append=TRUE)



##########
##### Analysis for females mesothelioma C45 deaths 2010-2014 vs average asbestos 1975 (avg 1970,1975,1980), without Slovenia

mort1 = mort_2010_to_2014_C45_J61[((mort_2010_to_2014_C45_J61$icd10_3digit_code=="C45") & (mort_2010_to_2014_C45_J61$Sex==2) & (mort_2010_to_2014_C45_J61$deaths>0)),]
pop1 = pop_females_by_age_with_extra_countries

unique(mort1$Country_Name[(!(mort1$Country_Name %in% pop1$Country_Name))])

mort2 = merge( x=mort1, y=pop1, by=c("Country_Name", "Year", "age_group"), x.all=TRUE, y.all=FALSE )

mort2b = sqldf("select Country_Name, Country_3char, Year, age_group, sum(deaths), max(population) from mort2 where population > 0 group by Country_Name, Country_3char, Year, age_group")
colnames(mort2b) = c("Country_Name", "Country_3char", "Year", "age_group", "deaths", "population")
mort2b$death_rate_per_million = mort2b$deaths * 1000000 / mort2b$population

mort3 = merge( x=mort2b, y=std_pop, by=c("age_group"), x.all=TRUE, y.all=FALSE )
mort3$adjusted_death_rate_per_million = mort3$death_rate_per_million * mort3$WHO_World_Standard_rate

mort4 = sqldf('select Country_Name, Country_3char, Year, sum(adjusted_death_rate_per_million) from mort3 group by Country_Name, Country_3char, Year')
names(mort4)[names(mort4)=="sum(adjusted_death_rate_per_million)"] = "AAMR_per_million"

mort6 = sqldf('select Country_Name, Country_3char, avg(AAMR_per_million) from mort4 group by Country_Name, Country_3char')
names(mort6)[names(mort6)=="avg(AAMR_per_million)"] = "AAMR_per_million"

mort6$Country_Name[(!(mort6$Country_Name %in% PC_asbestos_1975avg$Country_Name))]
PC_asbestos_1975avg$Country_Name[(!(PC_asbestos_1975avg$Country_Name %in% mort6$Country_Name))]

mort_asb1 = merge( x=mort6, y=PC_asbestos_1975avg, by=c("Country_Name"), all.x=FALSE, all.y=FALSE )
mort_asb1$Production = NULL
mort_asb1$Imports = NULL
mort_asb1$Exports = NULL
mort_asb1$Apparent_consumption = NULL
mort_asb1$Year = NULL
mort_asb1$AAMR_per_million_log10 = log10(mort_asb1$AAMR_per_million)

pop2 = pop_females[(pop_females$Year==1975),]

mort_asb3 = merge( x=mort_asb1, y=pop2, by=c("Country_Name"), all.x=TRUE, all.y=FALSE )

mort_asb4 = mort_asb3[(mort_asb3$Country_Name!="Slovenia"),]

mortasb = mort_asb4

# nudge the country text on the plot
min_population = min(mortasb$population)
max_population = max(mortasb$population)
nudge_x_slope_m = (0.10 - 0.6) / (max_population - min_population)
nudge_x_intercept_b = 0.6 - nudge_x_slope_m * min_population
mortasb$nudge_x = 1 * (mortasb$population * nudge_x_slope_m + nudge_x_intercept_b)
mortasb$nudge_y = 0

#mortasb$nudge_x = ifelse( (mortasb$Country_3char=="NLD"), 0.2, mortasb$nudge_x )
#mortasb$nudge_y = ifelse( (mortasb$Country_3char=="TUN"), 0.01, mortasb$nudge_y )
#mortasb[,c("Country_Name", "Country_3char", "population", "AAMR_per_million", "nudge_x", "nudge_y")]

data_for_plot = mortasb
data_for_plot$nudge_x = NULL
data_for_plot$nudge_y = NULL

C45_females_AAMR_2010_2014_asbestos_avg1975 = data_for_plot
data_name = "C45_females_AAMR_2010_2014_asbestos_avg1975"
plot_title = gsub( "_", " ", data_name )

file_name = paste("Results/", data_name, ".txt", sep="" )
plot_name = paste("Results/", data_name, ".png", sep="" )

ggplot(mortasb, aes(x=PC_asbestos_kg, y=AAMR_per_million, size=population)) + geom_point(colour="#4E8D24", shape=21) + 
  theme(axis.text.x=element_text(angle=0, vjust=0.5, hjust=1)) + scale_y_log10() + theme_bw() +
  theme(panel.border=element_blank(), panel.grid.major = element_blank(), panel.grid.minor=element_blank(), axis.line=element_line(colour="black")) +
  geom_text(label=mortasb$Country_3char, nudge_x=mortasb$nudge_x, nudge_y=mortasb$nudge_y, check_overlap=FALSE, size=3) +
  ggtitle(plot_title) + labs(x="1975 asbestos consumption (kg per head per year)", y="Deaths per million people per year 2010-2014")
ggsave(plot_name, width=8, height=5)

write.table( data_for_plot, file=file_name, quote=FALSE, sep="\t", row.names=FALSE, col.names=TRUE )

nrow(C45_females_AAMR_2010_2014_asbestos_avg1975)

cor.test( C45_females_AAMR_2010_2014_asbestos_avg1975$PC_asbestos_kg, C45_females_AAMR_2010_2014_asbestos_avg1975$AAMR_per_million_log10, method="pearson", use="complete.obs")

model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C45_females_AAMR_2010_2014_asbestos_avg1975, weights=female_population)
model_lm
summary(model_lm)
confint(model_lm, '(Intercept)', level=0.95)
confint(model_lm, 'PC_asbestos_kg', level=0.95)
se = sqrt(diag(vcov(model_lm)))
se
AIC(model_lm)
BIC(model_lm)
shapiro.test(residuals(model_lm))

###
> nrow(C45_females_AAMR_2010_2014_asbestos_avg1975)
[1] 69
> 
> cor.test( C45_females_AAMR_2010_2014_asbestos_avg1975$PC_asbestos_kg, C45_females_AAMR_2010_2014_asbestos_avg1975$AAMR_per_million_log10, method="pearson", use="complete.obs")

	Pearson's product-moment correlation

data:  C45_females_AAMR_2010_2014_asbestos_avg1975$PC_asbestos_kg and C45_females_AAMR_2010_2014_asbestos_avg1975$AAMR_per_million_log10
t = 4.1592, df = 67, p-value = 0.00009288
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.2422982 0.6228965
sample estimates:
      cor 
0.4530005 

> 
> model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C45_females_AAMR_2010_2014_asbestos_avg1975, weights=female_population)
> model_lm

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C45_females_AAMR_2010_2014_asbestos_avg1975, 
    weights = female_population)

Coefficients:
   (Intercept)  PC_asbestos_kg  
       -0.4559          0.2455  

> summary(model_lm)

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C45_females_AAMR_2010_2014_asbestos_avg1975, 
    weights = female_population)

Weighted Residuals:
    Min      1Q  Median      3Q     Max 
-6513.7  -377.8   154.3   667.4  3988.7 

Coefficients:
               Estimate Std. Error t value    Pr(>|t|)    
(Intercept)    -0.45589    0.10484  -4.349 0.000047745 ***
PC_asbestos_kg  0.24546    0.04478   5.482 0.000000688 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 1568 on 67 degrees of freedom
Multiple R-squared:  0.3097,	Adjusted R-squared:  0.2993 
F-statistic: 30.05 on 1 and 67 DF,  p-value: 0.0000006879

> confint(model_lm, '(Intercept)', level=0.95)
                 2.5 %     97.5 %
(Intercept) -0.6651404 -0.2466345
> confint(model_lm, 'PC_asbestos_kg', level=0.95)
                  2.5 %    97.5 %
PC_asbestos_kg 0.156088 0.3348324
> se = sqrt(diag(vcov(model_lm)))
> se
   (Intercept) PC_asbestos_kg 
    0.10483571     0.04477546 
> AIC(model_lm)
[1] 157.0035
> BIC(model_lm)
[1] 163.7058
> shapiro.test(residuals(model_lm))

	Shapiro-Wilk normality test

data:  residuals(model_lm)
W = 0.94723, p-value = 0.00563
###

jpeg(paste("Results/", data_name, "_model_lm_hist_residuals.jpg", sep=""), width=600, height=600)
hist(residuals(model_lm), main=paste("residuals for model_lm_", data_name, sep=""))
dev.off()
jpeg(paste("Results/", data_name, "_model_lm_qqplot_residuals.jpg", sep=""), width=600, height=600)
qqnorm( residuals(model_lm), pch=1, frame=FALSE, main=paste("Q-Q plot(model_lm_", data_name, ")", sep="") )
qqline( residuals(model_lm), col="steelblue", lwd=2 )
dev.off()

model_lm_C45_females_AAMR_2010_2014_asbestos_avg1975 = model_lm
model_name = "model_lm_C45_females_AAMR_2010_2014_asbestos_avg1975"
model_disease = "all mesothelioma"
model_gender = "females"
years_of_deaths = "2010-2014"
years_of_asbestos = "1975"
countries_included = "all excluding Slovenia"

num_points = nrow(mortasb)
y_intercept = model_lm$coefficients[[1]]
slope = model_lm$coefficients[[2]]
BO_CI1 = confint(model_lm, '(Intercept)', level=0.95)[[1]]
BO_CI2 = confint(model_lm, '(Intercept)', level=0.95)[[2]]
B0_SE = sqrt(diag(vcov(model_lm)))[[1]]
B0_p_value = summary(model_lm)$coefficients[7]
B1_CI1 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[1]]
B1_CI2 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[2]]
B1_SE = sqrt(diag(vcov(model_lm)))[[2]]
B1_p_value = summary(model_lm)$coefficients[8]
R_squared = summary(model_lm)$r.squared
adjusted_R_squared = summary(model_lm)$adj.r.squared
fstat = summary(model_lm)$fstatistic
if (is.null(fstat)) {
  p_value = 1
} else {
  p_value = pf(fstat[1], fstat[2], fstat[3], lower.tail=F)
}

outline = paste(model_disease, model_gender, years_of_deaths, years_of_asbestos, num_points, countries_included, y_intercept, BO_CI1, BO_CI2, B0_SE, B0_p_value, slope, B1_CI1, B1_CI2, B1_SE, B1_p_value, adjusted_R_squared, p_value, sep="\t")
write(outline, file=outfile_stats, append=TRUE)



##########
##### Analysis for females mesothelioma C45 deaths 2010-2014 vs average asbestos 1975 (avg 1970,1975,1980), without Slovenia, using only countries in 2007 paper

mort_asb5 = C45_females_AAMR_2010_2014_asbestos_avg1975

mort_asb6 = mort_asb5[(mort_asb5$Country_3char %in% paper2007_countries_for_C45_females),]

mortasb = mort_asb6

# nudge the country text on the plot
min_population = min(mortasb$population)
max_population = max(mortasb$population)
nudge_x_slope_m = (0.10 - 0.6) / (max_population - min_population)
nudge_x_intercept_b = 0.6 - nudge_x_slope_m * min_population
mortasb$nudge_x = 1 * (mortasb$population * nudge_x_slope_m + nudge_x_intercept_b)
mortasb$nudge_y = 0

#mortasb$nudge_x = ifelse( (mortasb$Country_3char=="NLD"), 0.2, mortasb$nudge_x )
#mortasb$nudge_y = ifelse( (mortasb$Country_3char=="TUN"), 0.01, mortasb$nudge_y )
#mortasb[,c("Country_Name", "Country_3char", "population", "AAMR_per_million", "nudge_x", "nudge_y")]

data_for_plot = mortasb
data_for_plot$nudge_x = NULL
data_for_plot$nudge_y = NULL

C45_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries = data_for_plot
data_name = "C45_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries"
plot_title = gsub( "_", " ", data_name )

file_name = paste("Results/", data_name, ".txt", sep="" )
plot_name = paste("Results/", data_name, ".png", sep="" )

ggplot(mortasb, aes(x=PC_asbestos_kg, y=AAMR_per_million, size=population)) + geom_point(colour="#4E8D24", shape=21) + 
  theme(axis.text.x=element_text(angle=0, vjust=0.5, hjust=1)) + scale_y_log10() + theme_bw() +
  theme(panel.border=element_blank(), panel.grid.major = element_blank(), panel.grid.minor=element_blank(), axis.line=element_line(colour="black")) +
  geom_text(label=mortasb$Country_3char, nudge_x=mortasb$nudge_x, nudge_y=mortasb$nudge_y, check_overlap=FALSE, size=3) +
  ggtitle(plot_title) + labs(x="1975 asbestos consumption (kg per head per year)", y="Deaths per million people per year 2010-2014")
ggsave(plot_name, width=8, height=5)

write.table( data_for_plot, file=file_name, quote=FALSE, sep="\t", row.names=FALSE, col.names=TRUE )

nrow(C45_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries)

cor.test( C45_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries$PC_asbestos_kg, C45_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries$AAMR_per_million_log10, method="pearson", use="complete.obs")

model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C45_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries, weights=female_population)
model_lm
summary(model_lm)
confint(model_lm, '(Intercept)', level=0.95)
confint(model_lm, 'PC_asbestos_kg', level=0.95)
se = sqrt(diag(vcov(model_lm)))
se
AIC(model_lm)
BIC(model_lm)
shapiro.test(residuals(model_lm))

###
> nrow(C45_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries)
[1] 31
> 
> cor.test( C45_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries$PC_asbestos_kg, C45_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries$AAMR_per_million_log10, method="pearson", use="complete.obs")

	Pearson's product-moment correlation

data:  C45_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries$PC_asbestos_kg and C45_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries$AAMR_per_million_log10
t = 4.0925, df = 29, p-value = 0.0003111
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.3191397 0.7900203
sample estimates:
      cor 
0.6050575 

> 
> model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C45_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries, weights=female_population)
> model_lm

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C45_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries, 
    weights = female_population)

Coefficients:
   (Intercept)  PC_asbestos_kg  
       -0.1645          0.1549  

> summary(model_lm)

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C45_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries, 
    weights = female_population)

Weighted Residuals:
    Min      1Q  Median      3Q     Max 
-3457.9  -271.7   173.2   532.5  2934.2 

Coefficients:
               Estimate Std. Error t value Pr(>|t|)   
(Intercept)    -0.16452    0.11097  -1.483  0.14898   
PC_asbestos_kg  0.15489    0.04369   3.545  0.00135 **
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 1086 on 29 degrees of freedom
Multiple R-squared:  0.3024,	Adjusted R-squared:  0.2783 
F-statistic: 12.57 on 1 and 29 DF,  p-value: 0.001353

> confint(model_lm, '(Intercept)', level=0.95)
                2.5 %     97.5 %
(Intercept) -0.391475 0.06243853
> confint(model_lm, 'PC_asbestos_kg', level=0.95)
                   2.5 %   97.5 %
PC_asbestos_kg 0.0655311 0.244239
> se = sqrt(diag(vcov(model_lm)))
> se
   (Intercept) PC_asbestos_kg 
    0.11096883     0.04368896 
> AIC(model_lm)
[1] 39.17307
> BIC(model_lm)
[1] 43.47504
> shapiro.test(residuals(model_lm))

	Shapiro-Wilk normality test

data:  residuals(model_lm)
W = 0.98332, p-value = 0.8969
###

jpeg(paste("Results/", data_name, "_model_lm_hist_residuals.jpg", sep=""), width=600, height=600)
hist(residuals(model_lm), main=paste("residuals for model_lm_", data_name, sep=""))
dev.off()
jpeg(paste("Results/", data_name, "_model_lm_qqplot_residuals.jpg", sep=""), width=600, height=600)
qqnorm( residuals(model_lm), pch=1, frame=FALSE, main=paste("Q-Q plot(model_lm_", data_name, ")", sep="") )
qqline( residuals(model_lm), col="steelblue", lwd=2 )
dev.off()

model_lm_C45_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries = model_lm
model_name = "model_lm_C45_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries"
model_disease = "all mesothelioma"
model_gender = "females"
years_of_deaths = "2010-2014"
years_of_asbestos = "1975"
countries_included = "paper 2007 countries"

num_points = nrow(mortasb)
y_intercept = model_lm$coefficients[[1]]
slope = model_lm$coefficients[[2]]
BO_CI1 = confint(model_lm, '(Intercept)', level=0.95)[[1]]
BO_CI2 = confint(model_lm, '(Intercept)', level=0.95)[[2]]
B0_SE = sqrt(diag(vcov(model_lm)))[[1]]
B0_p_value = summary(model_lm)$coefficients[7]
B1_CI1 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[1]]
B1_CI2 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[2]]
B1_SE = sqrt(diag(vcov(model_lm)))[[2]]
B1_p_value = summary(model_lm)$coefficients[8]
R_squared = summary(model_lm)$r.squared
adjusted_R_squared = summary(model_lm)$adj.r.squared
fstat = summary(model_lm)$fstatistic
if (is.null(fstat)) {
  p_value = 1
} else {
  p_value = pf(fstat[1], fstat[2], fstat[3], lower.tail=F)
}

outline = paste(model_disease, model_gender, years_of_deaths, years_of_asbestos, num_points, countries_included, y_intercept, BO_CI1, BO_CI2, B0_SE, B0_p_value, slope, B1_CI1, B1_CI2, B1_SE, B1_p_value, adjusted_R_squared, p_value, sep="\t")
write(outline, file=outfile_stats, append=TRUE)



##########
##### Analysis for males pleural mesothelioma C450 deaths 2010-2014 vs average asbestos 1975 (avg 1970,1975,1980), without Slovenia

mort1 = mort_2010_to_2014_C45_J61[((mort_2010_to_2014_C45_J61$Cause=="C450") & (mort_2010_to_2014_C45_J61$Sex==1) & (mort_2010_to_2014_C45_J61$deaths>0)),]
pop1 = pop_males_by_age_with_extra_countries

unique(mort1$Country_Name[(!(mort1$Country_Name %in% pop1$Country_Name))])

mort2 = merge( x=mort1, y=pop1, by=c("Country_Name", "Year", "age_group"), x.all=TRUE, y.all=FALSE )

mort2b = sqldf("select Country_Name, Country_3char, Year, age_group, sum(deaths), max(population) from mort2 where population > 0 group by Country_Name, Country_3char, Year, age_group")
colnames(mort2b) = c("Country_Name", "Country_3char", "Year", "age_group", "deaths", "population")
mort2b$death_rate_per_million = mort2b$deaths * 1000000 / mort2b$population

mort3 = merge( x=mort2b, y=std_pop, by=c("age_group"), x.all=TRUE, y.all=FALSE )
mort3$adjusted_death_rate_per_million = mort3$death_rate_per_million * mort3$WHO_World_Standard_rate

mort4 = sqldf('select Country_Name, Country_3char, Year, sum(adjusted_death_rate_per_million) from mort3 group by Country_Name, Country_3char, Year')
names(mort4)[names(mort4)=="sum(adjusted_death_rate_per_million)"] = "AAMR_per_million"

mort6 = sqldf('select Country_Name, Country_3char, avg(AAMR_per_million) from mort4 group by Country_Name, Country_3char')
names(mort6)[names(mort6)=="avg(AAMR_per_million)"] = "AAMR_per_million"

mort6$Country_Name[(!(mort6$Country_Name %in% PC_asbestos_1975avg$Country_Name))]
PC_asbestos_1975avg$Country_Name[(!(PC_asbestos_1975avg$Country_Name %in% mort6$Country_Name))]

mort_asb1 = merge( x=mort6, y=PC_asbestos_1975avg, by=c("Country_Name"), all.x=FALSE, all.y=FALSE )
mort_asb1$Production = NULL
mort_asb1$Imports = NULL
mort_asb1$Exports = NULL
mort_asb1$Apparent_consumption = NULL
mort_asb1$Year = NULL
mort_asb1$AAMR_per_million_log10 = log10(mort_asb1$AAMR_per_million)

pop2 = pop_males[(pop_males$Year==1975),]

mort_asb3 = merge( x=mort_asb1, y=pop2, by=c("Country_Name"), all.x=TRUE, all.y=FALSE )

# Slovenia is an outlier. Its data was derived by making an assumption that 1975 proportional consumption within Yugoslavia is the same as in 1995. Thus remove this outlier.
mort_asb4 = mort_asb3[(mort_asb3$Country_Name!="Slovenia"),]

mortasb = mort_asb4

# nudge the country text on the plot
min_population = min(mortasb$population)
max_population = max(mortasb$population)
nudge_x_slope_m = (0.10 - 0.6) / (max_population - min_population)
nudge_x_intercept_b = 0.6 - nudge_x_slope_m * min_population
mortasb$nudge_x = 1 * (mortasb$population * nudge_x_slope_m + nudge_x_intercept_b)
mortasb$nudge_y = 0

#mortasb$nudge_x = ifelse( (mortasb$Country_3char=="NLD"), 0.2, mortasb$nudge_x )
#mortasb$nudge_y = ifelse( (mortasb$Country_3char=="TUN"), 0.01, mortasb$nudge_y )
#mortasb[,c("Country_Name", "Country_3char", "population", "AAMR_per_million", "nudge_x", "nudge_y")]

data_for_plot = mortasb
data_for_plot$nudge_x = NULL
data_for_plot$nudge_y = NULL

C450_males_AAMR_2010_2014_asbestos_avg1975 = data_for_plot
data_name = "C450_males_AAMR_2010_2014_asbestos_avg1975"
plot_title = gsub( "_", " ", data_name )

file_name = paste("Results/", data_name, ".txt", sep="" )
plot_name = paste("Results/", data_name, ".png", sep="" )

ggplot(mortasb, aes(x=PC_asbestos_kg, y=AAMR_per_million, size=population)) + geom_point(colour="#4E8D24", shape=21) + 
  theme(axis.text.x=element_text(angle=0, vjust=0.5, hjust=1)) + scale_y_log10() + theme_bw() +
  theme(panel.border=element_blank(), panel.grid.major = element_blank(), panel.grid.minor=element_blank(), axis.line=element_line(colour="black")) +
  geom_text(label=mortasb$Country_3char, nudge_x=mortasb$nudge_x, nudge_y=mortasb$nudge_y, check_overlap=FALSE, size=3) +
  ggtitle(plot_title) + labs(x="1975 asbestos consumption (kg per head per year)", y="Deaths per million people per year 2010-2014")
ggsave(plot_name, width=8, height=5)

write.table( data_for_plot, file=file_name, quote=FALSE, sep="\t", row.names=FALSE, col.names=TRUE )

nrow(C450_males_AAMR_2010_2014_asbestos_avg1975)

cor.test( C450_males_AAMR_2010_2014_asbestos_avg1975$PC_asbestos_kg, C450_males_AAMR_2010_2014_asbestos_avg1975$AAMR_per_million_log10, method="pearson", use="complete.obs")

model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C450_males_AAMR_2010_2014_asbestos_avg1975, weights=male_population)
model_lm
summary(model_lm)
confint(model_lm, '(Intercept)', level=0.95)
confint(model_lm, 'PC_asbestos_kg', level=0.95)
se = sqrt(diag(vcov(model_lm)))
se
AIC(model_lm)
BIC(model_lm)
shapiro.test(residuals(model_lm))

> nrow(C450_males_AAMR_2010_2014_asbestos_avg1975)
[1] 51
> 
> cor.test( C450_males_AAMR_2010_2014_asbestos_avg1975$PC_asbestos_kg, C450_males_AAMR_2010_2014_asbestos_avg1975$AAMR_per_million_log10, method="pearson", use="complete.obs")

	Pearson's product-moment correlation

data:  C450_males_AAMR_2010_2014_asbestos_avg1975$PC_asbestos_kg and C450_males_AAMR_2010_2014_asbestos_avg1975$AAMR_per_million_log10
t = 4.8914, df = 49, p-value = 0.00001122
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.3529055 0.7327090
sample estimates:
      cor 
0.5727832 

> 
> model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C450_males_AAMR_2010_2014_asbestos_avg1975, weights=male_population)
> model_lm

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C450_males_AAMR_2010_2014_asbestos_avg1975, 
    weights = male_population)

Coefficients:
   (Intercept)  PC_asbestos_kg  
       -0.5063          0.3155  

> summary(model_lm)

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C450_males_AAMR_2010_2014_asbestos_avg1975, 
    weights = male_population)

Weighted Residuals:
    Min      1Q  Median      3Q     Max 
-5773.2  -268.5   269.1   927.1  4045.4 

Coefficients:
               Estimate Std. Error t value   Pr(>|t|)    
(Intercept)    -0.50629    0.13857  -3.654   0.000629 ***
PC_asbestos_kg  0.31549    0.05659   5.575 0.00000105 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 1625 on 49 degrees of freedom
Multiple R-squared:  0.3881,	Adjusted R-squared:  0.3756 
F-statistic: 31.08 on 1 and 49 DF,  p-value: 0.000001051

> confint(model_lm, '(Intercept)', level=0.95)
                 2.5 %    97.5 %
(Intercept) -0.7847519 -0.227827
> confint(model_lm, 'PC_asbestos_kg', level=0.95)
                   2.5 %    97.5 %
PC_asbestos_kg 0.2017616 0.4292254
> se = sqrt(diag(vcov(model_lm)))
> se
   (Intercept) PC_asbestos_kg 
    0.13856781     0.05659499 
> AIC(model_lm)
[1] 118.0151
> BIC(model_lm)
[1] 123.8106
> shapiro.test(residuals(model_lm))

	Shapiro-Wilk normality test

data:  residuals(model_lm)
W = 0.95137, p-value = 0.03595
###

jpeg(paste("Results/", data_name, "_model_lm_hist_residuals.jpg", sep=""), width=600, height=600)
hist(residuals(model_lm), main=paste("residuals for model_lm_", data_name, sep=""))
dev.off()
jpeg(paste("Results/", data_name, "_model_lm_qqplot_residuals.jpg", sep=""), width=600, height=600)
qqnorm( residuals(model_lm), pch=1, frame=FALSE, main=paste("Q-Q plot(model_lm_", data_name, ")", sep="") )
qqline( residuals(model_lm), col="steelblue", lwd=2 )
dev.off()

model_lm_C450_males_AAMR_2010_2014_asbestos_avg1975 = model_lm
model_name = "model_lm_C450_males_AAMR_2010_2014_asbestos_avg1975"
model_disease = "pleural mesothelioma"
model_gender = "males"
years_of_deaths = "2010-2014"
years_of_asbestos = "1975"
countries_included = "all excluding Slovenia"

num_points = nrow(mortasb)
y_intercept = model_lm$coefficients[[1]]
slope = model_lm$coefficients[[2]]
BO_CI1 = confint(model_lm, '(Intercept)', level=0.95)[[1]]
BO_CI2 = confint(model_lm, '(Intercept)', level=0.95)[[2]]
B0_SE = sqrt(diag(vcov(model_lm)))[[1]]
B0_p_value = summary(model_lm)$coefficients[7]
B1_CI1 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[1]]
B1_CI2 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[2]]
B1_SE = sqrt(diag(vcov(model_lm)))[[2]]
B1_p_value = summary(model_lm)$coefficients[8]
R_squared = summary(model_lm)$r.squared
adjusted_R_squared = summary(model_lm)$adj.r.squared
fstat = summary(model_lm)$fstatistic
if (is.null(fstat)) {
  p_value = 1
} else {
  p_value = pf(fstat[1], fstat[2], fstat[3], lower.tail=F)
}

outline = paste(model_disease, model_gender, years_of_deaths, years_of_asbestos, num_points, countries_included, y_intercept, BO_CI1, BO_CI2, B0_SE, B0_p_value, slope, B1_CI1, B1_CI2, B1_SE, B1_p_value, adjusted_R_squared, p_value, sep="\t")
write(outline, file=outfile_stats, append=TRUE)



##########
##### Analysis for males pleural mesothelioma C450 deaths 2010-2014 vs average asbestos 1975 (avg 1970,1975,1980), without Slovenia, using only countries in 2007 paper

mort_asb5 = C450_males_AAMR_2010_2014_asbestos_avg1975

mort_asb6 = mort_asb5[(mort_asb5$Country_3char %in% paper2007_countries_for_C450_males),]

mortasb = mort_asb6

# nudge the country text on the plot
min_population = min(mortasb$population)
max_population = max(mortasb$population)
nudge_x_slope_m = (0.10 - 0.6) / (max_population - min_population)
nudge_x_intercept_b = 0.6 - nudge_x_slope_m * min_population
mortasb$nudge_x = 1 * (mortasb$population * nudge_x_slope_m + nudge_x_intercept_b)
mortasb$nudge_y = 0

#mortasb$nudge_x = ifelse( (mortasb$Country_3char=="NLD"), 0.2, mortasb$nudge_x )
#mortasb$nudge_y = ifelse( (mortasb$Country_3char=="TUN"), 0.01, mortasb$nudge_y )
#mortasb[,c("Country_Name", "Country_3char", "population", "AAMR_per_million", "nudge_x", "nudge_y")]

data_for_plot = mortasb
data_for_plot$nudge_x = NULL
data_for_plot$nudge_y = NULL

C450_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries = data_for_plot
data_name = "C450_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries"
plot_title = gsub( "_", " ", data_name )

file_name = paste("Results/", data_name, ".txt", sep="" )
plot_name = paste("Results/", data_name, ".png", sep="" )

ggplot(mortasb, aes(x=PC_asbestos_kg, y=AAMR_per_million, size=population)) + geom_point(colour="#4E8D24", shape=21) + 
  theme(axis.text.x=element_text(angle=0, vjust=0.5, hjust=1)) + scale_y_log10() + theme_bw() +
  theme(panel.border=element_blank(), panel.grid.major = element_blank(), panel.grid.minor=element_blank(), axis.line=element_line(colour="black")) +
  geom_text(label=mortasb$Country_3char, nudge_x=mortasb$nudge_x, nudge_y=mortasb$nudge_y, check_overlap=FALSE, size=3) +
  ggtitle(plot_title) + labs(x="1975 asbestos consumption (kg per head per year)", y="Deaths per million people per year 2010-2014")
ggsave(plot_name, width=8, height=5)

write.table( data_for_plot, file=file_name, quote=FALSE, sep="\t", row.names=FALSE, col.names=TRUE )

nrow(C450_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries)

cor.test( C450_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries$PC_asbestos_kg, C450_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries$AAMR_per_million_log10, method="pearson", use="complete.obs")

model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C450_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries, weights=male_population)
model_lm
summary(model_lm)
confint(model_lm, '(Intercept)', level=0.95)
confint(model_lm, 'PC_asbestos_kg', level=0.95)
se = sqrt(diag(vcov(model_lm)))
se
AIC(model_lm)
BIC(model_lm)
shapiro.test(residuals(model_lm))

###
> nrow(C450_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries)
[1] 26
> 
> cor.test( C450_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries$PC_asbestos_kg, C450_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries$AAMR_per_million_log10, method="pearson", use="complete.obs")

	Pearson's product-moment correlation

data:  C450_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries$PC_asbestos_kg and C450_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries$AAMR_per_million_log10
t = 3.8627, df = 24, p-value = 0.000745
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.3049357 0.8118097
sample estimates:
      cor 
0.6191547 

> 
> model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C450_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries, weights=male_population)
> model_lm

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C450_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries, 
    weights = male_population)

Coefficients:
   (Intercept)  PC_asbestos_kg  
       -0.5983          0.3305  

> summary(model_lm)

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C450_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries, 
    weights = male_population)

Weighted Residuals:
    Min      1Q  Median      3Q     Max 
-5189.9   -59.3   630.7  1248.8  3454.5 

Coefficients:
               Estimate Std. Error t value Pr(>|t|)    
(Intercept)    -0.59831    0.21513  -2.781 0.010374 *  
PC_asbestos_kg  0.33047    0.08393   3.938 0.000617 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 2012 on 24 degrees of freedom
Multiple R-squared:  0.3925,	Adjusted R-squared:  0.3672 
F-statistic:  15.5 on 1 and 24 DF,  p-value: 0.0006168

> confint(model_lm, '(Intercept)', level=0.95)
                2.5 %     97.5 %
(Intercept) -1.042327 -0.1542936
> confint(model_lm, 'PC_asbestos_kg', level=0.95)
                   2.5 %    97.5 %
PC_asbestos_kg 0.1572561 0.5036885
> se = sqrt(diag(vcov(model_lm)))
> se
   (Intercept) PC_asbestos_kg 
    0.21513495     0.08392671 
> AIC(model_lm)
[1] 58.26703
> BIC(model_lm)
[1] 62.04131
> shapiro.test(residuals(model_lm))

	Shapiro-Wilk normality test

data:  residuals(model_lm)
W = 0.92898, p-value = 0.07327
###

jpeg(paste("Results/", data_name, "_model_lm_hist_residuals.jpg", sep=""), width=600, height=600)
hist(residuals(model_lm), main=paste("residuals for model_lm_", data_name, sep=""))
dev.off()
jpeg(paste("Results/", data_name, "_model_lm_qqplot_residuals.jpg", sep=""), width=600, height=600)
qqnorm( residuals(model_lm), pch=1, frame=FALSE, main=paste("Q-Q plot(model_lm_", data_name, ")", sep="") )
qqline( residuals(model_lm), col="steelblue", lwd=2 )
dev.off()

model_lm_C450_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries = model_lm
model_name = "model_lm_C450_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries"
model_disease = "pleural mesothelioma"
model_gender = "males"
years_of_deaths = "2010-2014"
years_of_asbestos = "1975"
countries_included = "paper 2007 countries"

num_points = nrow(mortasb)
y_intercept = model_lm$coefficients[[1]]
slope = model_lm$coefficients[[2]]
BO_CI1 = confint(model_lm, '(Intercept)', level=0.95)[[1]]
BO_CI2 = confint(model_lm, '(Intercept)', level=0.95)[[2]]
B0_SE = sqrt(diag(vcov(model_lm)))[[1]]
B0_p_value = summary(model_lm)$coefficients[7]
B1_CI1 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[1]]
B1_CI2 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[2]]
B1_SE = sqrt(diag(vcov(model_lm)))[[2]]
B1_p_value = summary(model_lm)$coefficients[8]
R_squared = summary(model_lm)$r.squared
adjusted_R_squared = summary(model_lm)$adj.r.squared
fstat = summary(model_lm)$fstatistic
if (is.null(fstat)) {
  p_value = 1
} else {
  p_value = pf(fstat[1], fstat[2], fstat[3], lower.tail=F)
}

outline = paste(model_disease, model_gender, years_of_deaths, years_of_asbestos, num_points, countries_included, y_intercept, BO_CI1, BO_CI2, B0_SE, B0_p_value, slope, B1_CI1, B1_CI2, B1_SE, B1_p_value, adjusted_R_squared, p_value, sep="\t")
write(outline, file=outfile_stats, append=TRUE)



##########
##### Analysis for females pleural mesothelioma C450 deaths 2010-2014 vs average asbestos 1975 (avg 1970,1975,1980), without Slovenia

mort1 = mort_2010_to_2014_C45_J61[((mort_2010_to_2014_C45_J61$Cause=="C450") & (mort_2010_to_2014_C45_J61$Sex==2) & (mort_2010_to_2014_C45_J61$deaths>0)),]
pop1 = pop_females_by_age_with_extra_countries

unique(mort1$Country_Name[(!(mort1$Country_Name %in% pop1$Country_Name))])

mort2 = merge( x=mort1, y=pop1, by=c("Country_Name", "Year", "age_group"), x.all=TRUE, y.all=FALSE )

mort2b = sqldf("select Country_Name, Country_3char, Year, age_group, sum(deaths), max(population) from mort2 where population > 0 group by Country_Name, Country_3char, Year, age_group")
colnames(mort2b) = c("Country_Name", "Country_3char", "Year", "age_group", "deaths", "population")
mort2b$death_rate_per_million = mort2b$deaths * 1000000 / mort2b$population

mort3 = merge( x=mort2b, y=std_pop, by=c("age_group"), x.all=TRUE, y.all=FALSE )
mort3$adjusted_death_rate_per_million = mort3$death_rate_per_million * mort3$WHO_World_Standard_rate

mort4 = sqldf('select Country_Name, Country_3char, Year, sum(adjusted_death_rate_per_million) from mort3 group by Country_Name, Country_3char, Year')
names(mort4)[names(mort4)=="sum(adjusted_death_rate_per_million)"] = "AAMR_per_million"

mort6 = sqldf('select Country_Name, Country_3char, avg(AAMR_per_million) from mort4 group by Country_Name, Country_3char')
names(mort6)[names(mort6)=="avg(AAMR_per_million)"] = "AAMR_per_million"

mort6$Country_Name[(!(mort6$Country_Name %in% PC_asbestos_1975avg$Country_Name))]
PC_asbestos_1975avg$Country_Name[(!(PC_asbestos_1975avg$Country_Name %in% mort6$Country_Name))]

mort_asb1 = merge( x=mort6, y=PC_asbestos_1975avg, by=c("Country_Name"), all.x=FALSE, all.y=FALSE )
mort_asb1$Production = NULL
mort_asb1$Imports = NULL
mort_asb1$Exports = NULL
mort_asb1$Apparent_consumption = NULL
mort_asb1$Year = NULL
mort_asb1$AAMR_per_million_log10 = log10(mort_asb1$AAMR_per_million)

pop2 = pop_females[(pop_females$Year==1975),]

mort_asb3 = merge( x=mort_asb1, y=pop2, by=c("Country_Name"), all.x=TRUE, all.y=FALSE )

mort_asb4 = mort_asb3[(mort_asb3$Country_Name!="Slovenia"),]

mortasb = mort_asb4

# nudge the country text on the plot
min_population = min(mortasb$population)
max_population = max(mortasb$population)
nudge_x_slope_m = (0.10 - 0.6) / (max_population - min_population)
nudge_x_intercept_b = 0.6 - nudge_x_slope_m * min_population
mortasb$nudge_x = 1 * (mortasb$population * nudge_x_slope_m + nudge_x_intercept_b)
mortasb$nudge_y = 0

#mortasb$nudge_x = ifelse( (mortasb$Country_3char=="NLD"), 0.2, mortasb$nudge_x )
#mortasb$nudge_y = ifelse( (mortasb$Country_3char=="TUN"), 0.01, mortasb$nudge_y )
#mortasb[,c("Country_Name", "Country_3char", "population", "AAMR_per_million", "nudge_x", "nudge_y")]

data_for_plot = mortasb
data_for_plot$nudge_x = NULL
data_for_plot$nudge_y = NULL

C450_females_AAMR_2010_2014_asbestos_avg1975 = data_for_plot
data_name = "C450_females_AAMR_2010_2014_asbestos_avg1975"
plot_title = gsub( "_", " ", data_name )

file_name = paste("Results/", data_name, ".txt", sep="" )
plot_name = paste("Results/", data_name, ".png", sep="" )

ggplot(mortasb, aes(x=PC_asbestos_kg, y=AAMR_per_million, size=population)) + geom_point(colour="#4E8D24", shape=21) + 
  theme(axis.text.x=element_text(angle=0, vjust=0.5, hjust=1)) + scale_y_log10() + theme_bw() +
  theme(panel.border=element_blank(), panel.grid.major = element_blank(), panel.grid.minor=element_blank(), axis.line=element_line(colour="black")) +
  geom_text(label=mortasb$Country_3char, nudge_x=mortasb$nudge_x, nudge_y=mortasb$nudge_y, check_overlap=FALSE, size=3) +
  ggtitle(plot_title) + labs(x="1975 asbestos consumption (kg per head per year)", y="Deaths per million people per year 2010-2014")
ggsave(plot_name, width=8, height=5)

write.table( data_for_plot, file=file_name, quote=FALSE, sep="\t", row.names=FALSE, col.names=TRUE )

nrow(C450_females_AAMR_2010_2014_asbestos_avg1975)

cor.test( C450_females_AAMR_2010_2014_asbestos_avg1975$PC_asbestos_kg, C450_females_AAMR_2010_2014_asbestos_avg1975$AAMR_per_million_log10, method="pearson", use="complete.obs")

model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C450_females_AAMR_2010_2014_asbestos_avg1975, weights=female_population)
model_lm
summary(model_lm)
confint(model_lm, '(Intercept)', level=0.95)
confint(model_lm, 'PC_asbestos_kg', level=0.95)
se = sqrt(diag(vcov(model_lm)))
se
AIC(model_lm)
BIC(model_lm)
shapiro.test(residuals(model_lm))

###
> nrow(C450_females_AAMR_2010_2014_asbestos_avg1975)
[1] 49
> 
> cor.test( C450_females_AAMR_2010_2014_asbestos_avg1975$PC_asbestos_kg, C450_females_AAMR_2010_2014_asbestos_avg1975$AAMR_per_million_log10, method="pearson", use="complete.obs")

	Pearson's product-moment correlation

data:  C450_females_AAMR_2010_2014_asbestos_avg1975$PC_asbestos_kg and C450_females_AAMR_2010_2014_asbestos_avg1975$AAMR_per_million_log10
t = 4.7696, df = 47, p-value = 0.00001825
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.3453629 0.7343623
sample estimates:
      cor 
0.5710974 

> 
> model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C450_females_AAMR_2010_2014_asbestos_avg1975, weights=female_population)
> model_lm

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C450_females_AAMR_2010_2014_asbestos_avg1975, 
    weights = female_population)

Coefficients:
   (Intercept)  PC_asbestos_kg  
       -0.8697          0.2208  

> summary(model_lm)

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C450_females_AAMR_2010_2014_asbestos_avg1975, 
    weights = female_population)

Weighted Residuals:
    Min      1Q  Median      3Q     Max 
-6624.5   -68.9   359.7   834.8  4510.0 

Coefficients:
               Estimate Std. Error t value     Pr(>|t|)    
(Intercept)    -0.86968    0.13445  -6.468 0.0000000524 ***
PC_asbestos_kg  0.22080    0.05519   4.001     0.000222 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 1675 on 47 degrees of freedom
Multiple R-squared:  0.254,	Adjusted R-squared:  0.2381 
F-statistic:    16 on 1 and 47 DF,  p-value: 0.0002224

> confint(model_lm, '(Intercept)', level=0.95)
                2.5 %     97.5 %
(Intercept) -1.140164 -0.5992028
> confint(model_lm, 'PC_asbestos_kg', level=0.95)
                   2.5 %    97.5 %
PC_asbestos_kg 0.1097672 0.3318327
> se = sqrt(diag(vcov(model_lm)))
> se
   (Intercept) PC_asbestos_kg 
    0.13445115     0.05519238 
> AIC(model_lm)
[1] 110.2542
> BIC(model_lm)
[1] 115.9296
> shapiro.test(residuals(model_lm))

	Shapiro-Wilk normality test

data:  residuals(model_lm)
W = 0.95457, p-value = 0.05665
###

jpeg(paste("Results/", data_name, "_model_lm_hist_residuals.jpg", sep=""), width=600, height=600)
hist(residuals(model_lm), main=paste("residuals for model_lm_", data_name, sep=""))
dev.off()
jpeg(paste("Results/", data_name, "_model_lm_qqplot_residuals.jpg", sep=""), width=600, height=600)
qqnorm( residuals(model_lm), pch=1, frame=FALSE, main=paste("Q-Q plot(model_lm_", data_name, ")", sep="") )
qqline( residuals(model_lm), col="steelblue", lwd=2 )
dev.off()

model_lm_C450_females_AAMR_2010_2014_asbestos_avg1975 = model_lm
model_name = "model_lm_C450_females_AAMR_2010_2014_asbestos_avg1975"
model_disease = "pleural mesothelioma"
model_gender = "females"
years_of_deaths = "2010-2014"
years_of_asbestos = "1975"
countries_included = "all excluding Slovenia"

num_points = nrow(mortasb)
y_intercept = model_lm$coefficients[[1]]
slope = model_lm$coefficients[[2]]
BO_CI1 = confint(model_lm, '(Intercept)', level=0.95)[[1]]
BO_CI2 = confint(model_lm, '(Intercept)', level=0.95)[[2]]
B0_SE = sqrt(diag(vcov(model_lm)))[[1]]
B0_p_value = summary(model_lm)$coefficients[7]
B1_CI1 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[1]]
B1_CI2 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[2]]
B1_SE = sqrt(diag(vcov(model_lm)))[[2]]
B1_p_value = summary(model_lm)$coefficients[8]
R_squared = summary(model_lm)$r.squared
adjusted_R_squared = summary(model_lm)$adj.r.squared
fstat = summary(model_lm)$fstatistic
if (is.null(fstat)) {
  p_value = 1
} else {
  p_value = pf(fstat[1], fstat[2], fstat[3], lower.tail=F)
}

outline = paste(model_disease, model_gender, years_of_deaths, years_of_asbestos, num_points, countries_included, y_intercept, BO_CI1, BO_CI2, B0_SE, B0_p_value, slope, B1_CI1, B1_CI2, B1_SE, B1_p_value, adjusted_R_squared, p_value, sep="\t")
write(outline, file=outfile_stats, append=TRUE)



##########
##### Analysis for females pleural mesothelioma C450 deaths 2010-2014 vs average asbestos 1975 (avg 1970,1975,1980), without Slovenia, using only countries in 2007 paper

mort_asb5 = C450_females_AAMR_2010_2014_asbestos_avg1975

mort_asb6 = mort_asb5[(mort_asb5$Country_3char %in% paper2007_countries_for_C450_females),]

mortasb = mort_asb6

# nudge the country text on the plot
min_population = min(mortasb$population)
max_population = max(mortasb$population)
nudge_x_slope_m = (0.10 - 0.6) / (max_population - min_population)
nudge_x_intercept_b = 0.6 - nudge_x_slope_m * min_population
mortasb$nudge_x = 1 * (mortasb$population * nudge_x_slope_m + nudge_x_intercept_b)
mortasb$nudge_y = 0

#mortasb$nudge_x = ifelse( (mortasb$Country_3char=="NLD"), 0.2, mortasb$nudge_x )
#mortasb$nudge_y = ifelse( (mortasb$Country_3char=="TUN"), 0.01, mortasb$nudge_y )
#mortasb[,c("Country_Name", "Country_3char", "population", "AAMR_per_million", "nudge_x", "nudge_y")]

data_for_plot = mortasb
data_for_plot$nudge_x = NULL
data_for_plot$nudge_y = NULL

C450_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries = data_for_plot
data_name = "C450_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries"
plot_title = gsub( "_", " ", data_name )

file_name = paste("Results/", data_name, ".txt", sep="" )
plot_name = paste("Results/", data_name, ".png", sep="" )

ggplot(mortasb, aes(x=PC_asbestos_kg, y=AAMR_per_million, size=population)) + geom_point(colour="#4E8D24", shape=21) + 
  theme(axis.text.x=element_text(angle=0, vjust=0.5, hjust=1)) + scale_y_log10() + theme_bw() +
  theme(panel.border=element_blank(), panel.grid.major = element_blank(), panel.grid.minor=element_blank(), axis.line=element_line(colour="black")) +
  geom_text(label=mortasb$Country_3char, nudge_x=mortasb$nudge_x, nudge_y=mortasb$nudge_y, check_overlap=FALSE, size=3) +
  ggtitle(plot_title) + labs(x="1975 asbestos consumption (kg per head per year)", y="Deaths per million people per year 2010-2014")
ggsave(plot_name, width=8, height=5)

write.table( data_for_plot, file=file_name, quote=FALSE, sep="\t", row.names=FALSE, col.names=TRUE )

nrow(C450_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries)

cor.test( C450_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries$PC_asbestos_kg, C450_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries$AAMR_per_million_log10, method="pearson", use="complete.obs")

model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C450_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries, weights=female_population)
model_lm
summary(model_lm)
confint(model_lm, '(Intercept)', level=0.95)
confint(model_lm, 'PC_asbestos_kg', level=0.95)
se = sqrt(diag(vcov(model_lm)))
se
AIC(model_lm)
BIC(model_lm)
shapiro.test(residuals(model_lm))

###
> nrow(C450_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries)
[1] 23
> 
> cor.test( C450_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries$PC_asbestos_kg, C450_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries$AAMR_per_million_log10, method="pearson", use="complete.obs")

	Pearson's product-moment correlation

data:  C450_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries$PC_asbestos_kg and C450_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries$AAMR_per_million_log10
t = 2.0261, df = 21, p-value = 0.05564
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 -0.009396858  0.699910677
sample estimates:
      cor 
0.4043716 

> 
> model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C450_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries, weights=female_population)
> model_lm

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C450_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries, 
    weights = female_population)

Coefficients:
   (Intercept)  PC_asbestos_kg  
       -0.8926          0.2054  

> summary(model_lm)

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C450_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries, 
    weights = female_population)

Weighted Residuals:
    Min      1Q  Median      3Q     Max 
-5993.4   136.0   690.1  1606.1  3141.6 

Coefficients:
               Estimate Std. Error t value Pr(>|t|)    
(Intercept)    -0.89256    0.22382  -3.988 0.000669 ***
PC_asbestos_kg  0.20535    0.08586   2.392 0.026205 *  
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 2045 on 21 degrees of freedom
Multiple R-squared:  0.2141,	Adjusted R-squared:  0.1767 
F-statistic:  5.72 on 1 and 21 DF,  p-value: 0.0262

> confint(model_lm, '(Intercept)', level=0.95)
                2.5 %     97.5 %
(Intercept) -1.358009 -0.4271025
> confint(model_lm, 'PC_asbestos_kg', level=0.95)
                    2.5 %    97.5 %
PC_asbestos_kg 0.02679918 0.3839091
> se = sqrt(diag(vcov(model_lm)))
> se
   (Intercept) PC_asbestos_kg 
    0.22381715     0.08585967 
> AIC(model_lm)
[1] 48.57083
> BIC(model_lm)
[1] 51.97731
> shapiro.test(residuals(model_lm))

	Shapiro-Wilk normality test

data:  residuals(model_lm)
W = 0.88683, p-value = 0.01366
###

jpeg(paste("Results/", data_name, "_model_lm_hist_residuals.jpg", sep=""), width=600, height=600)
hist(residuals(model_lm), main=paste("residuals for model_lm_", data_name, sep=""))
dev.off()
jpeg(paste("Results/", data_name, "_model_lm_qqplot_residuals.jpg", sep=""), width=600, height=600)
qqnorm( residuals(model_lm), pch=1, frame=FALSE, main=paste("Q-Q plot(model_lm_", data_name, ")", sep="") )
qqline( residuals(model_lm), col="steelblue", lwd=2 )
dev.off()

model_lm_C450_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries = model_lm
model_name = "model_lm_C450_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries"
model_disease = "pleural mesothelioma"
model_gender = "females"
years_of_deaths = "2010-2014"
years_of_asbestos = "1975"
countries_included = "paper 2007 countries"

num_points = nrow(mortasb)
y_intercept = model_lm$coefficients[[1]]
slope = model_lm$coefficients[[2]]
BO_CI1 = confint(model_lm, '(Intercept)', level=0.95)[[1]]
BO_CI2 = confint(model_lm, '(Intercept)', level=0.95)[[2]]
B0_SE = sqrt(diag(vcov(model_lm)))[[1]]
B0_p_value = summary(model_lm)$coefficients[7]
B1_CI1 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[1]]
B1_CI2 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[2]]
B1_SE = sqrt(diag(vcov(model_lm)))[[2]]
B1_p_value = summary(model_lm)$coefficients[8]
R_squared = summary(model_lm)$r.squared
adjusted_R_squared = summary(model_lm)$adj.r.squared
fstat = summary(model_lm)$fstatistic
if (is.null(fstat)) {
  p_value = 1
} else {
  p_value = pf(fstat[1], fstat[2], fstat[3], lower.tail=F)
}

outline = paste(model_disease, model_gender, years_of_deaths, years_of_asbestos, num_points, countries_included, y_intercept, BO_CI1, BO_CI2, B0_SE, B0_p_value, slope, B1_CI1, B1_CI2, B1_SE, B1_p_value, adjusted_R_squared, p_value, sep="\t")
write(outline, file=outfile_stats, append=TRUE)



##########
##### Analysis for males peritoneal mesothelioma C451 deaths 2010-2014 vs average asbestos 1975 (avg 1970,1975,1980), without Slovenia

mort1 = mort_2010_to_2014_C45_J61[((mort_2010_to_2014_C45_J61$Cause=="C451") & (mort_2010_to_2014_C45_J61$Sex==1) & (mort_2010_to_2014_C45_J61$deaths>0)),]
pop1 = pop_males_by_age_with_extra_countries

unique(mort1$Country_Name[(!(mort1$Country_Name %in% pop1$Country_Name))])

mort2 = merge( x=mort1, y=pop1, by=c("Country_Name", "Year", "age_group"), x.all=TRUE, y.all=FALSE )

mort2b = sqldf("select Country_Name, Country_3char, Year, age_group, sum(deaths), max(population) from mort2 where population > 0 group by Country_Name, Country_3char, Year, age_group")
colnames(mort2b) = c("Country_Name", "Country_3char", "Year", "age_group", "deaths", "population")
mort2b$death_rate_per_million = mort2b$deaths * 1000000 / mort2b$population

mort3 = merge( x=mort2b, y=std_pop, by=c("age_group"), x.all=TRUE, y.all=FALSE )
mort3$adjusted_death_rate_per_million = mort3$death_rate_per_million * mort3$WHO_World_Standard_rate

mort4 = sqldf('select Country_Name, Country_3char, Year, sum(adjusted_death_rate_per_million) from mort3 group by Country_Name, Country_3char, Year')
names(mort4)[names(mort4)=="sum(adjusted_death_rate_per_million)"] = "AAMR_per_million"

mort6 = sqldf('select Country_Name, Country_3char, avg(AAMR_per_million) from mort4 group by Country_Name, Country_3char')
names(mort6)[names(mort6)=="avg(AAMR_per_million)"] = "AAMR_per_million"

mort6$Country_Name[(!(mort6$Country_Name %in% PC_asbestos_1975avg$Country_Name))]
PC_asbestos_1975avg$Country_Name[(!(PC_asbestos_1975avg$Country_Name %in% mort6$Country_Name))]

mort_asb1 = merge( x=mort6, y=PC_asbestos_1975avg, by=c("Country_Name"), all.x=FALSE, all.y=FALSE )
mort_asb1$Production = NULL
mort_asb1$Imports = NULL
mort_asb1$Exports = NULL
mort_asb1$Apparent_consumption = NULL
mort_asb1$Year = NULL
mort_asb1$AAMR_per_million_log10 = log10(mort_asb1$AAMR_per_million)

pop2 = pop_males[(pop_males$Year==1975),]

mort_asb3 = merge( x=mort_asb1, y=pop2, by=c("Country_Name"), all.x=TRUE, all.y=FALSE )

# Slovenia is an outlier. Its data was derived by making an assumption that 1975 proportional consumption within Yugoslavia is the same as in 1995. Thus remove this outlier.
mort_asb4 = mort_asb3[(mort_asb3$Country_Name!="Slovenia"),]

mortasb = mort_asb4

# nudge the country text on the plot
min_population = min(mortasb$population)
max_population = max(mortasb$population)
nudge_x_slope_m = (0.10 - 0.6) / (max_population - min_population)
nudge_x_intercept_b = 0.6 - nudge_x_slope_m * min_population
mortasb$nudge_x = 1 * (mortasb$population * nudge_x_slope_m + nudge_x_intercept_b)
mortasb$nudge_y = 0

#mortasb$nudge_x = ifelse( (mortasb$Country_3char=="NLD"), 0.2, mortasb$nudge_x )
#mortasb$nudge_y = ifelse( (mortasb$Country_3char=="TUN"), 0.01, mortasb$nudge_y )
#mortasb[,c("Country_Name", "Country_3char", "population", "AAMR_per_million", "nudge_x", "nudge_y")]

data_for_plot = mortasb
data_for_plot$nudge_x = NULL
data_for_plot$nudge_y = NULL

C451_males_AAMR_2010_2014_asbestos_avg1975 = data_for_plot
data_name = "C451_males_AAMR_2010_2014_asbestos_avg1975"
plot_title = gsub( "_", " ", data_name )

file_name = paste("Results/", data_name, ".txt", sep="" )
plot_name = paste("Results/", data_name, ".png", sep="" )

ggplot(mortasb, aes(x=PC_asbestos_kg, y=AAMR_per_million, size=population)) + geom_point(colour="#4E8D24", shape=21) + 
  theme(axis.text.x=element_text(angle=0, vjust=0.5, hjust=1)) + scale_y_log10() + theme_bw() +
  theme(panel.border=element_blank(), panel.grid.major = element_blank(), panel.grid.minor=element_blank(), axis.line=element_line(colour="black")) +
  geom_text(label=mortasb$Country_3char, nudge_x=mortasb$nudge_x, nudge_y=mortasb$nudge_y, check_overlap=FALSE, size=3) +
  ggtitle(plot_title) + labs(x="1975 asbestos consumption (kg per head per year)", y="Deaths per million people per year 2010-2014")
ggsave(plot_name, width=8, height=5)

write.table( data_for_plot, file=file_name, quote=FALSE, sep="\t", row.names=FALSE, col.names=TRUE )

nrow(C451_males_AAMR_2010_2014_asbestos_avg1975)

cor.test( C451_males_AAMR_2010_2014_asbestos_avg1975$PC_asbestos_kg, C451_males_AAMR_2010_2014_asbestos_avg1975$AAMR_per_million_log10, method="pearson", use="complete.obs")

model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C451_males_AAMR_2010_2014_asbestos_avg1975, weights=male_population)
model_lm
summary(model_lm)
confint(model_lm, '(Intercept)', level=0.95)
confint(model_lm, 'PC_asbestos_kg', level=0.95)
se = sqrt(diag(vcov(model_lm)))
se
AIC(model_lm)
BIC(model_lm)
shapiro.test(residuals(model_lm))

###
> nrow(C451_males_AAMR_2010_2014_asbestos_avg1975)
[1] 45
> 
> cor.test( C451_males_AAMR_2010_2014_asbestos_avg1975$PC_asbestos_kg, C451_males_AAMR_2010_2014_asbestos_avg1975$AAMR_per_million_log10, method="pearson", use="complete.obs")

	Pearson's product-moment correlation

data:  C451_males_AAMR_2010_2014_asbestos_avg1975$PC_asbestos_kg and C451_males_AAMR_2010_2014_asbestos_avg1975$AAMR_per_million_log10
t = 4.4136, df = 43, p-value = 0.00006725
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.3167524 0.7319390
sample estimates:
      cor 
0.5583704 

> 
> model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C451_males_AAMR_2010_2014_asbestos_avg1975, weights=male_population)
> model_lm

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C451_males_AAMR_2010_2014_asbestos_avg1975, 
    weights = male_population)

Coefficients:
   (Intercept)  PC_asbestos_kg  
       -0.8795          0.1668  

> summary(model_lm)

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C451_males_AAMR_2010_2014_asbestos_avg1975, 
    weights = male_population)

Weighted Residuals:
    Min      1Q  Median      3Q     Max 
-2753.4  -148.1   289.7   594.7  2309.0 

Coefficients:
               Estimate Std. Error t value           Pr(>|t|)    
(Intercept)    -0.87952    0.08148  -10.79 0.0000000000000807 ***
PC_asbestos_kg  0.16680    0.03284    5.08 0.0000077879772250 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 918.4 on 43 degrees of freedom
Multiple R-squared:  0.3751,	Adjusted R-squared:  0.3605 
F-statistic: 25.81 on 1 and 43 DF,  p-value: 0.000007788

> confint(model_lm, '(Intercept)', level=0.95)
                2.5 %     97.5 %
(Intercept) -1.043838 -0.7151962
> confint(model_lm, 'PC_asbestos_kg', level=0.95)
                   2.5 %    97.5 %
PC_asbestos_kg 0.1005816 0.2330181
> se = sqrt(diag(vcov(model_lm)))
> se
   (Intercept) PC_asbestos_kg 
    0.08148034     0.03283508 
> AIC(model_lm)
[1] 47.77217
> BIC(model_lm)
[1] 53.19216
> shapiro.test(residuals(model_lm))

	Shapiro-Wilk normality test

data:  residuals(model_lm)
W = 0.99058, p-value = 0.9713
###

jpeg(paste("Results/", data_name, "_model_lm_hist_residuals.jpg", sep=""), width=600, height=600)
hist(residuals(model_lm), main=paste("residuals for model_lm_", data_name, sep=""))
dev.off()
jpeg(paste("Results/", data_name, "_model_lm_qqplot_residuals.jpg", sep=""), width=600, height=600)
qqnorm( residuals(model_lm), pch=1, frame=FALSE, main=paste("Q-Q plot(model_lm_", data_name, ")", sep="") )
qqline( residuals(model_lm), col="steelblue", lwd=2 )
dev.off()

model_lm_C451_males_AAMR_2010_2014_asbestos_avg1975 = model_lm
model_name = "model_lm_C451_males_AAMR_2010_2014_asbestos_avg1975"
model_disease = "peritoneal mesothelioma"
model_gender = "males"
years_of_deaths = "2010-2014"
years_of_asbestos = "1975"
countries_included = "all excluding Slovenia"

num_points = nrow(mortasb)
y_intercept = model_lm$coefficients[[1]]
slope = model_lm$coefficients[[2]]
BO_CI1 = confint(model_lm, '(Intercept)', level=0.95)[[1]]
BO_CI2 = confint(model_lm, '(Intercept)', level=0.95)[[2]]
B0_SE = sqrt(diag(vcov(model_lm)))[[1]]
B0_p_value = summary(model_lm)$coefficients[7]
B1_CI1 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[1]]
B1_CI2 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[2]]
B1_SE = sqrt(diag(vcov(model_lm)))[[2]]
B1_p_value = summary(model_lm)$coefficients[8]
R_squared = summary(model_lm)$r.squared
adjusted_R_squared = summary(model_lm)$adj.r.squared
fstat = summary(model_lm)$fstatistic
if (is.null(fstat)) {
  p_value = 1
} else {
  p_value = pf(fstat[1], fstat[2], fstat[3], lower.tail=F)
}

outline = paste(model_disease, model_gender, years_of_deaths, years_of_asbestos, num_points, countries_included, y_intercept, BO_CI1, BO_CI2, B0_SE, B0_p_value, slope, B1_CI1, B1_CI2, B1_SE, B1_p_value, adjusted_R_squared, p_value, sep="\t")
write(outline, file=outfile_stats, append=TRUE)



##########
##### Analysis for males peritoneal mesothelioma C451 deaths 2010-2014 vs average asbestos 1975 (avg 1970,1975,1980), without Slovenia, using only countries in 2007 paper

mort_asb5 = C451_males_AAMR_2010_2014_asbestos_avg1975

mort_asb6 = mort_asb5[(mort_asb5$Country_3char %in% paper2007_countries_for_C451_males),]

mortasb = mort_asb6

# nudge the country text on the plot
min_population = min(mortasb$population)
max_population = max(mortasb$population)
nudge_x_slope_m = (0.10 - 0.6) / (max_population - min_population)
nudge_x_intercept_b = 0.6 - nudge_x_slope_m * min_population
mortasb$nudge_x = 1 * (mortasb$population * nudge_x_slope_m + nudge_x_intercept_b)
mortasb$nudge_y = 0

#mortasb$nudge_x = ifelse( (mortasb$Country_3char=="NLD"), 0.2, mortasb$nudge_x )
#mortasb$nudge_y = ifelse( (mortasb$Country_3char=="TUN"), 0.01, mortasb$nudge_y )
#mortasb[,c("Country_Name", "Country_3char", "population", "AAMR_per_million", "nudge_x", "nudge_y")]

data_for_plot = mortasb
data_for_plot$nudge_x = NULL
data_for_plot$nudge_y = NULL

C451_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries = data_for_plot
data_name = "C451_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries"
plot_title = gsub( "_", " ", data_name )

file_name = paste("Results/", data_name, ".txt", sep="" )
plot_name = paste("Results/", data_name, ".png", sep="" )

ggplot(mortasb, aes(x=PC_asbestos_kg, y=AAMR_per_million, size=population)) + geom_point(colour="#4E8D24", shape=21) + 
  theme(axis.text.x=element_text(angle=0, vjust=0.5, hjust=1)) + scale_y_log10() + theme_bw() +
  theme(panel.border=element_blank(), panel.grid.major = element_blank(), panel.grid.minor=element_blank(), axis.line=element_line(colour="black")) +
  geom_text(label=mortasb$Country_3char, nudge_x=mortasb$nudge_x, nudge_y=mortasb$nudge_y, check_overlap=FALSE, size=3) +
  ggtitle(plot_title) + labs(x="1975 asbestos consumption (kg per head per year)", y="Deaths per million people per year 2010-2014")
ggsave(plot_name, width=8, height=5)

write.table( data_for_plot, file=file_name, quote=FALSE, sep="\t", row.names=FALSE, col.names=TRUE )

nrow(C451_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries)

cor.test( C451_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries$PC_asbestos_kg, C451_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries$AAMR_per_million_log10, method="pearson", use="complete.obs")

model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C451_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries, weights=male_population)
model_lm
summary(model_lm)
confint(model_lm, '(Intercept)', level=0.95)
confint(model_lm, 'PC_asbestos_kg', level=0.95)
se = sqrt(diag(vcov(model_lm)))
se
AIC(model_lm)
BIC(model_lm)
shapiro.test(residuals(model_lm))

###
> nrow(C451_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries)
[1] 24
> 
> cor.test( C451_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries$PC_asbestos_kg, C451_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries$AAMR_per_million_log10, method="pearson", use="complete.obs")

	Pearson's product-moment correlation

data:  C451_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries$PC_asbestos_kg and C451_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries$AAMR_per_million_log10
t = 3.5884, df = 22, p-value = 0.001636
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.2705430 0.8119917
sample estimates:
      cor 
0.6076258 

> 
> model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C451_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries, weights=male_population)
> model_lm

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C451_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries, 
    weights = male_population)

Coefficients:
   (Intercept)  PC_asbestos_kg  
       -0.9336          0.1792  

> summary(model_lm)

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C451_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries, 
    weights = male_population)

Weighted Residuals:
    Min      1Q  Median      3Q     Max 
-2452.7  -173.5   302.7   597.1  2445.6 

Coefficients:
               Estimate Std. Error t value     Pr(>|t|)    
(Intercept)    -0.93361    0.11654  -8.011 0.0000000577 ***
PC_asbestos_kg  0.17916    0.04502   3.980     0.000633 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 1043 on 22 degrees of freedom
Multiple R-squared:  0.4186,	Adjusted R-squared:  0.3922 
F-statistic: 15.84 on 1 and 22 DF,  p-value: 0.0006333

> confint(model_lm, '(Intercept)', level=0.95)
                2.5 %    97.5 %
(Intercept) -1.175291 -0.691921
> confint(model_lm, 'PC_asbestos_kg', level=0.95)
                    2.5 %    97.5 %
PC_asbestos_kg 0.08580495 0.2725186
> se = sqrt(diag(vcov(model_lm)))
> se
   (Intercept) PC_asbestos_kg 
    0.11653796     0.04501569 
> AIC(model_lm)
[1] 20.63968
> BIC(model_lm)
[1] 24.17384
> shapiro.test(residuals(model_lm))

	Shapiro-Wilk normality test

data:  residuals(model_lm)
W = 0.95437, p-value = 0.3359
###

jpeg(paste("Results/", data_name, "_model_lm_hist_residuals.jpg", sep=""), width=600, height=600)
hist(residuals(model_lm), main=paste("residuals for model_lm_", data_name, sep=""))
dev.off()
jpeg(paste("Results/", data_name, "_model_lm_qqplot_residuals.jpg", sep=""), width=600, height=600)
qqnorm( residuals(model_lm), pch=1, frame=FALSE, main=paste("Q-Q plot(model_lm_", data_name, ")", sep="") )
qqline( residuals(model_lm), col="steelblue", lwd=2 )
dev.off()

model_lm_C451_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries = model_lm
model_name = "model_lm_C451_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries"
model_disease = "peritoneal mesothelioma"
model_gender = "males"
years_of_deaths = "2010-2014"
years_of_asbestos = "1975"
countries_included = "paper 2007 countries"

num_points = nrow(mortasb)
y_intercept = model_lm$coefficients[[1]]
slope = model_lm$coefficients[[2]]
BO_CI1 = confint(model_lm, '(Intercept)', level=0.95)[[1]]
BO_CI2 = confint(model_lm, '(Intercept)', level=0.95)[[2]]
B0_SE = sqrt(diag(vcov(model_lm)))[[1]]
B0_p_value = summary(model_lm)$coefficients[7]
B1_CI1 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[1]]
B1_CI2 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[2]]
B1_SE = sqrt(diag(vcov(model_lm)))[[2]]
B1_p_value = summary(model_lm)$coefficients[8]
R_squared = summary(model_lm)$r.squared
adjusted_R_squared = summary(model_lm)$adj.r.squared
fstat = summary(model_lm)$fstatistic
if (is.null(fstat)) {
  p_value = 1
} else {
  p_value = pf(fstat[1], fstat[2], fstat[3], lower.tail=F)
}

outline = paste(model_disease, model_gender, years_of_deaths, years_of_asbestos, num_points, countries_included, y_intercept, BO_CI1, BO_CI2, B0_SE, B0_p_value, slope, B1_CI1, B1_CI2, B1_SE, B1_p_value, adjusted_R_squared, p_value, sep="\t")
write(outline, file=outfile_stats, append=TRUE)



##########
##### Analysis for females peritoneal mesothelioma C451 deaths 2010-2014 vs average asbestos 1975 (avg 1970,1975,1980), without Slovenia

mort1 = mort_2010_to_2014_C45_J61[((mort_2010_to_2014_C45_J61$Cause=="C451") & (mort_2010_to_2014_C45_J61$Sex==2) & (mort_2010_to_2014_C45_J61$deaths>0)),]
pop1 = pop_females_by_age_with_extra_countries

unique(mort1$Country_Name[(!(mort1$Country_Name %in% pop1$Country_Name))])

mort2 = merge( x=mort1, y=pop1, by=c("Country_Name", "Year", "age_group"), x.all=TRUE, y.all=FALSE )

mort2b = sqldf("select Country_Name, Country_3char, Year, age_group, sum(deaths), max(population) from mort2 where population > 0 group by Country_Name, Country_3char, Year, age_group")
colnames(mort2b) = c("Country_Name", "Country_3char", "Year", "age_group", "deaths", "population")
mort2b$death_rate_per_million = mort2b$deaths * 1000000 / mort2b$population

mort3 = merge( x=mort2b, y=std_pop, by=c("age_group"), x.all=TRUE, y.all=FALSE )
mort3$adjusted_death_rate_per_million = mort3$death_rate_per_million * mort3$WHO_World_Standard_rate

mort4 = sqldf('select Country_Name, Country_3char, Year, sum(adjusted_death_rate_per_million) from mort3 group by Country_Name, Country_3char, Year')
names(mort4)[names(mort4)=="sum(adjusted_death_rate_per_million)"] = "AAMR_per_million"

mort6 = sqldf('select Country_Name, Country_3char, avg(AAMR_per_million) from mort4 group by Country_Name, Country_3char')
names(mort6)[names(mort6)=="avg(AAMR_per_million)"] = "AAMR_per_million"

mort6$Country_Name[(!(mort6$Country_Name %in% PC_asbestos_1975avg$Country_Name))]
PC_asbestos_1975avg$Country_Name[(!(PC_asbestos_1975avg$Country_Name %in% mort6$Country_Name))]

mort_asb1 = merge( x=mort6, y=PC_asbestos_1975avg, by=c("Country_Name"), all.x=FALSE, all.y=FALSE )
mort_asb1$Production = NULL
mort_asb1$Imports = NULL
mort_asb1$Exports = NULL
mort_asb1$Apparent_consumption = NULL
mort_asb1$Year = NULL
mort_asb1$AAMR_per_million_log10 = log10(mort_asb1$AAMR_per_million)

pop2 = pop_females[(pop_females$Year==1975),]

mort_asb3 = merge( x=mort_asb1, y=pop2, by=c("Country_Name"), all.x=TRUE, all.y=FALSE )

mort_asb4 = mort_asb3[(mort_asb3$Country_Name!="Slovenia"),]

mortasb = mort_asb4

# nudge the country text on the plot
min_population = min(mortasb$population)
max_population = max(mortasb$population)
nudge_x_slope_m = (0.10 - 0.6) / (max_population - min_population)
nudge_x_intercept_b = 0.6 - nudge_x_slope_m * min_population
mortasb$nudge_x = 1 * (mortasb$population * nudge_x_slope_m + nudge_x_intercept_b)
mortasb$nudge_y = 0

#mortasb$nudge_x = ifelse( (mortasb$Country_3char=="NLD"), 0.2, mortasb$nudge_x )
#mortasb$nudge_y = ifelse( (mortasb$Country_3char=="TUN"), 0.01, mortasb$nudge_y )
#mortasb[,c("Country_Name", "Country_3char", "population", "AAMR_per_million", "nudge_x", "nudge_y")]

data_for_plot = mortasb
data_for_plot$nudge_x = NULL
data_for_plot$nudge_y = NULL

C451_females_AAMR_2010_2014_asbestos_avg1975 = data_for_plot
data_name = "C451_females_AAMR_2010_2014_asbestos_avg1975"
plot_title = gsub( "_", " ", data_name )

file_name = paste("Results/", data_name, ".txt", sep="" )
plot_name = paste("Results/", data_name, ".png", sep="" )

ggplot(mortasb, aes(x=PC_asbestos_kg, y=AAMR_per_million, size=population)) + geom_point(colour="#4E8D24", shape=21) + 
  theme(axis.text.x=element_text(angle=0, vjust=0.5, hjust=1)) + scale_y_log10() + theme_bw() +
  theme(panel.border=element_blank(), panel.grid.major = element_blank(), panel.grid.minor=element_blank(), axis.line=element_line(colour="black")) +
  geom_text(label=mortasb$Country_3char, nudge_x=mortasb$nudge_x, nudge_y=mortasb$nudge_y, check_overlap=FALSE, size=3) +
  ggtitle(plot_title) + labs(x="1975 asbestos consumption (kg per head per year)", y="Deaths per million people per year 2010-2014")
ggsave(plot_name, width=8, height=5)

write.table( data_for_plot, file=file_name, quote=FALSE, sep="\t", row.names=FALSE, col.names=TRUE )

nrow(C451_females_AAMR_2010_2014_asbestos_avg1975)

cor.test( C451_females_AAMR_2010_2014_asbestos_avg1975$PC_asbestos_kg, C451_females_AAMR_2010_2014_asbestos_avg1975$AAMR_per_million_log10, method="pearson", use="complete.obs")

model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C451_females_AAMR_2010_2014_asbestos_avg1975, weights=female_population)
model_lm
summary(model_lm)
confint(model_lm, '(Intercept)', level=0.95)
confint(model_lm, 'PC_asbestos_kg', level=0.95)
se = sqrt(diag(vcov(model_lm)))
se
AIC(model_lm)
BIC(model_lm)
shapiro.test(residuals(model_lm))

###
> nrow(C451_females_AAMR_2010_2014_asbestos_avg1975)
[1] 46
> 
> cor.test( C451_females_AAMR_2010_2014_asbestos_avg1975$PC_asbestos_kg, C451_females_AAMR_2010_2014_asbestos_avg1975$AAMR_per_million_log10, method="pearson", use="complete.obs")

	Pearson's product-moment correlation

data:  C451_females_AAMR_2010_2014_asbestos_avg1975$PC_asbestos_kg and C451_females_AAMR_2010_2014_asbestos_avg1975$AAMR_per_million_log10
t = 2.1117, df = 44, p-value = 0.04042
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.01431503 0.54560325
sample estimates:
      cor 
0.3033525 

> 
> model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C451_females_AAMR_2010_2014_asbestos_avg1975, weights=female_population)
> model_lm

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C451_females_AAMR_2010_2014_asbestos_avg1975, 
    weights = female_population)

Coefficients:
   (Intercept)  PC_asbestos_kg  
      -0.96141         0.09884  

> summary(model_lm)

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C451_females_AAMR_2010_2014_asbestos_avg1975, 
    weights = female_population)

Weighted Residuals:
    Min      1Q  Median      3Q     Max 
-2366.5  -222.3   320.3   596.1  1442.1 

Coefficients:
               Estimate Std. Error t value             Pr(>|t|)    
(Intercept)    -0.96141    0.06622 -14.518 < 0.0000000000000002 ***
PC_asbestos_kg  0.09884    0.02675   3.695             0.000605 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 771.3 on 44 degrees of freedom
Multiple R-squared:  0.2368,	Adjusted R-squared:  0.2195 
F-statistic: 13.65 on 1 and 44 DF,  p-value: 0.0006049

> confint(model_lm, '(Intercept)', level=0.95)
                2.5 %     97.5 %
(Intercept) -1.094871 -0.8279443
> confint(model_lm, 'PC_asbestos_kg', level=0.95)
                    2.5 %    97.5 %
PC_asbestos_kg 0.04493235 0.1527477
> se = sqrt(diag(vcov(model_lm)))
> se
   (Intercept) PC_asbestos_kg 
    0.06622294     0.02674832 
> AIC(model_lm)
[1] 27.85942
> BIC(model_lm)
[1] 33.34535
> shapiro.test(residuals(model_lm))

	Shapiro-Wilk normality test

data:  residuals(model_lm)
W = 0.97658, p-value = 0.4735
###

jpeg(paste("Results/", data_name, "_model_lm_hist_residuals.jpg", sep=""), width=600, height=600)
hist(residuals(model_lm), main=paste("residuals for model_lm_", data_name, sep=""))
dev.off()
jpeg(paste("Results/", data_name, "_model_lm_qqplot_residuals.jpg", sep=""), width=600, height=600)
qqnorm( residuals(model_lm), pch=1, frame=FALSE, main=paste("Q-Q plot(model_lm_", data_name, ")", sep="") )
qqline( residuals(model_lm), col="steelblue", lwd=2 )
dev.off()

model_lm_C451_females_AAMR_2010_2014_asbestos_avg1975 = model_lm
model_name = "model_lm_C451_females_AAMR_2010_2014_asbestos_avg1975"
model_disease = "peritoneal mesothelioma"
model_gender = "females"
years_of_deaths = "2010-2014"
years_of_asbestos = "1975"
countries_included = "all excluding Slovenia"

num_points = nrow(mortasb)
y_intercept = model_lm$coefficients[[1]]
slope = model_lm$coefficients[[2]]
BO_CI1 = confint(model_lm, '(Intercept)', level=0.95)[[1]]
BO_CI2 = confint(model_lm, '(Intercept)', level=0.95)[[2]]
B0_SE = sqrt(diag(vcov(model_lm)))[[1]]
B0_p_value = summary(model_lm)$coefficients[7]
B1_CI1 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[1]]
B1_CI2 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[2]]
B1_SE = sqrt(diag(vcov(model_lm)))[[2]]
B1_p_value = summary(model_lm)$coefficients[8]
R_squared = summary(model_lm)$r.squared
adjusted_R_squared = summary(model_lm)$adj.r.squared
fstat = summary(model_lm)$fstatistic
if (is.null(fstat)) {
  p_value = 1
} else {
  p_value = pf(fstat[1], fstat[2], fstat[3], lower.tail=F)
}

outline = paste(model_disease, model_gender, years_of_deaths, years_of_asbestos, num_points, countries_included, y_intercept, BO_CI1, BO_CI2, B0_SE, B0_p_value, slope, B1_CI1, B1_CI2, B1_SE, B1_p_value, adjusted_R_squared, p_value, sep="\t")
write(outline, file=outfile_stats, append=TRUE)



##########
##### Analysis for females peritoneal mesothelioma C451 deaths 2010-2014 vs average asbestos 1975 (avg 1970,1975,1980), without Slovenia, using only countries in 2007 paper

mort_asb5 = C451_females_AAMR_2010_2014_asbestos_avg1975

mort_asb6 = mort_asb5[(mort_asb5$Country_3char %in% paper2007_countries_for_C451_females),]

mortasb = mort_asb6

# nudge the country text on the plot
min_population = min(mortasb$population)
max_population = max(mortasb$population)
nudge_x_slope_m = (0.10 - 0.6) / (max_population - min_population)
nudge_x_intercept_b = 0.6 - nudge_x_slope_m * min_population
mortasb$nudge_x = 1 * (mortasb$population * nudge_x_slope_m + nudge_x_intercept_b)
mortasb$nudge_y = 0

#mortasb$nudge_x = ifelse( (mortasb$Country_3char=="NLD"), 0.2, mortasb$nudge_x )
#mortasb$nudge_y = ifelse( (mortasb$Country_3char=="TUN"), 0.01, mortasb$nudge_y )
#mortasb[,c("Country_Name", "Country_3char", "population", "AAMR_per_million", "nudge_x", "nudge_y")]

data_for_plot = mortasb
data_for_plot$nudge_x = NULL
data_for_plot$nudge_y = NULL

C451_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries = data_for_plot
data_name = "C451_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries"
plot_title = gsub( "_", " ", data_name )

file_name = paste("Results/", data_name, ".txt", sep="" )
plot_name = paste("Results/", data_name, ".png", sep="" )

ggplot(mortasb, aes(x=PC_asbestos_kg, y=AAMR_per_million, size=population)) + geom_point(colour="#4E8D24", shape=21) + 
  theme(axis.text.x=element_text(angle=0, vjust=0.5, hjust=1)) + scale_y_log10() + theme_bw() +
  theme(panel.border=element_blank(), panel.grid.major = element_blank(), panel.grid.minor=element_blank(), axis.line=element_line(colour="black")) +
  geom_text(label=mortasb$Country_3char, nudge_x=mortasb$nudge_x, nudge_y=mortasb$nudge_y, check_overlap=FALSE, size=3) +
  ggtitle(plot_title) + labs(x="1975 asbestos consumption (kg per head per year)", y="Deaths per million people per year 2010-2014")
ggsave(plot_name, width=8, height=5)

write.table( data_for_plot, file=file_name, quote=FALSE, sep="\t", row.names=FALSE, col.names=TRUE )

nrow(C451_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries)

cor.test( C451_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries$PC_asbestos_kg, C451_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries$AAMR_per_million_log10, method="pearson", use="complete.obs")

model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C451_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries, weights=female_population)
model_lm
summary(model_lm)
confint(model_lm, '(Intercept)', level=0.95)
confint(model_lm, 'PC_asbestos_kg', level=0.95)
se = sqrt(diag(vcov(model_lm)))
se
AIC(model_lm)
BIC(model_lm)
shapiro.test(residuals(model_lm))

###
> nrow(C451_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries)
[1] 23
> 
> cor.test( C451_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries$PC_asbestos_kg, C451_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries$AAMR_per_million_log10, method="pearson", use="complete.obs")

	Pearson's product-moment correlation

data:  C451_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries$PC_asbestos_kg and C451_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries$AAMR_per_million_log10
t = 1.3496, df = 21, p-value = 0.1915
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 -0.1467772  0.6222556
sample estimates:
      cor 
0.2825179 

> 
> model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=C451_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries, weights=female_population)
> model_lm

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C451_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries, 
    weights = female_population)

Coefficients:
   (Intercept)  PC_asbestos_kg  
       -1.1018          0.1339  

> summary(model_lm)

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = C451_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries, 
    weights = female_population)

Weighted Residuals:
    Min      1Q  Median      3Q     Max 
-1791.8  -282.1   295.2   666.5   933.2 

Coefficients:
               Estimate Std. Error t value         Pr(>|t|)    
(Intercept)    -1.10180    0.08189 -13.455 0.00000000000858 ***
PC_asbestos_kg  0.13387    0.03139   4.265         0.000345 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 736.2 on 21 degrees of freedom
Multiple R-squared:  0.4642,	Adjusted R-squared:  0.4387 
F-statistic: 18.19 on 1 and 21 DF,  p-value: 0.0003446

> confint(model_lm, '(Intercept)', level=0.95)
                2.5 %     97.5 %
(Intercept) -1.272094 -0.9315141
> confint(model_lm, 'PC_asbestos_kg', level=0.95)
                    2.5 %    97.5 %
PC_asbestos_kg 0.06859706 0.1991406
> se = sqrt(diag(vcov(model_lm)))
> se
   (Intercept) PC_asbestos_kg 
    0.08188525     0.03138648 
> AIC(model_lm)
[1] 2.339514
> BIC(model_lm)
[1] 5.745997
> shapiro.test(residuals(model_lm))

	Shapiro-Wilk normality test

data:  residuals(model_lm)
W = 0.95864, p-value = 0.4365
###

jpeg(paste("Results/", data_name, "_model_lm_hist_residuals.jpg", sep=""), width=600, height=600)
hist(residuals(model_lm), main=paste("residuals for model_lm_", data_name, sep=""))
dev.off()
jpeg(paste("Results/", data_name, "_model_lm_qqplot_residuals.jpg", sep=""), width=600, height=600)
qqnorm( residuals(model_lm), pch=1, frame=FALSE, main=paste("Q-Q plot(model_lm_", data_name, ")", sep="") )
qqline( residuals(model_lm), col="steelblue", lwd=2 )
dev.off()

model_lm_C451_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries = model_lm
model_name = "model_lm_C451_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries"
model_disease = "peritoneal mesothelioma"
model_gender = "females"
years_of_deaths = "2010-2014"
years_of_asbestos = "1975"
countries_included = "paper 2007 countries"

num_points = nrow(mortasb)
y_intercept = model_lm$coefficients[[1]]
slope = model_lm$coefficients[[2]]
BO_CI1 = confint(model_lm, '(Intercept)', level=0.95)[[1]]
BO_CI2 = confint(model_lm, '(Intercept)', level=0.95)[[2]]
B0_SE = sqrt(diag(vcov(model_lm)))[[1]]
B0_p_value = summary(model_lm)$coefficients[7]
B1_CI1 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[1]]
B1_CI2 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[2]]
B1_SE = sqrt(diag(vcov(model_lm)))[[2]]
B1_p_value = summary(model_lm)$coefficients[8]
R_squared = summary(model_lm)$r.squared
adjusted_R_squared = summary(model_lm)$adj.r.squared
fstat = summary(model_lm)$fstatistic
if (is.null(fstat)) {
  p_value = 1
} else {
  p_value = pf(fstat[1], fstat[2], fstat[3], lower.tail=F)
}

outline = paste(model_disease, model_gender, years_of_deaths, years_of_asbestos, num_points, countries_included, y_intercept, BO_CI1, BO_CI2, B0_SE, B0_p_value, slope, B1_CI1, B1_CI2, B1_SE, B1_p_value, adjusted_R_squared, p_value, sep="\t")
write(outline, file=outfile_stats, append=TRUE)



##########
##### Analysis for males asbestosis J61 deaths 2010-2014 vs average asbestos 1975 (avg 1970,1975,1980), without Slovenia

mort1 = mort_2010_to_2014_C45_J61[((mort_2010_to_2014_C45_J61$Cause=="J61") & (mort_2010_to_2014_C45_J61$Sex==1) & (mort_2010_to_2014_C45_J61$deaths>0)),]
pop1 = pop_males_by_age_with_extra_countries

unique(mort1$Country_Name[(!(mort1$Country_Name %in% pop1$Country_Name))])

mort2 = merge( x=mort1, y=pop1, by=c("Country_Name", "Year", "age_group"), x.all=TRUE, y.all=FALSE )

mort2b = sqldf("select Country_Name, Country_3char, Year, age_group, sum(deaths), max(population) from mort2 where population > 0 group by Country_Name, Country_3char, Year, age_group")
colnames(mort2b) = c("Country_Name", "Country_3char", "Year", "age_group", "deaths", "population")
mort2b$death_rate_per_million = mort2b$deaths * 1000000 / mort2b$population

mort3 = merge( x=mort2b, y=std_pop, by=c("age_group"), x.all=TRUE, y.all=FALSE )
mort3$adjusted_death_rate_per_million = mort3$death_rate_per_million * mort3$WHO_World_Standard_rate

mort4 = sqldf('select Country_Name, Country_3char, Year, sum(adjusted_death_rate_per_million) from mort3 group by Country_Name, Country_3char, Year')
names(mort4)[names(mort4)=="sum(adjusted_death_rate_per_million)"] = "AAMR_per_million"

mort6 = sqldf('select Country_Name, Country_3char, avg(AAMR_per_million) from mort4 group by Country_Name, Country_3char')
names(mort6)[names(mort6)=="avg(AAMR_per_million)"] = "AAMR_per_million"

mort6$Country_Name[(!(mort6$Country_Name %in% PC_asbestos_1975avg$Country_Name))]
PC_asbestos_1975avg$Country_Name[(!(PC_asbestos_1975avg$Country_Name %in% mort6$Country_Name))]

mort_asb1 = merge( x=mort6, y=PC_asbestos_1975avg, by=c("Country_Name"), all.x=FALSE, all.y=FALSE )
mort_asb1$Production = NULL
mort_asb1$Imports = NULL
mort_asb1$Exports = NULL
mort_asb1$Apparent_consumption = NULL
mort_asb1$Year = NULL
mort_asb1$AAMR_per_million_log10 = log10(mort_asb1$AAMR_per_million)

pop2 = pop_males[(pop_males$Year==1975),]

mort_asb3 = merge( x=mort_asb1, y=pop2, by=c("Country_Name"), all.x=TRUE, all.y=FALSE )

# Slovenia is an outlier. Its data was derived by making an assumption that 1975 proportional consumption within Yugoslavia is the same as in 1995. Thus remove this outlier.
mort_asb4 = mort_asb3[(mort_asb3$Country_Name!="Slovenia"),]

mortasb = mort_asb4

# nudge the country text on the plot
min_population = min(mortasb$population)
max_population = max(mortasb$population)
nudge_x_slope_m = (0.10 - 0.6) / (max_population - min_population)
nudge_x_intercept_b = 0.6 - nudge_x_slope_m * min_population
mortasb$nudge_x = 1 * (mortasb$population * nudge_x_slope_m + nudge_x_intercept_b)
mortasb$nudge_y = 0

#mortasb$nudge_x = ifelse( (mortasb$Country_3char=="NLD"), 0.2, mortasb$nudge_x )
#mortasb$nudge_y = ifelse( (mortasb$Country_3char=="TUN"), 0.01, mortasb$nudge_y )
#mortasb[,c("Country_Name", "Country_3char", "population", "AAMR_per_million", "nudge_x", "nudge_y")]

data_for_plot = mortasb
data_for_plot$nudge_x = NULL
data_for_plot$nudge_y = NULL

J61_males_AAMR_2010_2014_asbestos_avg1975 = data_for_plot
data_name = "J61_males_AAMR_2010_2014_asbestos_avg1975"
plot_title = gsub( "_", " ", data_name )

file_name = paste("Results/", data_name, ".txt", sep="" )
plot_name = paste("Results/", data_name, ".png", sep="" )

ggplot(mortasb, aes(x=PC_asbestos_kg, y=AAMR_per_million, size=population)) + geom_point(colour="#4E8D24", shape=21) + 
  theme(axis.text.x=element_text(angle=0, vjust=0.5, hjust=1)) + scale_y_log10() + theme_bw() +
  theme(panel.border=element_blank(), panel.grid.major = element_blank(), panel.grid.minor=element_blank(), axis.line=element_line(colour="black")) +
  geom_text(label=mortasb$Country_3char, nudge_x=mortasb$nudge_x, nudge_y=mortasb$nudge_y, check_overlap=FALSE, size=3) +
  ggtitle(plot_title) + labs(x="1975 asbestos consumption (kg per head per year)", y="Deaths per million people per year 2010-2014")
ggsave(plot_name, width=8, height=5)

write.table( data_for_plot, file=file_name, quote=FALSE, sep="\t", row.names=FALSE, col.names=TRUE )

nrow(J61_males_AAMR_2010_2014_asbestos_avg1975)

cor.test( J61_males_AAMR_2010_2014_asbestos_avg1975$PC_asbestos_kg, J61_males_AAMR_2010_2014_asbestos_avg1975$AAMR_per_million_log10, method="pearson", use="complete.obs")

model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=J61_males_AAMR_2010_2014_asbestos_avg1975, weights=male_population)
model_lm
summary(model_lm)
confint(model_lm, '(Intercept)', level=0.95)
confint(model_lm, 'PC_asbestos_kg', level=0.95)
se = sqrt(diag(vcov(model_lm)))
se
AIC(model_lm)
BIC(model_lm)
shapiro.test(residuals(model_lm))

###
> nrow(J61_males_AAMR_2010_2014_asbestos_avg1975)
[1] 50
> 
> cor.test( J61_males_AAMR_2010_2014_asbestos_avg1975$PC_asbestos_kg, J61_males_AAMR_2010_2014_asbestos_avg1975$AAMR_per_million_log10, method="pearson", use="complete.obs")

	Pearson's product-moment correlation

data:  J61_males_AAMR_2010_2014_asbestos_avg1975$PC_asbestos_kg and J61_males_AAMR_2010_2014_asbestos_avg1975$AAMR_per_million_log10
t = 3.9793, df = 48, p-value = 0.0002327
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.2550725 0.6818756
sample estimates:
      cor 
0.4980586 

> 
> model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=J61_males_AAMR_2010_2014_asbestos_avg1975, weights=male_population)
> model_lm

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = J61_males_AAMR_2010_2014_asbestos_avg1975, 
    weights = male_population)

Coefficients:
   (Intercept)  PC_asbestos_kg  
       -1.0237          0.2949  

> summary(model_lm)

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = J61_males_AAMR_2010_2014_asbestos_avg1975, 
    weights = male_population)

Weighted Residuals:
    Min      1Q  Median      3Q     Max 
-2472.5 -1104.3   -86.0   598.4  4594.5 

Coefficients:
               Estimate Std. Error t value         Pr(>|t|)    
(Intercept)    -1.02369    0.11221  -9.123 0.00000000000468 ***
PC_asbestos_kg  0.29491    0.04674   6.309 0.00000008435829 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 1517 on 48 degrees of freedom
Multiple R-squared:  0.4533,	Adjusted R-squared:  0.442 
F-statistic: 39.81 on 1 and 48 DF,  p-value: 0.00000008436

> confint(model_lm, '(Intercept)', level=0.95)
                2.5 %     97.5 %
(Intercept) -1.249309 -0.7980693
> confint(model_lm, 'PC_asbestos_kg', level=0.95)
                   2.5 %    97.5 %
PC_asbestos_kg 0.2009251 0.3888888
> se = sqrt(diag(vcov(model_lm)))
> se
   (Intercept) PC_asbestos_kg 
    0.11221313     0.04674238 
> AIC(model_lm)
[1] 97.8445
> BIC(model_lm)
[1] 103.5806
> shapiro.test(residuals(model_lm))

	Shapiro-Wilk normality test

data:  residuals(model_lm)
W = 0.96744, p-value = 0.1818
##

jpeg(paste("Results/", data_name, "_model_lm_hist_residuals.jpg", sep=""), width=600, height=600)
hist(residuals(model_lm), main=paste("residuals for model_lm_", data_name, sep=""))
dev.off()
jpeg(paste("Results/", data_name, "_model_lm_qqplot_residuals.jpg", sep=""), width=600, height=600)
qqnorm( residuals(model_lm), pch=1, frame=FALSE, main=paste("Q-Q plot(model_lm_", data_name, ")", sep="") )
qqline( residuals(model_lm), col="steelblue", lwd=2 )
dev.off()

model_lm_J61_males_AAMR_2010_2014_asbestos_avg1975 = model_lm
model_name = "model_lm_J61_males_AAMR_2010_2014_asbestos_avg1975"
model_disease = "asbestosis"
model_gender = "males"
years_of_deaths = "2010-2014"
years_of_asbestos = "1975"
countries_included = "all excluding Slovenia"

num_points = nrow(mortasb)
y_intercept = model_lm$coefficients[[1]]
slope = model_lm$coefficients[[2]]
BO_CI1 = confint(model_lm, '(Intercept)', level=0.95)[[1]]
BO_CI2 = confint(model_lm, '(Intercept)', level=0.95)[[2]]
B0_SE = sqrt(diag(vcov(model_lm)))[[1]]
B0_p_value = summary(model_lm)$coefficients[7]
B1_CI1 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[1]]
B1_CI2 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[2]]
B1_SE = sqrt(diag(vcov(model_lm)))[[2]]
B1_p_value = summary(model_lm)$coefficients[8]
R_squared = summary(model_lm)$r.squared
adjusted_R_squared = summary(model_lm)$adj.r.squared
fstat = summary(model_lm)$fstatistic
if (is.null(fstat)) {
  p_value = 1
} else {
  p_value = pf(fstat[1], fstat[2], fstat[3], lower.tail=F)
}

outline = paste(model_disease, model_gender, years_of_deaths, years_of_asbestos, num_points, countries_included, y_intercept, BO_CI1, BO_CI2, B0_SE, B0_p_value, slope, B1_CI1, B1_CI2, B1_SE, B1_p_value, adjusted_R_squared, p_value, sep="\t")
write(outline, file=outfile_stats, append=TRUE)



##########
##### Analysis for males asbestosis J61 deaths 2010-2014 vs average asbestos 1975 (avg 1970,1975,1980), without Slovenia, using only countries in 2007 paper

mort_asb5 = J61_males_AAMR_2010_2014_asbestos_avg1975

mort_asb6 = mort_asb5[(mort_asb5$Country_3char %in% paper2007_countries_for_J61_males),]

mortasb = mort_asb6

# nudge the country text on the plot
min_population = min(mortasb$population)
max_population = max(mortasb$population)
nudge_x_slope_m = (0.10 - 0.6) / (max_population - min_population)
nudge_x_intercept_b = 0.6 - nudge_x_slope_m * min_population
mortasb$nudge_x = 1 * (mortasb$population * nudge_x_slope_m + nudge_x_intercept_b)
mortasb$nudge_y = 0

#mortasb$nudge_x = ifelse( (mortasb$Country_3char=="NLD"), 0.2, mortasb$nudge_x )
#mortasb$nudge_y = ifelse( (mortasb$Country_3char=="TUN"), 0.01, mortasb$nudge_y )
#mortasb[,c("Country_Name", "Country_3char", "population", "AAMR_per_million", "nudge_x", "nudge_y")]

data_for_plot = mortasb
data_for_plot$nudge_x = NULL
data_for_plot$nudge_y = NULL

J61_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries = data_for_plot
data_name = "J61_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries"
plot_title = gsub( "_", " ", data_name )

file_name = paste("Results/", data_name, ".txt", sep="" )
plot_name = paste("Results/", data_name, ".png", sep="" )

ggplot(mortasb, aes(x=PC_asbestos_kg, y=AAMR_per_million, size=population)) + geom_point(colour="#4E8D24", shape=21) + 
  theme(axis.text.x=element_text(angle=0, vjust=0.5, hjust=1)) + scale_y_log10() + theme_bw() +
  theme(panel.border=element_blank(), panel.grid.major = element_blank(), panel.grid.minor=element_blank(), axis.line=element_line(colour="black")) +
  geom_text(label=mortasb$Country_3char, nudge_x=mortasb$nudge_x, nudge_y=mortasb$nudge_y, check_overlap=FALSE, size=3) +
  ggtitle(plot_title) + labs(x="1975 asbestos consumption (kg per head per year)", y="Deaths per million people per year 2010-2014")
ggsave(plot_name, width=8, height=5)

write.table( data_for_plot, file=file_name, quote=FALSE, sep="\t", row.names=FALSE, col.names=TRUE )

nrow(J61_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries)

cor.test( J61_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries$PC_asbestos_kg, J61_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries$AAMR_per_million_log10, method="pearson", use="complete.obs")

model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=J61_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries, weights=male_population)
model_lm
summary(model_lm)
confint(model_lm, '(Intercept)', level=0.95)
confint(model_lm, 'PC_asbestos_kg', level=0.95)
se = sqrt(diag(vcov(model_lm)))
se
AIC(model_lm)
BIC(model_lm)
shapiro.test(residuals(model_lm))

###
> nrow(J61_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries)
[1] 27
> 
> cor.test( J61_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries$PC_asbestos_kg, J61_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries$AAMR_per_million_log10, method="pearson", use="complete.obs")

	Pearson's product-moment correlation

data:  J61_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries$PC_asbestos_kg and J61_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries$AAMR_per_million_log10
t = 3.6176, df = 25, p-value = 0.001313
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.2652596 0.7901796
sample estimates:
      cor 
0.5861848 

> 
> model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=J61_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries, weights=male_population)
> model_lm

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = J61_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries, 
    weights = male_population)

Coefficients:
   (Intercept)  PC_asbestos_kg  
       -1.0870          0.3315  

> summary(model_lm)

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = J61_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries, 
    weights = male_population)

Weighted Residuals:
    Min      1Q  Median      3Q     Max 
-2568.4 -1555.4    23.5   699.6  4080.7 

Coefficients:
               Estimate Std. Error t value    Pr(>|t|)    
(Intercept)    -1.08698    0.16839  -6.455 0.000000926 ***
PC_asbestos_kg  0.33149    0.06739   4.919 0.000046010 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 1706 on 25 degrees of freedom
Multiple R-squared:  0.4918,	Adjusted R-squared:  0.4715 
F-statistic: 24.19 on 1 and 25 DF,  p-value: 0.00004601

> confint(model_lm, '(Intercept)', level=0.95)
                2.5 %    97.5 %
(Intercept) -1.433794 -0.740171
> confint(model_lm, 'PC_asbestos_kg', level=0.95)
                   2.5 %    97.5 %
PC_asbestos_kg 0.1926852 0.4702865
> se = sqrt(diag(vcov(model_lm)))
> se
   (Intercept) PC_asbestos_kg 
    0.16839285     0.06739405 
> AIC(model_lm)
[1] 49.3113
> BIC(model_lm)
[1] 53.19881
> shapiro.test(residuals(model_lm))

	Shapiro-Wilk normality test

data:  residuals(model_lm)
W = 0.97707, p-value = 0.791
###

jpeg(paste("Results/", data_name, "_model_lm_hist_residuals.jpg", sep=""), width=600, height=600)
hist(residuals(model_lm), main=paste("residuals for model_lm_", data_name, sep=""))
dev.off()
jpeg(paste("Results/", data_name, "_model_lm_qqplot_residuals.jpg", sep=""), width=600, height=600)
qqnorm( residuals(model_lm), pch=1, frame=FALSE, main=paste("Q-Q plot(model_lm_", data_name, ")", sep="") )
qqline( residuals(model_lm), col="steelblue", lwd=2 )
dev.off()

model_lm_J61_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries = model_lm
model_name = "model_lm_J61_males_AAMR_2010_2014_asbestos_avg1975_paper2007countries"
model_disease = "asbestosis"
model_gender = "males"
years_of_deaths = "2010-2014"
years_of_asbestos = "1975"
countries_included = "paper 2007 countries"

num_points = nrow(mortasb)
y_intercept = model_lm$coefficients[[1]]
slope = model_lm$coefficients[[2]]
BO_CI1 = confint(model_lm, '(Intercept)', level=0.95)[[1]]
BO_CI2 = confint(model_lm, '(Intercept)', level=0.95)[[2]]
B0_SE = sqrt(diag(vcov(model_lm)))[[1]]
B0_p_value = summary(model_lm)$coefficients[7]
B1_CI1 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[1]]
B1_CI2 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[2]]
B1_SE = sqrt(diag(vcov(model_lm)))[[2]]
B1_p_value = summary(model_lm)$coefficients[8]
R_squared = summary(model_lm)$r.squared
adjusted_R_squared = summary(model_lm)$adj.r.squared
fstat = summary(model_lm)$fstatistic
if (is.null(fstat)) {
  p_value = 1
} else {
  p_value = pf(fstat[1], fstat[2], fstat[3], lower.tail=F)
}

outline = paste(model_disease, model_gender, years_of_deaths, years_of_asbestos, num_points, countries_included, y_intercept, BO_CI1, BO_CI2, B0_SE, B0_p_value, slope, B1_CI1, B1_CI2, B1_SE, B1_p_value, adjusted_R_squared, p_value, sep="\t")
write(outline, file=outfile_stats, append=TRUE)



##########
##### Analysis for females asbestosis J61 deaths 2010-2014 vs average asbestos 1975 (avg 1970,1975,1980), without Slovenia

mort1 = mort_2010_to_2014_C45_J61[((mort_2010_to_2014_C45_J61$Cause=="J61") & (mort_2010_to_2014_C45_J61$Sex==2) & (mort_2010_to_2014_C45_J61$deaths>0)),]
pop1 = pop_females_by_age_with_extra_countries

unique(mort1$Country_Name[(!(mort1$Country_Name %in% pop1$Country_Name))])

mort2 = merge( x=mort1, y=pop1, by=c("Country_Name", "Year", "age_group"), x.all=TRUE, y.all=FALSE )

mort2b = sqldf("select Country_Name, Country_3char, Year, age_group, sum(deaths), max(population) from mort2 where population > 0 group by Country_Name, Country_3char, Year, age_group")
colnames(mort2b) = c("Country_Name", "Country_3char", "Year", "age_group", "deaths", "population")
mort2b$death_rate_per_million = mort2b$deaths * 1000000 / mort2b$population

mort3 = merge( x=mort2b, y=std_pop, by=c("age_group"), x.all=TRUE, y.all=FALSE )
mort3$adjusted_death_rate_per_million = mort3$death_rate_per_million * mort3$WHO_World_Standard_rate

mort4 = sqldf('select Country_Name, Country_3char, Year, sum(adjusted_death_rate_per_million) from mort3 group by Country_Name, Country_3char, Year')
names(mort4)[names(mort4)=="sum(adjusted_death_rate_per_million)"] = "AAMR_per_million"

mort6 = sqldf('select Country_Name, Country_3char, avg(AAMR_per_million) from mort4 group by Country_Name, Country_3char')
names(mort6)[names(mort6)=="avg(AAMR_per_million)"] = "AAMR_per_million"

mort6$Country_Name[(!(mort6$Country_Name %in% PC_asbestos_1975avg$Country_Name))]
PC_asbestos_1975avg$Country_Name[(!(PC_asbestos_1975avg$Country_Name %in% mort6$Country_Name))]

mort_asb1 = merge( x=mort6, y=PC_asbestos_1975avg, by=c("Country_Name"), all.x=FALSE, all.y=FALSE )
mort_asb1$Production = NULL
mort_asb1$Imports = NULL
mort_asb1$Exports = NULL
mort_asb1$Apparent_consumption = NULL
mort_asb1$Year = NULL
mort_asb1$AAMR_per_million_log10 = log10(mort_asb1$AAMR_per_million)

pop2 = pop_females[(pop_females$Year==1975),]

mort_asb3 = merge( x=mort_asb1, y=pop2, by=c("Country_Name"), all.x=TRUE, all.y=FALSE )

mort_asb4 = mort_asb3[(mort_asb3$Country_Name!="Slovenia"),]

mortasb = mort_asb4

# nudge the country text on the plot
min_population = min(mortasb$population)
max_population = max(mortasb$population)
nudge_x_slope_m = (0.10 - 0.6) / (max_population - min_population)
nudge_x_intercept_b = 0.6 - nudge_x_slope_m * min_population
mortasb$nudge_x = 1 * (mortasb$population * nudge_x_slope_m + nudge_x_intercept_b)
mortasb$nudge_y = 0

#mortasb$nudge_x = ifelse( (mortasb$Country_3char=="NLD"), 0.2, mortasb$nudge_x )
#mortasb$nudge_y = ifelse( (mortasb$Country_3char=="TUN"), 0.01, mortasb$nudge_y )
#mortasb[,c("Country_Name", "Country_3char", "population", "AAMR_per_million", "nudge_x", "nudge_y")]

data_for_plot = mortasb
data_for_plot$nudge_x = NULL
data_for_plot$nudge_y = NULL

J61_females_AAMR_2010_2014_asbestos_avg1975 = data_for_plot
data_name = "J61_females_AAMR_2010_2014_asbestos_avg1975"
plot_title = gsub( "_", " ", data_name )

file_name = paste("Results/", data_name, ".txt", sep="" )
plot_name = paste("Results/", data_name, ".png", sep="" )

ggplot(mortasb, aes(x=PC_asbestos_kg, y=AAMR_per_million, size=population)) + geom_point(colour="#4E8D24", shape=21) + 
  theme(axis.text.x=element_text(angle=0, vjust=0.5, hjust=1)) + scale_y_log10() + theme_bw() +
  theme(panel.border=element_blank(), panel.grid.major = element_blank(), panel.grid.minor=element_blank(), axis.line=element_line(colour="black")) +
  geom_text(label=mortasb$Country_3char, nudge_x=mortasb$nudge_x, nudge_y=mortasb$nudge_y, check_overlap=FALSE, size=3) +
  ggtitle(plot_title) + labs(x="1975 asbestos consumption (kg per head per year)", y="Deaths per million people per year 2010-2014")
ggsave(plot_name, width=8, height=5)

write.table( data_for_plot, file=file_name, quote=FALSE, sep="\t", row.names=FALSE, col.names=TRUE )

nrow(J61_females_AAMR_2010_2014_asbestos_avg1975)

cor.test( J61_females_AAMR_2010_2014_asbestos_avg1975$PC_asbestos_kg, J61_females_AAMR_2010_2014_asbestos_avg1975$AAMR_per_million_log10, method="pearson", use="complete.obs")

model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=J61_females_AAMR_2010_2014_asbestos_avg1975, weights=female_population)
model_lm
summary(model_lm)
confint(model_lm, '(Intercept)', level=0.95)
confint(model_lm, 'PC_asbestos_kg', level=0.95)
se = sqrt(diag(vcov(model_lm)))
se
AIC(model_lm)
BIC(model_lm)
shapiro.test(residuals(model_lm))

###
> nrow(J61_females_AAMR_2010_2014_asbestos_avg1975)
[1] 30
> 
> cor.test( J61_females_AAMR_2010_2014_asbestos_avg1975$PC_asbestos_kg, J61_females_AAMR_2010_2014_asbestos_avg1975$AAMR_per_million_log10, method="pearson", use="complete.obs")

	Pearson's product-moment correlation

data:  J61_females_AAMR_2010_2014_asbestos_avg1975$PC_asbestos_kg and J61_females_AAMR_2010_2014_asbestos_avg1975$AAMR_per_million_log10
t = 0.90934, df = 28, p-value = 0.3709
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 -0.2033082  0.4991771
sample estimates:
      cor 
0.1693664 

> 
> model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=J61_females_AAMR_2010_2014_asbestos_avg1975, weights=female_population)
> model_lm

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = J61_females_AAMR_2010_2014_asbestos_avg1975, 
    weights = female_population)

Coefficients:
   (Intercept)  PC_asbestos_kg  
      -1.47681         0.04085  

> summary(model_lm)

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = J61_females_AAMR_2010_2014_asbestos_avg1975, 
    weights = female_population)

Weighted Residuals:
    Min      1Q  Median      3Q     Max 
-2770.7  -165.7   442.9   986.5  3678.6 

Coefficients:
               Estimate Std. Error t value          Pr(>|t|)    
(Intercept)    -1.47681    0.11148 -13.248 0.000000000000139 ***
PC_asbestos_kg  0.04085    0.04388   0.931              0.36    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 1280 on 28 degrees of freedom
Multiple R-squared:  0.03001,	Adjusted R-squared:  -0.004629 
F-statistic: 0.8664 on 1 and 28 DF,  p-value: 0.3599

> confint(model_lm, '(Intercept)', level=0.95)
               2.5 %    97.5 %
(Intercept) -1.70516 -1.248465
> confint(model_lm, 'PC_asbestos_kg', level=0.95)
                     2.5 %    97.5 %
PC_asbestos_kg -0.04904394 0.1307344
> se = sqrt(diag(vcov(model_lm)))
> se
   (Intercept) PC_asbestos_kg 
    0.11147558     0.04388248 
> AIC(model_lm)
[1] 33.03519
> BIC(model_lm)
[1] 37.23878
> shapiro.test(residuals(model_lm))

	Shapiro-Wilk normality test

data:  residuals(model_lm)
W = 0.95028, p-value = 0.172
###

jpeg(paste("Results/", data_name, "_model_lm_hist_residuals.jpg", sep=""), width=600, height=600)
hist(residuals(model_lm), main=paste("residuals for model_lm_", data_name, sep=""))
dev.off()
jpeg(paste("Results/", data_name, "_model_lm_qqplot_residuals.jpg", sep=""), width=600, height=600)
qqnorm( residuals(model_lm), pch=1, frame=FALSE, main=paste("Q-Q plot(model_lm_", data_name, ")", sep="") )
qqline( residuals(model_lm), col="steelblue", lwd=2 )
dev.off()

model_lm_J61_females_AAMR_2010_2014_asbestos_avg1975 = model_lm
model_name = "model_lm_J61_females_AAMR_2010_2014_asbestos_avg1975"
model_disease = "asbestosis"
model_gender = "females"
years_of_deaths = "2010-2014"
years_of_asbestos = "1975"
countries_included = "all excluding Slovenia"

num_points = nrow(mortasb)
y_intercept = model_lm$coefficients[[1]]
slope = model_lm$coefficients[[2]]
BO_CI1 = confint(model_lm, '(Intercept)', level=0.95)[[1]]
BO_CI2 = confint(model_lm, '(Intercept)', level=0.95)[[2]]
B0_SE = sqrt(diag(vcov(model_lm)))[[1]]
B0_p_value = summary(model_lm)$coefficients[7]
B1_CI1 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[1]]
B1_CI2 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[2]]
B1_SE = sqrt(diag(vcov(model_lm)))[[2]]
B1_p_value = summary(model_lm)$coefficients[8]
R_squared = summary(model_lm)$r.squared
adjusted_R_squared = summary(model_lm)$adj.r.squared
fstat = summary(model_lm)$fstatistic
if (is.null(fstat)) {
  p_value = 1
} else {
  p_value = pf(fstat[1], fstat[2], fstat[3], lower.tail=F)
}

outline = paste(model_disease, model_gender, years_of_deaths, years_of_asbestos, num_points, countries_included, y_intercept, BO_CI1, BO_CI2, B0_SE, B0_p_value, slope, B1_CI1, B1_CI2, B1_SE, B1_p_value, adjusted_R_squared, p_value, sep="\t")
write(outline, file=outfile_stats, append=TRUE)



##########
##### Analysis for females asbestosis J61 deaths 2010-2014 vs average asbestos 1975 (avg 1970,1975,1980), without Slovenia, using only countries in 2007 paper

mort_asb5 = J61_females_AAMR_2010_2014_asbestos_avg1975

mort_asb6 = mort_asb5[(mort_asb5$Country_3char %in% paper2007_countries_for_J61_females),]

mortasb = mort_asb6

# nudge the country text on the plot
min_population = min(mortasb$population)
max_population = max(mortasb$population)
nudge_x_slope_m = (0.10 - 0.6) / (max_population - min_population)
nudge_x_intercept_b = 0.6 - nudge_x_slope_m * min_population
mortasb$nudge_x = 1 * (mortasb$population * nudge_x_slope_m + nudge_x_intercept_b)
mortasb$nudge_y = 0

#mortasb$nudge_x = ifelse( (mortasb$Country_3char=="NLD"), 0.2, mortasb$nudge_x )
#mortasb$nudge_y = ifelse( (mortasb$Country_3char=="TUN"), 0.01, mortasb$nudge_y )
#mortasb[,c("Country_Name", "Country_3char", "population", "AAMR_per_million", "nudge_x", "nudge_y")]

data_for_plot = mortasb
data_for_plot$nudge_x = NULL
data_for_plot$nudge_y = NULL

J61_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries = data_for_plot
data_name = "J61_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries"
plot_title = gsub( "_", " ", data_name )

file_name = paste("Results/", data_name, ".txt", sep="" )
plot_name = paste("Results/", data_name, ".png", sep="" )

ggplot(mortasb, aes(x=PC_asbestos_kg, y=AAMR_per_million, size=population)) + geom_point(colour="#4E8D24", shape=21) + 
  theme(axis.text.x=element_text(angle=0, vjust=0.5, hjust=1)) + scale_y_log10() + theme_bw() +
  theme(panel.border=element_blank(), panel.grid.major = element_blank(), panel.grid.minor=element_blank(), axis.line=element_line(colour="black")) +
  geom_text(label=mortasb$Country_3char, nudge_x=mortasb$nudge_x, nudge_y=mortasb$nudge_y, check_overlap=FALSE, size=3) +
  ggtitle(plot_title) + labs(x="1975 asbestos consumption (kg per head per year)", y="Deaths per million people per year 2010-2014")
ggsave(plot_name, width=8, height=5)

write.table( data_for_plot, file=file_name, quote=FALSE, sep="\t", row.names=FALSE, col.names=TRUE )

nrow(J61_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries)

cor.test( J61_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries$PC_asbestos_kg, J61_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries$AAMR_per_million_log10, method="pearson", use="complete.obs")

model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=J61_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries, weights=female_population)
model_lm
summary(model_lm)
confint(model_lm, '(Intercept)', level=0.95)
confint(model_lm, 'PC_asbestos_kg', level=0.95)
se = sqrt(diag(vcov(model_lm)))
se
AIC(model_lm)
BIC(model_lm)
shapiro.test(residuals(model_lm))

###
> nrow(J61_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries)
[1] 14
> 
> cor.test( J61_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries$PC_asbestos_kg, J61_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries$AAMR_per_million_log10, method="pearson", use="complete.obs")

	Pearson's product-moment correlation

data:  J61_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries$PC_asbestos_kg and J61_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries$AAMR_per_million_log10
t = 0.53103, df = 12, p-value = 0.6051
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 -0.4121920  0.6313476
sample estimates:
      cor 
0.1515264 

> 
> model_lm = lm(AAMR_per_million_log10 ~ PC_asbestos_kg, data=J61_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries, weights=female_population)
> model_lm

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = J61_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries, 
    weights = female_population)

Coefficients:
   (Intercept)  PC_asbestos_kg  
      -1.54082         0.04408  

> summary(model_lm)

Call:
lm(formula = AAMR_per_million_log10 ~ PC_asbestos_kg, data = J61_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries, 
    weights = female_population)

Weighted Residuals:
     Min       1Q   Median       3Q      Max 
-2358.12    21.72   464.63   924.99  2030.91 

Coefficients:
               Estimate Std. Error t value   Pr(>|t|)    
(Intercept)    -1.54082    0.14790 -10.418 0.00000023 ***
PC_asbestos_kg  0.04408    0.05474   0.805      0.436    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 1193 on 12 degrees of freedom
Multiple R-squared:  0.05126,	Adjusted R-squared:  -0.0278 
F-statistic: 0.6483 on 1 and 12 DF,  p-value: 0.4364

> confint(model_lm, '(Intercept)', level=0.95)
                2.5 %   97.5 %
(Intercept) -1.863073 -1.21856
> confint(model_lm, 'PC_asbestos_kg', level=0.95)
                     2.5 %    97.5 %
PC_asbestos_kg -0.07519208 0.1633448
> se = sqrt(diag(vcov(model_lm)))
> se
   (Intercept) PC_asbestos_kg 
    0.14790462     0.05474011 
> AIC(model_lm)
[1] 9.564353
> BIC(model_lm)
[1] 11.48152
> shapiro.test(residuals(model_lm))

	Shapiro-Wilk normality test

data:  residuals(model_lm)
W = 0.95804, p-value = 0.6907
###

jpeg(paste("Results/", data_name, "_model_lm_hist_residuals.jpg", sep=""), width=600, height=600)
hist(residuals(model_lm), main=paste("residuals for model_lm_", data_name, sep=""))
dev.off()
jpeg(paste("Results/", data_name, "_model_lm_qqplot_residuals.jpg", sep=""), width=600, height=600)
qqnorm( residuals(model_lm), pch=1, frame=FALSE, main=paste("Q-Q plot(model_lm_", data_name, ")", sep="") )
qqline( residuals(model_lm), col="steelblue", lwd=2 )
dev.off()

model_lm_J61_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries = model_lm
model_name = "model_lm_J61_females_AAMR_2010_2014_asbestos_avg1975_paper2007countries"
model_disease = "asbestosis"
model_gender = "females"
years_of_deaths = "2010-2014"
years_of_asbestos = "1975"
countries_included = "paper 2007 countries"

num_points = nrow(mortasb)
y_intercept = model_lm$coefficients[[1]]
slope = model_lm$coefficients[[2]]
BO_CI1 = confint(model_lm, '(Intercept)', level=0.95)[[1]]
BO_CI2 = confint(model_lm, '(Intercept)', level=0.95)[[2]]
B0_SE = sqrt(diag(vcov(model_lm)))[[1]]
B0_p_value = summary(model_lm)$coefficients[7]
B1_CI1 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[1]]
B1_CI2 = confint(model_lm, 'PC_asbestos_kg', level=0.95)[[2]]
B1_SE = sqrt(diag(vcov(model_lm)))[[2]]
B1_p_value = summary(model_lm)$coefficients[8]
R_squared = summary(model_lm)$r.squared
adjusted_R_squared = summary(model_lm)$adj.r.squared
fstat = summary(model_lm)$fstatistic
if (is.null(fstat)) {
  p_value = 1
} else {
  p_value = pf(fstat[1], fstat[2], fstat[3], lower.tail=F)
}

outline = paste(model_disease, model_gender, years_of_deaths, years_of_asbestos, num_points, countries_included, y_intercept, BO_CI1, BO_CI2, B0_SE, B0_p_value, slope, B1_CI1, B1_CI2, B1_SE, B1_p_value, adjusted_R_squared, p_value, sep="\t")
write(outline, file=outfile_stats, append=TRUE)



########## Adjust the order of the output stats file

stats1 = read.table( outfile_stats, sep="\t", header=TRUE, quote='"', comment.char="", row.names=NULL, stringsAsFactors=FALSE, colClasses=c("character") )

stats1$tmp_countries_included = 0
stats1$tmp_countries_included = ifelse( (stats1$countries_included=="all including Slovenia"), 1, stats1$tmp_countries_included )
stats1$tmp_countries_included = ifelse( (stats1$countries_included=="all excluding Slovenia"), 2, stats1$tmp_countries_included )
stats1$tmp_countries_included = ifelse( (stats1$countries_included=="paper 2007 countries"), 3, stats1$tmp_countries_included )
stats1$tmp_years_of_deaths = 0
stats1$tmp_years_of_deaths = ifelse( (stats1$years_of_deaths=="2010-2014"), 1, stats1$tmp_years_of_deaths )
stats1$tmp_years_of_deaths = ifelse( (stats1$years_of_deaths=="2000-2004"), 2, stats1$tmp_years_of_deaths )
stats1$tmp_years_of_asbestos = 0
stats1$tmp_years_of_asbestos = ifelse( (stats1$years_of_asbestos==1975), 1, stats1$tmp_years_of_asbestos )
stats1$tmp_years_of_asbestos = ifelse( (stats1$years_of_asbestos==1965), 2, stats1$tmp_years_of_asbestos )
stats1$tmp_model_gender = 0
stats1$tmp_model_gender = ifelse( (stats1$model_gender=="males and females"), 1, stats1$tmp_model_gender )
stats1$tmp_model_gender = ifelse( (stats1$model_gender=="males"), 2, stats1$tmp_model_gender )
stats1$tmp_model_gender = ifelse( (stats1$model_gender=="females"), 3, stats1$tmp_model_gender )
stats1$tmp_model_disease = 0
stats1$tmp_model_disease = ifelse( (stats1$model_disease=="all mesothelioma (with Slovenia)"), 1, stats1$tmp_model_disease )
stats1$tmp_model_disease = ifelse( (stats1$model_disease=="all mesothelioma"), 2, stats1$tmp_model_disease )
stats1$tmp_model_disease = ifelse( (stats1$model_disease=="pleural mesothelioma"), 3, stats1$tmp_model_disease )
stats1$tmp_model_disease = ifelse( (stats1$model_disease=="peritoneal mesothelioma"), 4, stats1$tmp_model_disease )
stats1$tmp_model_disease = ifelse( (stats1$model_disease=="asbestosis"), 5, stats1$tmp_model_disease )
stats1$tmp_years_of_deaths = ifelse( (stats1$years_of_deaths=="2010-2014"), 1, stats1$tmp_years_of_deaths )
stats1$tmp_field1 = 1
stats1$tmp_field1 = ifelse( (stats1$model_gender=="males and females"), 0, stats1$tmp_field1 )

stats1$tmp_for_sort = paste( stats1$tmp_field1, stats1$tmp_years_of_deaths, stats1$tmp_years_of_asbestos, stats1$tmp_countries_included, stats1$tmp_model_disease, stats1$tmp_model_gender, sep="_" )

stats2 = stats1[order(stats1$tmp_for_sort),]

stats2$tmp_field1 = NULL
stats2$tmp_countries_included = NULL
stats2$tmp_years_of_deaths = NULL
stats2$tmp_years_of_asbestos = NULL
stats2$tmp_model_gender = NULL
stats2$tmp_model_disease = NULL
stats2$tmp_for_sort = NULL

write.table( stats2, file=outfile_stats, quote=FALSE, sep="\t", row.names=FALSE, col.names=TRUE )


##########



